define(["map/layers"],function(e){colors=["e11d21","eb6420","fbca04","009800","006b75","207de5","0052cc","5319e7"];var t=-1,n=function(t){t===undefined&&(t="<div>"),this.$el=$(t),this.$el.addClass("layers_widget"),this.layers=new e.Layers,window.layers=this.layers,this.createControls()};return n.prototype.createControls=function(){var e=this;this.cur=0,this.$ul=$("<ul>"),this.$ul.sortable({placeholder:"ui-state-highlight",forcePlaceholderSize:!0,delay:300,axis:"y",stop:function(t,n){e.refresh()}}),this.$el.append(this.$ul);var t=$("<a>").text(gettext("New layer")).addClass("add_btn");return t.click(function(){e.createNewLayer()}),this.$el.append(t),this},n.prototype.refresh=function(e){return e=e||this.layers,e.forEach(function(e){if(e.getId()=="Others")return;e.$el.find("input[name=name]").val(e.getName());var t=e.getRule();t!==undefined&&t.operator==="has"&&t.property==="tags"&&t.value!==undefined&&e.$el.find("input[name=tags]").importTags(t.value.join(",")),e.$el.find(".fillcolor").colpickSetColor(e.getFillColor()),e.$el.find(".fillcolor").css("background",e.getFillColor()),e.$el.find(".strokecolor").colpickSetColor(e.getStrokeColor()),e.$el.find(".strokecolor").css("background",e.getStrokeColor()),e.setPosition(e.$el.index()),e.$el.find(".title").text(interpolate(gettext("Layer %s"),[e.getPosition()+1])),e.$el.find(".layer_name").text(e.getName())}),this},n.prototype.setRule=function(e,t){var n=undefined;t.length&&(n={operator:"has",property:"tags",value:t.split(",")}),e.setRule(n);var r=e.countFeatures();return e.$el.find(".layer_count").text(interpolate(ngettext("%s object","%s objects",r),[r])),this},n.prototype.addNewLayer=function(e,t){if(e.getId()=="Others")return;var n=this;return this.$ul.find(".content").slideUp().parent().find(".details").show(),e.$el=$("<li>").addClass("layer"),e.$el.html('<div class="header"><h3 class="title"></h3><div class="details"><span class="strokecolor"><span class="fillcolor"></span></span><strong class="layer_name"></strong></div><span class="layer_count"></span></div>'),e.$el.find(".details").hide(),e.$el.append($("#layer_content_model").clone().show().attr("id","")),this.$ul.append(e.$el),e.$el.find("input[name=name]").keyup(function(){e.setName(this.value),e.$el.find(".layer_name").text(this.value)}),e.$el.find("input[name=tags]").attr("id","tags"+e.getId()).tagsInput({autocomplete_url:"/project/search_all_tags/",height:"auto",width:"100%",onChange:function(){var t=n.setRule(e,$(this).val())}}),e.$el.find(".fillcolor").colpick({layout:"hex",submit:0,colorScheme:"light",onChange:function(t,n,r,i){i||(e.$el.find(".fillcolor").css("background","#"+n),e.setFillColor("#"+n))}}).keyup(function(){$(this).colpickSetColor(this.value)}),e.$el.find(".strokecolor").colpick({layout:"hex",submit:0,colorScheme:"light",onChange:function(t,n,r,i){i||(e.$el.find(".strokecolor").css("background","#"+n),e.setStrokeColor("#"+n))}}).keyup(function(){$(this).colpickSetColor(this.value)}),e.$el.data("layer",e),e.$el.find(".header").click(function(){n.toggleLayer(e)}),e.$el.find(".delete").click(function(){confirmationMessage(gettext("Remove layer"),gettext("Do you really want to remove this layer?"),null,function(t){t==="yes"&&n.removeLayer(e)})}),e.$el.find(".collapse_btn").click(function(){n.toggleLayer(e)}),this.layers.addLayer(e),e.setMap(t),this.refresh([e]),this},n.prototype.toggleLayer=function(e){return e.$el.find(".content").toggle(500),e.$el.find(".details").toggle(),this},n.prototype.setRandomColor=function(e){return hex=colors[++t],hex===undefined&&(hex=Math.floor(Math.random()*16777215).toString(16)),e.setFillColor("#"+hex),e.setStrokeColor("#"+hex),e.$el&&(e.$el.find(".fillcolor").css("background","#"+hex),e.$el.find(".strokecolor").css("background","#"+hex)),this},n.prototype.removeLayer=function(e){return e.delete=!0,e.isNew&&this.layers.remove(e),e.$el.remove(),this.refresh(),this},n.prototype.createNewLayer=function(t){var n=new e.Layer({id:"new"+this.cur++});return n.isNew=!0,this.setRandomColor(n),this.addNewLayer(n,t),n.$el.find("input[name=name]").focus(),this},n.prototype.loadLayers=function(e,n){for(var r=0,i=e.length;r<i;r++)this.addNewLayer(e[r],n);return t=e.length-1,this},n.prototype.toJSON=function(){return layers=[],this.layers.forEach(function(e){if(e.getId()=="Others")return;var t=e.toJSON();e.isNew&&(t.id=undefined),e.delete&&(t.delete=!0),layers.push(t)}),layers},n});