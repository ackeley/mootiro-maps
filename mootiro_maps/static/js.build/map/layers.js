var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};define(["require","./collections","underscore"],function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d;return i=e("./collections"),d=e("underscore"),p="/static/",o=["==","is","equal","equals"],l=["!=","isnt","not equal","not equals","different"],a=["in"],s=["contains","has"],c=["!","not"],h=["or"],r=["and"],u=function(e,t){var n,i,f,p,d,v,m,g;if(e==null||e.operator==null)return!0;if(t==null)return!1;i=e.operator,n=t.getProperty(e.property);if(__indexOf.call(o,i)>=0)return n===e.value;if(__indexOf.call(l,i)>=0)return!n===e.value;if(__indexOf.call(a,i)>=0)return n!=null&&__indexOf.call(e.value,n)>=0;if(__indexOf.call(s,i)>=0&&Object.prototype.toString.call(e.value)==="[object Array]"){f=!0,m=e.value;for(d=0,v=m.length;d<v;d++)p=m[d],f=f&&n!=null&&__indexOf.call(n,p)>=0;return f}if(__indexOf.call(s,i)>=0)return n&&(g=e.value,__indexOf.call(n,g)>=0);if(__indexOf.call(c,i)>=0)return!u(e.child,t);if(__indexOf.call(h,i)>=0)return u(e.left,t)||u(e.right,t);if(__indexOf.call(r,i)>=0)return u(e.left,t)&&u(e.right,t)},window.ee=u,n=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.addLayer=function(e){var t;return this.contains(e)||this.push(e),e.setLayersCollection(this),this._resetCache(),(t=e.map)!=null?t.publish("layer_added",e):void 0},n.prototype.getLayer=function(e){var t;return t=this.filter(function(t){return t.getId()===e||t.getName()===e}),t.first},n.prototype.showLayer=function(e){return this.getLayer(e).show()},n.prototype.hideLayer=function(e){return this.getLayer(e).hide()},n.prototype.showAll=function(){return this.forEach(function(e){return e.show()})},n.prototype.hideAll=function(){return this.forEach(function(e){return e.hide()})},n.prototype.getVisibleLayers=function(){return this.filter(function(e){return e.visible})},n.prototype.getHiddenLayers=function(){return this.filter(function(e){return!e.visible})},n.prototype.shouldFeatureBeVisible=function(e){var t,n,r=this;return e.isOutOfBounds()?!1:this.length===0?!0:(n=!1,t=this._getFromCache(e),t.forEach(function(t){var i,s;i=r.getLayer(t);if(!i.isVisible())return;return s=i.isVisible(),s&&(!n||i.isImportant())&&r._updateFeatureStyle(e,i),n||(n=s)}),t.length===0&&(n=!0),n)},n.prototype.setCollection=function(e){this.collection=e},n.prototype.getCollection=function(){var e,t,n;return(e=(t=this.collection)!=null?t:(n=this.map)!=null?n.getFeatures():void 0)!=null?e:[]},n.prototype.loadLayer=function(e){var n;return n=new t(d.extend({collection:this.getCollection(),map:this.map},e)),this.addLayer(n),n},n.prototype.loadLayers=function(e){var t,n=this;return t=[],e.forEach(function(e){return t.push(n.loadLayer(e))}),t},n.prototype.setMap=function(e){this.map=e;if(!this.map)return;return this.reset(),this.handleMapEvents(),this.forEach(function(e){return e.setMap(this.map)})},n.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("feature_added",function(t){var n;return n=!1,e.forEach(function(r){if(r.match(t))return e._addToCache(t,r),n||e._updateFeatureStyle(t,r),n=!0})})},n.prototype.reset=function(){return this._resetCache(),this.forEach(function(e){return e.reset()})},n.prototype._resetCache=function(){return this.cache={}},n.prototype._addToCache=function(e,t){var n,r,i;return(i=(n=this.cache)[r=e.uid])==null&&(n[r]=[]),this.cache[e.uid].push(t.getId())},n.prototype._getFromCache=function(e){var t,n,r=this;return t=this.cache[e.uid],t||this.forEach(function(t){if(t.match(e))return r._addToCache(e,t)}),(n=this.cache[e.uid])!=null?n:[]},n.prototype.toJSON=function(){var e;return e=[],this.forEach(function(t){return e.push(t.toJSON())}),e},n.prototype._updateFeatureStyle=function(e,t){return e.setBorderColor(t.getStrokeColor()),e.setBackgroundColor(t.getFillColor()),e.refresh()},n}(i.GenericCollection),t=function(){function e(e){var t,n,r,s,o,u,a,f,l;this.options=e!=null?e:{},this.cache=new i.FeatureCollection,this.visible=(t=this.options.visible)!=null?t:!0,this.icon=(n=(r=this.options.icon)!=null?r[0]:void 0)!=null?n:"",this.iconOff=(s=(o=this.options.icon)!=null?o[1]:void 0)!=null?s:"",this.fillColor=(u=this.options.fillColor)!=null?u:"#c0c0c0",this.strokeColor=(a=this.options.strokeColor)!=null?a:this.fillColor,this.id=""+((f=this.options.id)!=null?f:this.options.name),this.important=(l=this.options.important)!=null?l:!1,this.setPosition(this.options.position),this.setName(this.options.name),this.setRule(this.options.rule),this.setCollection(this.options.collection),this.setMap(this.options.map)}return e.prototype.getPosition=function(){return this.position},e.prototype.setPosition=function(e){return this.position=e,this},e.prototype.getId=function(){return this.id},e.prototype.getName=function(){return this.name},e.prototype.setName=function(e){return this.name=e,this},e.prototype.getFillColor=function(){return this.fillColor},e.prototype.setFillColor=function(e){return this.fillColor=e,this},e.prototype.getStrokeColor=function(){return this.strokeColor},e.prototype.setStrokeColor=function(e){return this.strokeColor=e,this},e.prototype.getCollection=function(){return this.collection},e.prototype.setCollection=function(e){return this.collection=e,this.cache.clear(),this},e.prototype.getLayersCollection=function(){return this.layersCollection},e.prototype.setLayersCollection=function(e){this.layersCollection=e},e.prototype.getRule=function(){return this.rule},e.prototype.setRule=function(e){return this.rule=e,this.cache.clear(),this},e.prototype.getIconUrl=function(){return this.icon&&p+(this.visible?this.icon:this.iconOff)},e.prototype.setMap=function(e){var t;this.map=e;if(!this.map)return;this.handleMapEvents(),typeof (t=this.cache).setMap=="function"&&t.setMap(this.map);if(this.collection==null)return this.setCollection(this.map.getFeatures())},e.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("feature_added",function(t){if(!e.cache.isEmpty()&&e.match(t))return e.cache.push(t)})},e.prototype.isVisible=function(){return this.visible},e.prototype.isImportant=function(){return this.important},e.prototype.show=function(){return this.visible=!0,this.getFeatures().show()},e.prototype.hide=function(){return this.visible=!1,this.getFeatures().hide()},e.prototype.toggle=function(){return this.visible?this.hide():this.show(),this.visible},e.prototype.match=function(e){return u(this.rule,e)},e.prototype.getFeatures=function(){return this.cache.isEmpty()&&this.updateCache(),this.cache},e.prototype.countFeatures=function(){return this.getFeatures().length},e.prototype.reset=function(){return this.cache.clear()},e.prototype.updateCache=function(){var e,t=this;return this.cache.clear(),e=this.collection.filter(this.match,this),e.forEach(function(e){return t.cache.push(e)}),this},e.prototype.toJSON=function(){return{id:this.getId(),name:this.getName(),rule:this.getRule(),position:this.getPosition(),fillColor:this.getFillColor(),strokeColor:this.getStrokeColor()}},e}(),f={Layers:n,Layer:t},f});