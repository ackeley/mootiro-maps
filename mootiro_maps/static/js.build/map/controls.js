var __hasProp=Object.prototype.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},__indexOf=Array.prototype.indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};define(["require","googlemaps","./component","./common","./geometries","./utils","infobox","markerclusterer"],function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,D,P,H,B,j,F,I,q,R,U,z,W,X,V,J,K,Q,G,Y,Z,et,tt,nt,rt,it,st,ot,ut;return Q=e("googlemaps"),l=e("./component"),J=e("./common"),K=e("./geometries"),G=e("./utils"),E=e("infobox"),D=e("markerclusterer"),window.komoo==null&&(window.komoo={}),(ut=window.komoo).event==null&&(ut.event=Q.event),st=gettext("Next step"),tt=gettext("Cancel"),nt=gettext("Close"),et=gettext("Add shape"),Y=gettext("Add line"),Z=gettext("Add point"),ot=gettext("Sum"),rt=gettext("Cut out"),it=gettext("Loading..."),v=J.geometries.types.EMPTY,j=J.geometries.types.POINT,O=J.geometries.types.MULTIPOINT,F=J.geometries.types.POLYGON,I=J.geometries.types.LINESTRING,x=J.geometries.types.LINESTRING,M=J.geometries.types.MULTILINESTRING,A=J.geometries.types.MULTILINESTRING,H={},H[j]=Q.drawing.OverlayType.MARKER,H[O]=Q.drawing.OverlayType.MARKER,H[x]=Q.drawing.OverlayType.POLYLINE,H[A]=Q.drawing.OverlayType.POLYLINE,H[F]=Q.drawing.OverlayType.POLYGON,d="edit",c="delete",P="new",t="add",u="cutout",B="perimeter_selection",o=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.position=Q.ControlPosition.RIGHT_BOTTOM,t.prototype.init=function(){var e;return t.__super__.init.call(this),this.box=(e=this.$el)!=null?e:$("<div>"),this.id!=null&&this.box.attr("id",this.id),this["class"]!=null&&this.box.addClass(this["class"]),this.position&&this.map.addControl(this.position,this.box.get(0)),typeof this.handleMapEvents=="function"?this.handleMapEvents():void 0},t.prototype.hide=function(){return this.box.hide()},t.prototype.show=function(){return this.box.show()},t}(l),k=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.position=Q.ControlPosition.TOP_CENTER,t.prototype.id="map-loading",t.prototype.init=function(){return t.__super__.init.call(this),this.requestsTotal=0,this.requestsWaiting=0,this.repaint()},t.prototype.getPercent=function(){return this.requestsTotal===0?0:Math.round(100*((this.requestsTotal-this.requestsWaiting)/this.requestsTotal))},t.prototype.repaint=function(){return this.box.html(""+it+" "+this.getPercent()+"%")},t.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("features_request_started",function(){return e.displayTimer=setTimeout(function(){return e.show()},500)}),this.map.subscribe("features_request_queued",function(){return e.requestsTotal++,e.requestsWaiting++,e.repaint()}),this.map.subscribe("features_request_unqueued",function(){return e.requestsWaiting--,e.repaint()}),this.map.subscribe("features_request_completed",function(){return e.requestsTotal=0,e.requestsWaiting=0,clearTimeout(e.displayTimer),setTimeout(function(){return e.hide()},200)})},t}(o),z=function(t){function n(){n.__super__.constructor.apply(this,arguments)}return __extends(n,t),n.prototype.position=Q.ControlPosition.TOP_RIGHT,n.prototype.id="map-searchbox",n.prototype.init=function(){var t=this;return n.__super__.init.call(this),e(["map/views"],function(e){return t.view=new e.SearchBoxView,t.box.append(t.view.render().el),t.handleViewEvents()})},n.prototype.handleViewEvents=function(){var e=this;return this.view.on("search",function(t){var n,r;return r=t.type,n=t.position,e.map.publish("goto",n,!0)})},n}(o),T=function(t){function n(){n.__super__.constructor.apply(this,arguments)}return __extends(n,t),n.prototype.position=null,n.prototype.init=function(){var t=this;return n.__super__.init.call(this),e(["map/views"],function(e){return t.layers=t.map.getLayers(),t.layers.layersBox=t.box,t.view=new e.LayersBoxView,t.box.append(t.view.render(t.layers).el),t.handleViewEvents()})},n.prototype.handleViewEvents=function(){var e=this;return this.view.on("highlight_feature",function(t){return e.map.highlightFeature(t)}),this.view.on("show",function(t){return e.layers.getLayer(t).show()}),this.view.on("hide",function(t){return e.layers.getLayer(t).hide()})},n.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("layer_added",function(t){var n;return(n=e.view)!=null?n.render(e.layers):void 0})},n}(o),X=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.id="map-supporters",t.prototype.init=function(){return t.__super__.init.call(this),this.box.append($("#map-supporters-content").show())},t}(o),C=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.id="map-license",t.prototype.position=Q.ControlPosition.BOTTOM_LEFT,t.prototype.init=function(){return t.__super__.init.call(this),this.box.html('Este conteúdo é disponibilizado nos termos da licença <a href="http://creativecommons.org/licenses/by-sa/3.0/deed.pt_BR">Creative Commons - Atribuição - Partilha nos Mesmos Termos 3.0 Não Adaptada</a>; pode estar sujeito a condições adicionais. Para mais detalhes, consulte as Condições de Uso.')},t}(o),p=function(e){function n(){n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.enabled=!0,n.prototype.defaultDrawingManagerOptions={drawingControl:!1,drawingMode:null},n.prototype.componentOriginalStatus={},n.prototype.init=function(e){var t;this.options=e!=null?e:{},(t=this.options).drawingManagerOptions==null&&(t.drawingManagerOptions=this.defaultDrawingManagerOptions);if(this.options.map)return this.setMap(this.options.map)},n.prototype.initManager=function(e){return e==null&&(e=this.defaultDrawingManagerOptions),this.manager=new Q.drawing.DrawingManager(e),this.handleManagerEvents()},n.prototype.setMap=function(e){return this.map=e,this.options.drawingManagerOptions.map=this.map.googleMap,this.initManager(this.options.drawingManagerOptions),this.handleMapEvents()},n.prototype.enable=function(){return this.enabled=!0},n.prototype.disable=function(){return this.enabled=!1},n.prototype.setMode=function(e){var n;this.mode=e,this.manager.setDrawingMode((n=this.mode)===t||n===P||this.mode===u&&this.feature.getGeometryType()===F?H[this.feature.getGeometryType()]:null);if(this.mode===u&&this.feature.getGeometryType()!==F)return this.mode=d},n.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("draw_feature",function(t,n){return e.drawFeature(n)}),this.map.subscribe("edit_feature",function(t){return e.editFeature(t)}),this.map.subscribe("drawing_finished",function(t){return e.feature.setEditable(!1),e.feature.updateIcon(),e.setFeature(null),e.setMode(null)}),this.map.subscribe("finish_drawing",function(){return e.map.publish("drawing_finished",e.feature,!0)}),this.map.subscribe("cancel_drawing",function(){return e.map.publish("drawing_finished",e.feature,!1)}),this.map.subscribe("mode_changed",function(t){return e.setMode(t)}),this.map.subscribe("feature_rightclick",function(e,t){var n,r,i;if(e.vertex==null)return;n=t.getGeometry().getOverlay(),i=typeof n.getPaths=="function"?n.getPaths():void 0,r=i!=null?i.getAt(e.path):void 0,r!=null&&r.removeAt(e.vertex);if((r!=null?r.getLength():void 0)===1)return i.removeAt(e.path)})},n.prototype.handleManagerEvents=function(){var e=this;return komoo.event.addListener(this.manager,"overlaycomplete",function(n){var r,i,s,o,a,f,l,c,h,p,v,m,g;s=(l=n.overlay)!=null?typeof l.getPath=="function"?l.getPath():void 0:void 0;if(s&&((c=e.mode)===t||c===P||c===u)&&((h=n.overlay)!=null?h.getPaths:void 0)){o=e.feature.getGeometry().getPaths(),e.mode===P&&o.clear();if((o!=null?o.length:void 0)>0){a=Q.geometry.spherical.computeSignedArea(s),f=Q.geometry.spherical.computeSignedArea(o.getAt(0)),r=a/Math.abs(a),i=f/Math.abs(f);if(r===i&&e.mode===u||r!==i&&((p=e.mode)===t||p===P))s=new Q.MVCArray(s.getArray().reverse())}o.push(s),e.feature.getGeometry().setPaths(o),n.overlay.setMap(null)}else(v=e.mode)!==t&&v!==P||!n.overlay.getPosition?((m=e.mode)===t||m===P)&&n.overlay.getPath&&e.feature.getGeometry().addPolyline(n.overlay,!0):(e.feature.getGeometry().addMarker(n.overlay),e.feature.updateIcon(100));return e.map.setMode(d),(g=e.feature)!=null?g.setEditable(!0):void 0})},n.prototype.setFeature=function(e){var t=this;this.feature=e,this.featureClickListener!=null&&komoo.event.removeListener(this.featureClickListener);if(this.feature==null)return;return this.feature.setMap(this.map,{geometry:!0}),this.featureClickListener=komoo.event.addListener(this.feature,"click",function(e,n){var r,i,s,o,u,a;if(t.mode===c)return t.feature.getGeometryType()===F?(o=t.feature.getGeometry().getPaths(),o.forEach(function(t,n){if(G.isPointInside(e.latLng,t))return o.removeAt(n)})):n&&t.feature.getGeometryType()===O?(s=t.feature.getGeometry().getMarkers(),r=$.inArray(n,s.getArray()),r>-1&&(i=s.removeAt(r),i.setMap(null))):n&&t.feature.getGeometryType()===A&&(a=t.feature.getGeometry().getPolylines(),r=$.inArray(n,a.getArray()),r>-1&&(u=a.removeAt(r),u.setMap(null))),t.map.setMode(d)})},n.prototype.editFeature=function(e){var t;if(this.enabled===!1)return;this.setFeature(e);if(this.feature.getGeometryType()==="Empty"){this.map.publish("select_new_geometry",this.feature);return}return this.feature.setEditable(!0),t={},t[""+H[this.feature.getGeometryType()]+"Options"]=this.feature.getGeometry().getOverlayOptions({strokeWeight:2.5,zoom:100}),this.manager.setOptions(t),this.map.setMode(d),this.map.publish("drawing_started",this.feature)},n.prototype.drawFeature=function(e){this.feature=e;if(this.enabled===!1)return;return this.editFeature(this.feature),this.map.setMode(P)},n}(l),a=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.id="map-drawing-box",t.prototype["class"]="map-panel",t.prototype.position=Q.ControlPosition.TOP_LEFT,t.prototype.init=function(e){var n,r;return e==null&&(e={title:""}),t.__super__.init.call(this),n=(r=e.title)!=null?r:"",this.box.html('<div id="drawing-control">\n  <div class="map-panel-title" id="drawing-control-title">'+n+'</div>\n  <div class="content" id="drawing-control-content"></div>\n  <div class="map-panel-buttons">\n    <div class="map-button" id="drawing-control-cancel">'+nt+"</div>\n  </div>\n</div>"),this.show(),this.handleButtonEvents()},t.prototype.setTitle=function(e){return e==null&&(e=""),this.box.find("#drawing-control-title").text(e)},t.prototype.handleButtonEvents=function(){var e=this;return $("#drawing-control-cancel",this.box).click(function(){return e.map.publish("close_clicked")})},t}(o),w=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.id="map-drawing-box",t.prototype["class"]="map-panel",t.prototype.position=Q.ControlPosition.TOP_LEFT,t.prototype.init=function(){return t.__super__.init.call(this),this.hide(),this.box.html('<div id="geometry-selector">\n  <div class="map-panel-title" id="drawing-control-title"></div>\n  <ul class="content" id="drawing-control-content">\n    <li class="polygon btn" data-geometry-type="Polygon">\n      <i class="icon-polygon middle"></i><span class="middle">Adicionar área</span>\n    </li>\n    <li class="linestring btn" data-geometry-type="LineString">\n      <i class="icon-linestring middle"></i><span class="middle">Adicionar linha</span>\n    </li>\n    <li class="point btn" data-geometry-type="Point">\n      <i class="icon-point middle"></i><span class="middle">Adicionar ponto</span>\n    </li>\n  </ul>\n  <div class="map-panel-buttons">\n    <div class="map-button" id="drawing-control-cancel">'+tt+"</div>\n  </div>\n</div>"),this.handleBoxEvents()},t.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("select_new_geometry",function(t){return e.open(t)})},t.prototype.handleBoxEvents=function(){var e=this;return this.box.find("li").each(function(t,n){var r,i;return r=$(n),i=r.attr("data-geometry-type"),r.click(function(){return e.close(),e.map.editFeature(e.feature,i)})})},t.prototype.handleButtonEvents=function(){var e=this;return $("#drawing-control-cancel",this.box).click(function(){return e.map.publish("cancel_drawing")})},t.prototype.showContent=function(){var e,t,n,r,i,s;this.box.find("li").hide(),i=(r=this.feature.getFeatureType())!=null?r.geometryTypes:void 0,s=[];for(t=0,n=i.length;t<n;t++)e=i[t],s.push(this.box.find("li."+e.toLowerCase()).show());return s},t.prototype.open=function(e){return this.feature=e,this.showContent(),$("#drawing-control-title",this.box).html("Selecione o tipo de objeto"),this.handleButtonEvents(),this.show()},t.prototype.close=function(){return this.hide()},t}(o),h=function(e){function n(){n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.id="map-drawing-box",n.prototype["class"]="map-panel",n.prototype.position=Q.ControlPosition.TOP_LEFT,n.prototype.init=function(){return n.__super__.init.call(this),this.hide(),this.box.html('<div id="drawing-control">\n  <div class="map-panel-title" id="drawing-control-title"></div>\n  <div class="content" id="drawing-control-content"></div>\n  <div class="map-panel-buttons">\n    <div class="map-button" id="drawing-control-finish">'+st+'</div>\n    <div class="map-button" id="drawing-control-cancel">'+tt+"</div>\n  </div>\n</div>"),this.handleBoxEvents()},n.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("drawing_started",function(t){return e.open(t)}),this.map.subscribe("drawing_finished",function(t){return e.close()}),this.map.subscribe("mode_changed",function(t){return e.setMode(t)})},n.prototype.handleBoxEvents=function(){var e=this;return $("#drawing-control-finish",this.box).click(function(){if($("#drawing-control-finish",e.box).hasClass("disabled"))return;return e.map.publish("finish_drawing")}),$("#drawing-control-cancel",this.box).click(function(){return e.map.publish("cancel_drawing")})},n.prototype.handleButtonEvents=function(){var e=this;return $("#drawing-control-add",this.box).click(function(){return e.map.setMode(e.mode!==t?t:d)}),$("#drawing-control-cutout",this.box).click(function(){return e.map.setMode(e.mode!==u?u:d)}),$("#drawing-control-delete",this.box).click(function(){return e.map.setMode(e.mode!==c?c:d)})},n.prototype.setMode=function(e){var t;return this.mode=e,this.mode===P?($("#drawing-control-content",this.box).hide(),$("#drawing-control-finish",this.box).addClass("disabled")):($("#drawing-control-content",this.box).show(),$("#drawing-control-finish",this.box).removeClass("disabled")),$(".map-button.active",this.box).removeClass("active"),$("#drawing-control-"+((t=this.mode)!=null?t.toLowerCase():void 0),this.box).addClass("active")},n.prototype.getTitle=function(){var e,t,n,r;if(this.feature.getGeometryType()===F)e="polygon",t=et;else if((n=this.feature.getGeometryType())===x||n===A)e="linestring",t=Y;else if((r=this.feature.getGeometryType())===j||r===O)e="point",t=Z;return'<i class="icon-'+e+' middle"></i><span class="middle">'+t+"</span>"},n.prototype.getContent=function(){var e,t,n,r;return e=$('<div class="map-button" id="drawing-control-add"><i class="icon-komoo-plus middle"></i><span class="middle">'+ot+"</span></div>"),n=$('<div class="map-button" id="drawing-control-cutout"><i class="icon-komoo-minus middle"></i><span class="middle">'+rt+"</span></div>"),r=$('<div class="map-button" id="drawing-control-delete"><i class="icon-komoo-trash middle"></i></div>'),t=$("<div>").addClass(this.feature.getGeometryType().toLowerCase()),this.feature.getGeometryType()!==j&&t.append(e),this.feature.getGeometryType()===F&&t.append(n),this.feature.getGeometryType()!==j&&t.append(r),t},n.prototype.open=function(e){return this.feature=e,$("#drawing-control-title",this.box).html(this.getTitle()),$("#drawing-control-content",this.box).html(this.getContent()),this.handleButtonEvents(),this.show()},n.prototype.close=function(){return this.hide()},n}(o),q=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.enabled=!0,t.prototype.init=function(){var e=this;return t.__super__.init.call(this),this.circle=new Q.Circle({visible:!0,radius:100,fillColor:"white",fillOpacity:0,strokeColor:"#ffbda8",zIndex:-1}),this.marker=new Q.Marker({icon:"/static/img/marker.png"}),komoo.event.addListener(this.circle,"click",function(t){if(e.map.mode===B)return e.selected(t.latLng)})},t.prototype.select=function(e,t){this.radius=e,this.callback=t;if(!this.enabled)return;return this.origMode=this.map.mode,this.map.disableComponents("infoWindow"),this.map.setMode(B)},t.prototype.selected=function(e){return typeof this.radius=="number"&&this.circle.setRadius(this.radius),typeof this.callback=="function"&&this.callback(e,this.circle),this.circle.setCenter(e),this.circle.setMap(this.map.googleMap),this.marker.setPosition(e),this.marker.setMap(this.map.googleMap),this.map.publish("perimeter_selected",e,this.circle),this.map.setMode(this.origMode),this.map.enableComponents("infoWindow")},t.prototype.handleMapEvents=function(){var e,t,n,r,i,s=this;this.map.subscribe("select_perimeter",function(e,t){return s.select(e,t)}),r=["click","feature_click"],i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(this.map.subscribe(e,function(e){if(s.map.mode===B)return s.selected(e.latLng)}));return i},t.prototype.setMap=function(e){return this.map=e,this.handleMapEvents()},t.prototype.enable=function(){return this.enabled=!0},t.prototype.disable=function(){return this.hide(),this.enabled=!1},t}(l),s=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.defaultWidth="300px",t.prototype.enabled=!0,t.prototype.init=function(e){return this.options=e!=null?e:{},t.__super__.init.call(this),this.width=this.options.width||this.defaultWidth,this.createInfoBox(this.options),this.options.map&&this.setMap(this.options.map),this.customize()},t.prototype.createInfoBox=function(e){return this.setInfoBox(new E({pixelOffset:new Q.Size(0,-20),enableEventPropagation:!0,closeBoxMargin:"10px",disableAutoPan:!0,boxStyle:{cursor:"pointer",background:"url(/static/img/infowindow-arrow.png) no-repeat 0 10px",width:this.width}}))},t.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("drawing_started",function(t){return e.disable()}),this.map.subscribe("drawing_finished",function(t){return e.enable()})},t.prototype.setInfoBox=function(e){this.infoBox=e},t.prototype.setMap=function(e){return this.map=e,this.handleMapEvents()},t.prototype.enable=function(){return this.enabled=!0},t.prototype.disable=function(){return this.close(!1),this.enabled=!1},t.prototype.open=function(e){var t,n,r,i,s,o,u,a;this.options=e!=null?e:{};if(!this.enabled)return;return this.setContent(this.options.content||(this.options.features?this.createClusterContent(this.options):this.createFeatureContent(this.options))),this.feature=(s=this.options.feature)!=null?s:(o=this.options.features)!=null?o.getAt(0):void 0,i=(u=this.options.position)!=null?u:this.feature.getCenter(),i instanceof Array&&(t=new komoo.geometries.Empty,i=t.getLatLngFromArray(i)),r=G.latLngToPoint(this.map,i),r.x+=5,n=G.pointToLatLng(this.map,r),this.infoBox.setPosition(n),this.infoBox.open((a=this.map.googleMap)!=null?a:this.map)},t.prototype.setContent=function(e){return e==null&&(e={title:"",body:""}),typeof e=="string"&&(e={title:"",url:"",body:e}),this.title.html(e.url?'<a href="'+e.url+"'\">"+e.title+"</a>":e.title),this.body.html(e.body)},t.prototype.close=function(){var e;return this.isMouseover=!1,this.infoBox.close(),((e=this.feature)!=null?e.isHighlighted():void 0)&&this.feature.setHighlight(!1),this.feature=null},t.prototype.customize=function(){var e=this;return Q.event.addDomListener(this.infoBox,"domready",function(t){var n;return n=e.infoBox.div_,Q.event.addDomListener(n,"click",function(e){return e.cancelBubble=!0,typeof e.stopPropagation=="function"?e.stopPropagation():void 0}),Q.event.addDomListener(n,"mouseout",function(t){return e.isMouseover=!1}),komoo.event.trigger(e,"domready")}),this.initDomElements()},t.prototype.initDomElements=function(){var e=this;return this.title=$("<div>"),this.body=$("<div>"),this.content=$("<div>").addClass("map-infowindow-content"),this.content.append(this.title),this.content.append(this.body),this.content.css({background:"white",padding:"10px",margin:"0 0 0 15px"}),this.content.hover(function(t){return e.isMouseover=!0},function(t){return e.isMouseover=!1}),this.infoBox.setContent(this.content.get(0))},t.prototype.createClusterContent=function(e){var t,n,r,i,s;return e==null&&(e={}),r=e.features||[],i=ngettext("%s Community","%s Communities",r.length),s="<strong>"+interpolate(i,[r.length])+"</strong>",t=function(){var e,t,i,s;i=r.slice(0,11),s=[];for(e=0,t=i.length;e<t;e++)n=i[e],s.push("<li>"+n.getProperty("name")+"</li>");return s}(),t="<ul>"+t.join("")+"</ul>",{title:s,url:"",body:t}},t.prototype.createFeatureContent=function(e){var t,n;return e==null&&(e={}),n="",t=e.feature,t&&(n=t.getProperty("name")),{title:n,url:"",body:""}},t}(l),n=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.createFeatureContent=function(e){var n,r,i=this;e==null&&(e={}),n=e.feature;if(!n)return;return n[this.contentViewName]?n[this.contentViewName]:n.getProperty("id")==null?t.__super__.createFeatureContent.call(this,e):(r=dutils.urls.resolve(this.contentViewName,{zoom:this.map.getZoom(),app_label:n.featureType.appLabel,model_name:n.featureType.modelName,obj_id:n.getProperty("id")}),$.get(r,function(e){return n[i.contentViewName]=e,i.setContent(e)}),it)},t}(s),S=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.defaultWidth="350px",t.prototype.contentViewName="info_window",t.prototype.open=function(e){var n,r;return(n=this.feature)!=null&&(n.displayTooltip=!0),t.__super__.open.call(this,e),(r=this.feature)!=null?r.displayTooltip=!1:void 0},t.prototype.close=function(e){var n,r;return e==null&&(e=!0),(n=this.feature)!=null&&n.setHighlight(!1),(r=this.feature)!=null&&(r.displayTooltip=!0),e&&this.map.enableComponents("tooltip"),t.__super__.close.call(this)},t.prototype.customize=function(){var e=this;return t.__super__.customize.call(this),Q.event.addDomListener(this.infoBox,"domready",function(t){var n,r;return r=e.content.get(0),n=e.infoBox.div_.firstChild,Q.event.addDomListener(r,"mousemove",function(t){return e.map.disableComponents("tooltip")}),Q.event.addDomListener(r,"mouseout",function(t){n=e.infoBox.div_.firstChild;if(t.toElement!==n)return e.map.enableComponents("tooltip")}),Q.event.addDomListener(n,"click",function(t){return e.close()})})},t.prototype.handleMapEvents=function(){var e=this;return t.__super__.handleMapEvents.call(this),this.map.subscribe("feature_click",function(t,n){return setTimeout(function(){return e.open({feature:n,position:t.latLng})},200)}),this.map.subscribe("feature_highlight_changed",function(t,n){if(n.isHighlighted())return e.open({feature:n})})},t}(n),V=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.contentViewName="tooltip",t.prototype.close=function(){return clearTimeout(this.timer),t.__super__.close.call(this)},t.prototype.customize=function(){var e=this;return t.__super__.customize.call(this),Q.event.addDomListener(this.infoBox,"domready",function(t){var n,r;return r=e.infoBox.div_,Q.event.addDomListener(r,"click",function(t){return t.latLng=e.infoBox.getPosition(),e.map.publish("feature_click",t,e.feature)}),n=r.firstChild,$(n).hide()})},t.prototype.handleMapEvents=function(){var e=this;return t.__super__.handleMapEvents.call(this),this.map.subscribe("feature_mousemove",function(t,n){var r;clearTimeout(e.timer);if(n===e.feature||!n.displayTooltip)return;return r=n.getType()==="Community"?400:10,e.timer=setTimeout(function(){if(!n.displayTooltip)return;return e.open({feature:n,position:t.latLng})},r)}),this.map.subscribe("feature_mouseout",function(t,n){return e.close()}),this.map.subscribe("feature_click",function(t,n){return e.close()}),this.map.subscribe("cluster_mouseover",function(t,n){var r;if((r=t.getAt(0))!=null?!r.displayTooltip:!void 0)return;return e.open({features:t,position:n})}),this.map.subscribe("cluster_mouseout",function(t,n){return e.close()}),this.map.subscribe("cluster_click",function(t,n){return e.close()})},t}(n),m=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.enabled=!0,t.prototype.maxZoom=9,t.prototype.gridSize=20,t.prototype.minSize=1,t.prototype.imagePath="/static/img/cluster/communities",t.prototype.imageSizes=[24,29,35,41,47],t.prototype.hooks={before_feature_setVisible:"beforeFeatureSetVisibleHook"},t.prototype.beforeFeatureSetVisibleHook=function(e,t){return this.map.getProjectId()!=null?[e,t]:[e,t&&this.map.getZoom()>this.maxZoom]},t.prototype.init=function(e){var t,n,r,i,s;return this.options=e!=null?e:{},(t=this.options).gridSize==null&&(t.gridSize=this.gridSize),(n=this.options).maxZoom==null&&(n.maxZoom=this.maxZoom),(r=this.options).minimumClusterSize==null&&(r.minimumClusterSize=this.minSize),(i=this.options).imagePath==null&&(i.imagePath=this.imagePath),(s=this.options).imageSizes==null&&(s.imageSizes=this.imageSizes),this.featureType=this.options.featureType,this.features=[],window.c=this},t.prototype.initMarkerClusterer=function(e){var t,n;return e==null&&(e={}),t=((n=this.map)!=null?n.googleMap:void 0)||this.map,window.clusterer=this.clusterer=new D(t,[],e)},t.prototype.initEvents=function(e){var t,n=this;e==null&&(e=this.clusterer);if(!e)return;return t=["clusteringbegin","clusteringend"],t.forEach(function(t){return komoo.event.addListener(e,t,function(e){return komoo.event.trigger(n,t,n)})}),t=["click","mouseout","mouseover"],t.forEach(function(t){return komoo.event.addListener(e,t,function(e){var r,i;return r=komoo.collections.makeFeatureCollection({features:function(){var t,n,r,s;r=e.getMarkers(),s=[];for(t=0,n=r.length;t<n;t++)i=r[t],s.push(i.feature);return s}()}),komoo.event.trigger(n,t,r,e.getCenter()),n.map.publish("cluster_"+t,r,e.getCenter())})})},t.prototype.setMap=function(e){return this.map=e,this.initMarkerClusterer(this.options),this.initEvents(),this.handleMapEvents()},t.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("feature_created",function(t){if(e.map.getZoom()<=e.maxZoom&&(e.featureType==null||t.getType()===e.featureType))return e.push(t)}),this.map.subscribe("idle features_loaded",function(){if(e.map.getZoom()<=e.maxZoom)return e.length===0&&e.addFeatures(e.map.getFeatures()),e.repaint()}),this.map.subscribe("features_request_completed",function(){var t;if(e.map.getZoom()<=e.maxZoom)return t=e.map.getFeatures(),e.addFeatures(t)}),komoo.event.addListener(this,"clusteringend",function(t){if(e.map.getZoom()>e.maxZoom)return e.map.features.forEach(function(e){var t;return(t=e.marker)!=null?t.setMap(null):void 0})})},t.prototype.updateLength=function(){return this.length=this.features.length},t.prototype.clear=function(){return this.features=[],this.clusterer.clearMarkers(),this.updateLength()},t.prototype.getAt=function(e){return this.features[e]},t.prototype.push=function(e){if(this.map.getProjectId()!=null)return;if(e.getMarker())return this.features.push(e),e.getMarker().setVisible(!0),this.clusterer.addMarker(e.getMarker().getOverlay().markers_.getAt(0),!0),this.updateLength()},t.prototype.pop=function(){var e;return e=this.features.pop(),this.clusterer.removeMarker(e.getMarker().getOverlay().markers_.getAt(0)),this.updateLength(),e},t.prototype.forEach=function(e,t){var n,r,i,s,o;s=this.features,o=[];for(r=0,i=s.length;r<i;r++)n=s[r],o.push(e.apply(t,n));return o},t.prototype.repaint=function(){return this.clusterer.repaint()},t.prototype.getAverageCenter=function(){return this.clusterer.getAverageCenter()},t.prototype.addFeatures=function(e){var t=this;return e!=null&&e.forEach(function(e){return t.push(e)}),this.repaint()},t}(l),f=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.push=function(e){if(e.featureType===this.map.featureTypes.Community)return t.__super__.push.call(this,e)},t}(m),L=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.enabled=!0,t.prototype.init=function(){return this.geocoder=new Q.Geocoder,this.marker=new Q.Marker({icon:"/static/img/marker.png"})},t.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("goto",function(t,n){return e.goTo(t,n)}),this.map.subscribe("goto_user_location",function(){return e.goToUserLocation()})},t.prototype.goTo=function(e,t){var n,r,i,s=this;return t==null&&(t=!1),i=function(e){if(e){s.map.googleMap.panTo(e);if(t)return s.marker.setPosition(e)}},typeof e=="string"?(r={address:e,region:this.region},this.geocoder.geocode(r,function(e,t){var n,r;if(t===Q.GeocoderStatus.OK)return n=e[0],r=n.geometry.location,i(r)})):(n=e instanceof Array?e.length===2?new Q.LatLng(e[0],e[1]):void 0:e,i(n))},t.prototype.goToUserLocation=function(){var e,t,n=this;e=google.loader.ClientLocation,e&&(t=new Q.LatLng(e.latitude,e.longitude),this.map.googleMap.setCenter(t),typeof console!="undefined"&&console!==null&&console.log("Getting location from Google..."));if(navigator.geolocation)return navigator.geolocation.getCurrentPosition(function(e){return t=new Q.LatLng(e.coords.latitude,e.coords.longitude),n.map.googleMap.setCenter(t),typeof console!="undefined"&&console!==null?console.log("Getting location from navigator.geolocation..."):void 0},function(){return typeof console!="undefined"&&console!==null?console.log("User denied access to navigator.geolocation..."):void 0})},t.prototype.setMap=function(e){return this.map=e,this.marker.setMap(this.map.googleMap),this.handleMapEvents()},t.prototype.enable=function(){return this.enabled=!0},t.prototype.disable=function(){return this.close(!1),this.enabled=!1},t}(l),R=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.handleMapEvents=function(){var e=this;return t.__super__.handleMapEvents.call(this),this.map.subscribe("save_location",function(t,n){return e.saveLocation(t,n)}),this.map.subscribe("goto_saved_location",function(){return e.goToSavedLocation()})},t.prototype.saveLocation=function(e,t){return e==null&&(e=this.map.googleMap.getCenter()),t==null&&(t=this.map.getZoom()),G.createCookie("lastLocation",e.toUrlValue(),90),G.createCookie("lastZoom",t,90)},t.prototype.goToSavedLocation=function(){var e,t;e=G.readCookie("lastLocation"),t=parseInt(G.readCookie("lastZoom"),10);if(e&&t)return typeof console!="undefined"&&console!==null&&console.log("Getting location from cookie..."),this.map.publish("set_location",e),this.map.publish("set_zoom",t)},t}(L),r=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.handleMapEvents=function(){var e=this;return t.__super__.handleMapEvents.call(this),this.map.subscribe("idle",function(){return e.saveLocation()})},t}(R),U=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.setMap=function(e){var t;this.map=e,this.handleMapEvents(),t=this.getSavedMapType();if(__indexOf.call(_.values(Q.MapTypeId),t)>=0)return this.useSavedMapType()},t.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("maptype_loaded",function(t){if(t===e.getSavedMapType())return e.map.googleMap.setMapTypeId(t)}),this.map.subscribe("initialized",function(){return e.useSavedMapType()})},t.prototype.saveMapType=function(e){return e==null&&(e=this.map.getMapTypeId()),G.createCookie("mapTypeId",e,Q.MapTypeId.ROADMAP)},t.prototype.getSavedMapType=function(){return G.readCookie("mapTypeId")},t.prototype.useSavedMapType=function(){var e;return e=this.getSavedMapType(),typeof console!="undefined"&&console!==null&&console.log("Getting map type from cookie..."),this.map.googleMap.setMapTypeId(e)},t}(l),i=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.handleMapEvents=function(){var e=this;return t.__super__.handleMapEvents.call(this),this.map.subscribe("maptypeid_changed",function(){return e.saveMapType()})},t}(U),W=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.enabled=!0,t.prototype.init=function(){return typeof console!="undefined"&&console!==null&&console.log("Initializing StreetView support."),this.streetViewPanel=$("<div>").addClass("map-panel"),this.streetViewPanel.height("100%").width("50%"),this.streetViewPanel.hide(),this.createObject()},t.prototype.setMap=function(e){this.map=e,this.map.googleMap.controls[Q.ControlPosition.TOP_LEFT].push(this.streetViewPanel.get(0));if(this.streetView!=null)return this.map.googleMap.setStreetView(this.streetView)},t.prototype.createObject=function(){var e,t,n=this;return e={enableCloseButton:!0,visible:!1},this.streetView=new Q.StreetViewPanorama(this.streetViewPanel.get(0),e),(t=this.map)!=null&&t.googleMap.setStreetView(this.streetView),Q.event.addListener(this.streetView,"visible_changed",function(){return n.streetView.getVisible()?n.streetViewPanel.show():n.streetViewPanel.hide(),n.map.refresh()})},t}(l),g=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.hooks={before_feature_setVisible:"beforeFeatureSetVisibleHook"},t.prototype.init=function(){return typeof this.handleMapEvents=="function"?this.handleMapEvents():void 0},t.prototype.beforeFeatureSetVisibleHook=function(e,t){return[e,t]},t}(l),b=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.hooks={before_feature_setVisible:"beforeFeatureSetVisibleHook"},t.prototype.beforeFeatureSetVisibleHook=function(e,t){var n,r;return this.map.getProjectId()!=null?[e,t]:(r=this.map.getZoom(),n=t&&(e.featureType.minZoomPoint<=r&&e.featureType.maxZoomPoint>=r||e.featureType.minZoomGeometry<=r&&e.featureType.maxZoomGeometry>=r),[e,n])},t}(g),y=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.hooks={before_feature_setVisible:"beforeFeatureSetVisibleHook"},t.prototype.init=function(){return t.__super__.init.call(this),this.disabled=["User"]},t.prototype.beforeFeatureSetVisibleHook=function(e,t){var n,r;return n=t,t&&(r=e.featureType.type,__indexOf.call(this.disabled,r)>=0)&&(n=!1),[e,n]},t.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("hide_features_by_type",function(t,n,r){if(__indexOf.call(e.disabled,t)<0)return e.disabled.push(t)}),this.map.subscribe("show_features_by_type",function(t,n,r){var i;if(__indexOf.call(e.disabled,t)>=0)return i=_.indexOf(e.disabled,t),e.disabled.splice(i,1)})},t}(g),N=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.hooks={before_feature_setVisible:"beforeFeatureSetVisibleHook"},t.prototype.init=function(){return t.__super__.init.call(this),this.disabled=[],window.dd=this.disabled},t.prototype.beforeFeatureSetVisibleHook=function(e,t){var n;return n=t,t&&!this.map.getLayers().shouldFeatureBeVisible(e)&&(n=!1),[e,n]},t.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("show_layer",function(t){if(__indexOf.call(e.disabled,t)<0)return e.disabled.push(t)}),this.map.subscribe("hide_layer",function(t){var n;if(__indexOf.call(e.disabled,t)>=0)return n=_.indexOf(e.disabled,t),e.disabled.splice(n,1)})},t}(g),window.komoo.controls={DrawingManager:p,DrawingControl:h,GeometrySelector:w,Balloon:s,AjaxBalloon:n,InfoWindow:S,Tooltip:V,FeatureClusterer:m,CommunityClusterer:f,CloseBox:a,LoadingBox:k,SupporterBox:X,LicenseBox:C,SearchBox:z,LayersBox:T,PerimeterSelector:q,Location:L,SaveLocation:R,AutosaveLocation:r,SaveMapType:U,AutosaveMapType:i,StreetView:W,FeatureFilter:g,FeatureZoomFilter:b,FeatureTypeFilter:y,LayersFilter:N},window.komoo.controls});