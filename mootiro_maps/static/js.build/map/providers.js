var __hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};define(["require","googlemaps","./component"],function(e){var t,n,r,i,s,o,u,a;return s=e("googlemaps"),t=e("./component"),(u=window.komoo)==null&&(window.komoo={}),(a=(o=window.komoo).event)==null&&(o.event=s.event),n=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.name="Generic Provider",t.prototype.alt="Generic Data Provider",t.prototype.tileSize=new s.Size(256,256),t.prototype.maxZoom=32,t.prototype.expiration=6e5,t.prototype.enabled=!0,t.prototype.init=function(e){return this.options=e,this.addrLatLngCache={},this.fetchedTiles={}},t.prototype.setMap=function(e){return this.map=e,this.map.googleMap.overlayMapTypes.insertAt(0,this),typeof this.handleMapEvents=="function"?this.handleMapEvents():void 0},t.prototype.enable=function(){return this.enabled=!0},t.prototype.disable=function(){return this.enabled=!1},t.prototype.getUrl=function(e,t){var n,r;return n=this.getAddrLatLng(e,t),r=this.fetchUrl+n,this.map.getProjectId()&&(r+="&project="+this.map.getProjectId()),r},t.prototype.getAddrLatLng=function(e,t){var n,r,i,o,u,a,f;return n="x="+e.x+",y="+e.y+",z="+t,this.addrLatLngCache[n]?this.addrLatLngCache[n]:(i=1<<t,a=this.map.googleMap.getProjection(),o=new s.Point((e.x+1)*this.tileSize.width/i,e.y*this.tileSize.height/i),u=new s.Point(e.x*this.tileSize.width/i,(e.y+1)*this.tileSize.height/i),r=a.fromPointToLatLng(o),f=a.fromPointToLatLng(u),this.addrLatLngCache[n]="bounds="+r.toUrlValue()+","+f.toUrlValue()+"&zoom="+t)},t}(t),r=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.name="Feature Provider",t.prototype.alt="Feature Provider",t.prototype.fetchUrl="/get_geojson?",t.prototype.init=function(e){return t.__super__.init.call(this,e),this.keptFeatures=komoo.collections.makeFeatureCollection(),window.kf=this.keptFeatures,this.openConnections=0,this._addrs=[],this._requestQueue={}},t.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("idle",function(){var t;return t=e.map.googleMap.getBounds(),e.keptFeatures.forEach(function(e){if(!t.intersects(e.getBounds()))return e.setOutOfBounds(!0)}),e.keptFeatures.clear()}),this.map.subscribe("zoom_changed",function(){var t,n,r,i;r=e._requestQueue,i=[];for(t in r)n=r[t],i.push(n!=null?n.abort():void 0);return i})},t.prototype.releaseTile=function(e){var t,n=this;if(this.enabled===!1)return;if(this.fetchedTiles[e.addr])return t=this.map.getBounds(),this.map.data.when(this.fetchedTiles[e.addr].features).then(function(e){return e.forEach(function(e){if(e.getBounds){if(!t.intersects(e.getBounds()))return e.setOutOfBounds(!0);if(!t.contains(e.getBounds().getNorthEast()||!t.contains(e.getBounds().getSouthWest())))return n.keptFeatures.push(e),e.setOutOfBounds(!1)}else if(e.getPosition&&!t.contains(e.getPosition()))return e.setOutOfBounds(!0)})})},t.prototype.getTile=function(e,t,n){var r,i,s,o=this;return s=n.createElement("DIV"),r=this.getAddrLatLng(e,t),s.addr=r,this.enabled===!1||this.map.options.ajax===!1?(this.map.publish("features_request_completed"),s):(i=new Date,this.fetchedTiles[r]&&i-this.fetchedTiles[r].date<=this.expiration?(this.fetchedTiles[r].features.setOutOfBounds(!1),s):(this.openConnections===0&&this.map.publish("features_request_started"),this.openConnections++,this.map.publish("features_request_queued"),this._requestQueue[r]=$.ajax({url:this.getUrl(e,t),dataType:"json",type:"GET",success:function(e){var t;return t=o.map.data.deferred(),o._addrs.push(r),o.fetchedTiles[r]={geojson:e,features:t.promise(),date:new Date}},error:function(e,t){var n,r;if(t==="abort")return;return typeof console!="undefined"&&console!==null&&console.error("[provider - ajax error] "+t),r=$("#server-error"),r.parent().length===0&&(r=$("<div>").attr("id","server-error"),$("body").append(r)),n=$("<div>").html(e.responseText),r.append(n)},complete:function(){var e,t,n;o.map.publish("features_request_unqueued"),o.openConnections--;if(o.openConnections===0){o.map.publish("features_request_completed");while(o._addrs.length>0)r=o._addrs.pop(),e=o.fetchedTiles[r].geojson,t=o.map.loadGeoJSON(JSON.parse(e),!1,!0,!0),t.setOutOfBounds(!1),t.show(),typeof (n=o.fetchedTiles[r].features).resolve=="function"&&n.resolve(t),o.fetchedTiles[r].features=t;return o._requestQueue[r]=void 0,o.map.publish("features_loaded",o.map.getFeatures())}}}),s))},t}(n),i=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.getUrl=function(e,n){var r,i,s,o,u;r=t.__super__.getUrl.call(this,e,n),o=[],u=this.map.featureTypes;for(s in u)i=u[s],(this.map.getProjectId()!=null||s==="Community"||i.minZoomPoint<=n&&i.maxZoomPoint>=n||i.minZoomGeometry<=n&&i.maxZoomGeometry>=n)&&o.push(""+i.appLabel+"."+i.modelName);return r+="&models="+o.join(",")},t}(r),window.komoo.providers={GenericProvider:n,TileFeatureProvider:r,ZoomFilteredFeatureProvider:i,makeFeatureProvider:function(e){return new FeatureProvider(e)}},window.komoo.providers});