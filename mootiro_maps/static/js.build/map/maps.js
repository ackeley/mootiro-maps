var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},__indexOf=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};define(["require","googlemaps","underscore","./core","./collections","./features","./layers","./geometries","./controls","./maptypes","./providers"],function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g;return h=e("googlemaps"),d=e("underscore"),f=e("./core"),a=e("./collections"),l=e("./features"),p=e("./layers"),c=e("./geometries"),e("./controls"),e("./maptypes"),e("./providers"),(m=window.komoo)==null&&(window.komoo={}),(g=(v=window.komoo).event)==null&&(v.event=h.event),i=function(e){function t(e){var n;this.options=e!=null?e:{},this.addFeature=__bind(this.addFeature,this),t.__super__.constructor.call(this),this.element=(n=this.options.element)!=null?n:document.getElementById(this.options.elementId),this.features=a.makeFeatureCollectionPlus({map:this}),this.components={},this.setProjectId(this.options.projectId),this.initGoogleMap(this.options.googleMapOptions),this.initLayers(),this.initFeatureTypes(),this.handleEvents(),this.addComponents(["map/controls::Location",["map/controls::LayersBox","panel",{el:"#map-panel-layers"}],"map/controls::LayersFilter"])}return __extends(t,e),t.prototype.featureTypesUrl="/map_info/feature_types/",t.prototype.layersUrl="/map_info/layers/",t.prototype.projectUrl="/map_info/project/",t.prototype.googleMapDefaultOptions={zoom:12,center:new h.LatLng(-23.55,-46.65),disableDefaultUI:!1,streetViewControl:!0,scaleControl:!0,panControlOptions:{position:h.ControlPosition.RIGHT_TOP},zoomControlOptions:{position:h.ControlPosition.RIGHT_TOP},scaleControlOptions:{position:h.ControlPosition.RIGHT_BOTTOM,style:h.ScaleControlStyle.DEFAULT},mapTypeControlOptions:{mapTypeIds:[h.MapTypeId.ROADMAP,h.MapTypeId.HYBRID]},mapTypeId:h.MapTypeId.HYBRID},t.prototype.addControl=function(e,t){return this.googleMap.controls[e].push(t)},t.prototype.loadGeoJsonFromOptions=function(){var e,t;if(this.options.geojson)return t=this.loadGeoJSON(this.options.geojson,this.options.zoom==null),e=t.getBounds(),e!=null&&this.projectInfo==null&&this.fitBounds(e),t!=null&&t.setMap(this,{geometry:!0,icon:!0}),this.publish("set_zoom",this.options.zoom)},t.prototype.initGoogleMap=function(e){return e==null&&(e=this.googleMapDefaultOptions),this.googleMap=new h.Map(this.element,e),this.handleGoogleMapEvents(),$(this.element).trigger("initialized",this)},t.prototype.handleGoogleMapEvents=function(){var e,t=this;return e=["click","idle","maptypeid_changed","zoom_changed"],e.forEach(function(e){return komoo.event.addListener(t.googleMap,e,function(n){return t.publish(e,n)})})},t.prototype.initFeatureTypes=function(){var e,t,n=this;return(e=this.featureTypes)==null&&(this.featureTypes={}),this.options.featureTypes!=null?((t=this.options.featureTypes)!=null&&t.forEach(function(e){return n.featureTypes[e.type]=e}),this.loadGeoJsonFromOptions()):$.ajax({url:this.featureTypesUrl,dataType:"json",success:function(e){return e.forEach(function(e){return n.featureTypes[e.type]=e}),n.loadGeoJsonFromOptions()}})},t.prototype.initLayers=function(){var e,t;return(e=this.layers)==null&&(this.layers=new p.Layers),this.layers.setMap(this),this.options.layers!=null?this.loadLayersFromOptions(this.options):this.loadRemoteLayers(this.layersUrl+((t=this.getProjectId())!=null?t:""))},t.prototype.loadLayer=function(e){var t;return t=this.layers.loadLayer(e),this.publish("layer_loaded",t),t},t.prototype.loadLayers=function(e){var t,n=this;return t=[],e.forEach(function(e){return t.push(n.loadLayer(e))}),t},t.prototype.loadLayersFromOptions=function(e){return this.loadLayers(e.layers)},t.prototype.loadRemoteLayers=function(e){var t=this;return $.ajax({url:e,dataType:"json",success:function(e){return t.loadLayers(e)}})},t.prototype.getLayers=function(){return this.layers},t.prototype.getLayer=function(e){return this.layers.getLayer(e)},t.prototype.showLayer=function(e){return d.isString(e)&&(e=this.getLayer(e)),e.show(),this.publish("show_layer",e)},t.prototype.hideLayer=function(e){return d.isString(e)&&(e=this.getLayer(e)),e.hide(),this.publish("hide_layer",e)},t.prototype.handleEvents=function(){var e=this;return this.subscribe("features_loaded",function(t){return komoo.event.trigger(e,"features_loaded",t)}),this.subscribe("close_clicked",function(){return komoo.event.trigger(e,"close_click")}),this.subscribe("drawing_started",function(t){return komoo.event.trigger(e,"drawing_started",t)}),this.subscribe("drawing_finished",function(t,n){komoo.event.trigger(e,"drawing_finished",t,n);if(n===!1)return e.revertFeature(t);if(t.getProperty("id")==null)return e.addFeature(t)}),this.subscribe("set_location",function(t){var n;return t=t.split(","),n=new h.LatLng(t[0],t[1]),e.googleMap.setCenter(n)}),this.subscribe("set_zoom",function(t){return e.setZoom(t)}),this.subscribe("idle",function(t){return e.getFeatures().setVisible(!0)})},t.prototype.addComponent=function(e,t,n){var r,i=this;return t==null&&(t="generic"),n==null&&(n={}),r=d.isString(e)?this.start(e,n.el,n):this.start(e),this.data.when(r).done(function(){var e,n,r,s,o,u;u=[];for(r=0,s=arguments.length;r<s;r++)e=arguments[r],e.setMap(i),(o=(n=i.components)[t])==null&&(n[t]=[]),i.components[t].push(e),u.push(typeof e.enable=="function"?e.enable():void 0);return u})},t.prototype.addComponents=function(e){var t,n,r,i,s,o,u,a,f=this;n=[];for(i=0,s=e.length;i<s;i++)t=e[i],d.isString(t)&&(t=[t]),r=(o=t[2])!=null?o:{},(u=r.type)==null&&(r.type=(a=t[1])!=null?a:"generic"),n.push({component:t[0],el:r.el,opts:r});return this.data.when(this.start(n)).done(function(){var e,t,n,r,i,s,o;o=[];for(n=0,r=arguments.length;n<r;n++)e=arguments[n],typeof e.setMap=="function"&&e.setMap(f),(s=(t=f.components)[i=e.type])==null&&(t[i]=[]),f.components[e.type].push(e),o.push(typeof e.enable=="function"?e.enable():void 0);return o})},t.prototype.enableComponents=function(e){var t,n=this;return(t=this.components[e])!=null?t.forEach(function(e){return typeof e.enable=="function"?e.enable():void 0}):void 0},t.prototype.disableComponents=function(e){var t,n=this;return(t=this.components[e])!=null?t.forEach(function(e){return typeof e.disable=="function"?e.disable():void 0}):void 0},t.prototype.getComponentsStatus=function(e){var t,n,r=this;return t=[],(n=this.components[e])!=null&&n.forEach(function(e){if(e.enabled===!0)return t.push("enabled")}),__indexOf.call(t,"enabled")>=0?"enabled":"disabled"},t.prototype.clear=function(){return this.features.removeAllFromMap(),this.features.clear()},t.prototype.refresh=function(){var e;return h.event.trigger(this.googleMap,"resize"),(e=this.layers)!=null?e.refresh():void 0},t.prototype.saveLocation=function(e,t){return e==null&&(e=this.googleMap.getCenter()),t==null&&(t=this.getZoom()),this.publish("save_location",e,t)},t.prototype.goToSavedLocation=function(){return this.publish("goto_saved_location"),!0},t.prototype.goToUserLocation=function(){return this.publish("goto_user_location")},t.prototype.handleFeatureEvents=function(e){var t,n=this;return t=["mouseover","mouseout","mousemove","click","dblclick","rightclick","highlight_changed"],t.forEach(function(t){return komoo.event.addListener(e,t,function(r){return n.publish("feature_"+t,r,e)})})},t.prototype.goTo=function(e,t){return t==null&&(t=!0),this.publish("goto",e,t)},t.prototype.panTo=function(e,t){return t==null&&(t=!1),this.goTo(e,t)},t.prototype.makeFeature=function(e,t){var n;return t==null&&(t=!0),n=l.makeFeature(e,this.featureTypes),t&&this.addFeature(n),this.publish("feature_created",n),n},t.prototype.addFeature=function(e){return this.handleFeatureEvents(e),this.features.push(e),this.publish("feature_added",e)},t.prototype.revertFeature=function(e){if(e.getProperty("id")==null)return e.setMap(null)},t.prototype.getFeatures=function(){return this.features},t.prototype.showFeatures=function(e){return e==null&&(e=this.features),e.show()},t.prototype.hideFeatures=function(e){return e==null&&(e=this.features),e.hide()},t.prototype.centerFeature=function(e,t){var n;return n=e instanceof l.Feature?e:this.features.getById(e,t),this.panTo(n!=null?n.getCenter():void 0,!1)},t.prototype.loadGeoJson=function(e,t,n,r){var i,s,o=this;return t==null&&(t=!1),n==null&&(n=!0),r==null&&(r=!1),i=a.makeFeatureCollection({map:this}),(e!=null?e.type:void 0)==null||!e.type==="FeatureCollection"?i:((s=e.features)!=null&&s.forEach(function(e){var t;t=o.features.getById(e.properties.type,e.properties.id),t==null&&(t=o.makeFeature(e,n)),i.push(t),t.setVisible(!0);if(n)return t.setMap(o)}),t&&i.getBounds()!=null&&this.fitBounds(),r||this.publish("features_loaded",i),i)},t.prototype.loadGeoJSON=function(e,t,n,r){return this.loadGeoJson(e,t,n,r)},t.prototype.getGeoJson=function(e){var t,n,r,i;return e==null&&(e={}),(n=e.newOnly)==null&&(e.newOnly=!1),(r=e.currentOnly)==null&&(e.currentOnly=!1),(i=e.geometryCollection)==null&&(e.geometryCollection=!1),t=e.newOnly?this.newFeatures:e.currentOnly?a.makeFeatureCollection({map:this.map,features:[this.currentFeature]}):this.features,t.getGeoJson({geometryCollection:e.geometryCollection})},t.prototype.getGeoJSON=function(e){return this.getGeoJson(e)},t.prototype.drawNewFeature=function(e,t){var n;return n=this.makeFeature({type:"Feature",geometry:{type:e},properties:{name:"New "+t,type:t}}),this.publish("draw_feature",e,n)},t.prototype.editFeature=function(e,t){return e==null&&(e=this.features.getAt(0)),t!=null&&e.getGeometryType()===c.types.EMPTY?(e.setGeometry(c.makeGeometry({geometry:{type:t}})),this.publish("draw_feature",t,e)):this.publish("edit_feature",e)},t.prototype.setMode=function(e){return this.mode=e,this.publish("mode_changed",this.mode)},t.prototype.selectCenter=function(e,t){return this.selectPerimeter(e,t)},t.prototype.selectPerimeter=function(e,t){return this.publish("select_perimeter",e,t)},t.prototype.highlightFeature=function(){return this.centerFeature.apply(this,arguments),this.features.highlightFeature.apply(this.features,arguments)},t.prototype.getBounds=function(){return this.googleMap.getBounds()},t.prototype.getZoom=function(){return this.googleMap.getZoom()},t.prototype.setZoom=function(e){if(e!=null)return this.googleMap.setZoom(e)},t.prototype.getCenter=function(){var e;return e=this.googleMap.getCenter(),[e.lat(),e.lng()]},t.prototype.setMapType=function(e){return this.googleMap.setMapTypeId(e)},t.prototype.getMapType=function(){return this.googleMap.getMapTypeId()},t.prototype.getMapTypeId=function(){return this.googleMap.getMapTypeId()},t.prototype.fitBounds=function(e,t){var n,r,i,s,o,u,a,f,l,c,p;return t==null&&(t=!1),e||(this.projectInfo?this.projectInfo.custom_bbox!=null?(e=(p=this.projectInfo.custom_bbox)!=null?p:this.projectInfo.bbox,t=!0):e=this.projectInfo.bbox:e=this.features.getBounds()),d.isArray(e)&&(c=new h.LatLng(e[1],e[0]),l=new h.LatLng(e[3],e[2]),e=new h.LatLngBounds(c,l)),t&&(c=e.getSouthWest(),l=e.getNorthEast(),o=c.lat(),a=c.lng(),u=l.lat(),f=l.lng(),i=(a-f)/2,s=(o-u)/2,n=(a+f)/2,r=(o+u)/2,a=n+i/1.4,f=n-i/1.4,o=r+s/1.4,u=r-s/1.4,c=new google.maps.LatLng(o,a),l=new google.maps.LatLng(u,f),e=new google.maps.LatLngBounds(c,l)),this.googleMap.fitBounds(e)},t.prototype.getProjectId=function(){return this.projectId},t.prototype.setProjectId=function(e){return this.projectId=e,this._applyProjectConfig()},t.prototype._applyProjectConfig=function(){var e=this;if(this.projectId==null)return;return $.ajax({url:this.projectUrl+this.projectId,dataType:"json",success:function(t){return e.projectInfo=t,console.log("applying project config"),e.setMapType(t.maptype),t.custom_bbox?e.fitBounds(t.custom_bbox,!0):e.fitBounds(t.bbox)}})},t}(f.Mediator),u=function(e){function t(e){t.__super__.constructor.call(this,e),this.addComponents(["map/controls::AutosaveMapType",["map/maptypes::CleanMapType","mapType"],["map/controls::DrawingManager","drawing"],"map/controls::SearchBox"])}return __extends(t,e),t.prototype.type="editor",t}(i),r=function(e){function t(e){t.__super__.constructor.call(this,e),this.addComponents(["map/controls::AutosaveMapType","map/maptypes::CleanMapType","map/controls::SaveLocation","map/controls::StreetView","map/controls::DrawingManager","map/controls::DrawingControl","map/controls::GeometrySelector","map/controls::PerimeterSelector","map/controls::SearchBox"])}return __extends(t,e),t.prototype.type="view",t}(i),s=function(e){function t(e){t.__super__.constructor.call(this,e),e.projectId!=null&&this.addComponents([["map/maptypes::CleanMapType","mapType"]])}return __extends(t,e),t.prototype.type="preview",t.prototype.googleMapDefaultOptions={zoom:12,center:new h.LatLng(-23.55,-46.65),disableDefaultUI:!0,streetViewControl:!1,scaleControl:!0,scaleControlOptions:{position:h.ControlPosition.RIGHT_BOTTOM,style:h.ScaleControlStyle.DEFAULT},mapTypeId:h.MapTypeId.HYBRID},t}(i),o=function(e){function t(e){t.__super__.constructor.call(this,e),this.addComponents(["map/controls::AutosaveMapType",["map/maptypes::CleanMapType","mapType"],"map/controls::AutosaveLocation","map/controls::StreetView",["map/controls::Tooltip","tooltip"],["map/controls::InfoWindow","infoWindow"],"map/controls::LicenseBox","map/controls::SearchBox"])}return __extends(t,e),t.prototype.type="view",t}(i),n=function(e){function t(e){t.__super__.constructor.call(this,e),this.addComponents(["map/controls::LoadingBox",["map/providers::ZoomFilteredFeatureProvider","provider"],["map/controls::CommunityClusterer","clusterer",{map:this}],"map/controls::FeatureZoomFilter"])}return __extends(t,e),t.prototype.type="view",t}(o),t=function(e){function t(e){t.__super__.constructor.call(this,e),this.addComponents(["map/controls::DrawingManager","map/controls::DrawingControl","map/controls::GeometrySelector","map/controls::PerimeterSelector"]),this.goToSavedLocation()||this.goToUserLocation()}return __extends(t,e),t.prototype.type="editor",t}(n),window.komoo.maps={Map:i,Preview:s,AjaxMap:n,makeMap:function(e){var n,i;e==null&&(e={}),n=(i=e.type)!=null?i:"map";if(n==="main")return new t(e);if(n==="editor")return new r(e);if(n==="view")return new o(e);if(n==="static")return new o(e);if(n==="preview"||n==="tooltip")return new s(e);if(n==="userEditor")return new u(e)}},window.komoo.maps});