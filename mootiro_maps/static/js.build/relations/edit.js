(function(){function e(e){if(!e||e.length===0)return!1;var t=/^(\d{2})[-\/](\d{2})[-\/](\d{4})$/.exec(e);if(t==null)return!1;var n=t[1],r=t[2]-1,i=t[3],s=new Date(i,r,n);return s.getDate()==n&&s.getMonth()==r&&s.getFullYear()==i}function t(e){return!isNaN(parseFloat(e))}var n=function(e){return{container:e,init:function(){return this.input=this.container.find(".target_autocomplete"),this.field=this.container.find(".target"),this.dropdown=this.container.find("select[name=relation_type]"),this.metadataBtn=this.container.find(".metadata-btn"),this.metadataForm=this.container.find(".metadata-form"),this.startPlugin(),this},onFocus:function(e,t){return e.input.val(t.item.label),!1},onSelect:function(e,t){return e.input.val(t.item.label),e.field.val(t.item.value),!1},onChange:function(e,t){if(!t.item||!e.input.val())e.field.val(""),e.input.val("")},startPlugin:function(){var e=this;e.input.autocomplete({source:e.input.attr("data-autocomplete"),focus:function(t,n){return e.onFocus(e,n)},select:function(t,n){return e.onSelect(e,n)},change:function(t,n){return e.onChange(e,n)}})},loadValues:function(e){this.input.val(e.target_name),this.field.val(e.target_oid),this.dropdown.find('option[value="'+e.direction+e.rel_type+'"]').attr("selected","selected"),this.metadataForm.find("[name=metadata_description]").val(e.metadata.description||""),this.metadataForm.find("[name=metadata_start_date]").val(e.metadata.start_date||""),this.metadataForm.find("[name=metadata_end_date]").val(e.metadata.end_date||""),this.metadataForm.find("[name=metadata_value]").val(e.metadata.value||"")}}},r=function(){return{init:function(){this.relationsList=$(".relations-edit .relations-list"),this.relationTpl=$("#relation-item-tpl").html(),this.addButton=$(".add-relation"),this.input=$(".relations-edit input[name='relations_json']"),this.submitBtn=$(".relations-edit input[type='submit']"),this.bindEvents(),this.loadInitialData(),this.addNewRelation()},loadInitialData:function(){var e=this,t=e.relationsList.data("relations");_.each(t,function(t){var n=e.addNewRelation();n.loadValues(t)})},addNewRelation:function(){var e=this,t=$(e.relationTpl);return this.relationsList.append(t),n(t).init()},onRemove:function(e,t){t.closest(".relation-item").remove(),e.updateInput(e)},onClickMetadata:function(e,t){var n=t.find("i"),r=t.closest(".relation-item").find(".metadata-form");n.is(".icon-plus")?(n.removeClass("icon-plus").addClass("icon-minus"),r.slideDown()):(n.removeClass("icon-minus").addClass("icon-plus"),r.slideUp())},validateDateInput:function(t,n){var r=n.val();!r||r.length===0||e(r)?(n.removeClass("error"),n.closest(".date-field").find(".error-msg").slideUp(),$(".relations-edit .error").length===0&&t.submitBtn.removeAttr("disabled")):(n.addClass("error"),n.closest(".date-field").find(".error-msg").slideDown(),t.submitBtn.attr("disabled","disable"))},validateNumberInput:function(e,n){var r=n.val();!r||r.lenght===0||t(r)?(n.removeClass("error"),n.closest(".number-field").find(".error-msg").slideUp(),$(".relations-edit .error").length===0&&e.submitBtn.removeAttr("disabled")):(n.addClass("error"),n.closest(".number-field").find(".error-msg").slideDown(),e.submitBtn.attr("disabled","disable"))},updateInput:function(n){var r=[];n.relationsList.find(".relation-item").each(function(n,i){var s=$(i),o=s.find("[name=relation_type]").val(),u=s.find(".target").val();if(u&&u.length>0&&o&&o.length>0){var a=s.find("[name=metadata_start_date]").val();a=e(a)?a:null;var f=s.find("[name=metadata_end_date]").val();f=e(f)?f:null;var l=s.find("[name=metadata_value]").val();l=t(l)?l:null;var c={description:s.find("[name=metadata_description]").val()||null,start_date:a,end_date:f,value:l};r.push({direction:o[0],rel_type:o.substring(1,o.length),target:u,metadata:c})}}),n.input.val(JSON.stringify(r))},bindEvents:function(){var e=this;e.addButton.click(function(){e.addNewRelation()}),$(".relations-edit .remove-btn").live("click",function(t){e.onRemove(e,$(t.target))}),$(".relations-edit .metadata-btn").live("click",function(t){var n=$(t.target),r=n.is("i")?n.parent():n;e.onClickMetadata(e,r)}),$(".date-input").live("change",function(t){e.validateDateInput(e,$(t.target))}),$(".number-input").live("change",function(t){e.validateNumberInput(e,$(t.target))}),$(".relations-edit form").submit(function(t){e.updateInput(e)})}}};$(function(){r().init()})})();