/**
 * MultiMarker for Google Maps.
 *
 * @name multimarker.js
 * @fileOverview Group Google Maps Markers together.
 * @version 0.1.0
 * @author Luiz Armesto
 * @copyright (c) 2012 it3s
 */

/**
 * MultiPolyline for Google Maps.
 *
 * @name multipolyline.js
 * @fileOverview Group Google Maps Polylines together.
 * @version 0.1.0
 * @author Luiz Armesto
 * @copyright (c) 2012 it3s
 */

/**
 * @license RequireJS text 2.0.3 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/text for details
 */

(function(){define("googlemaps",["goog!maps,3,other_params:[sensor=false&libraries=drawing&language="+(KomooNS.lang||"en")+"]"],function(){return google.maps})}).call(this),function(){var e=Array.prototype.indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1},t=Array.prototype.slice;define("map/core",["require","jquery","underscore","backbone"],function(n){var r,i,s,o,u;return r=n("jquery"),u=n("underscore"),i=n("backbone"),s=function(){function s(){this._components={},this._hooks={},this._pubQueue=[],this._pubsub={},u.extend(this._pubsub,i.Events)}return s.prototype.loading=0,s.prototype.data={deferred:r.Deferred,when:r.when},s.prototype._getComponent=function(e,t){var n,r;n=(r=this._components[e])!=null?r:{};if(n[t]==null)throw new Error("Could not be found a component '"+e+"' with id '"+t+"'");return n[t]},s.prototype._removeComponent=function(e,t){var n;return(n=this._components[e])!=null?delete n[t]:void 0},s.prototype.registerHook=function(t,n,r){var i;r==null&&(r=null),(i=this._hooks)[t]==null&&(i[t]=[]);if(!(e.call(this._hooks[t],n)>=0))return this._hooks[t].push(u.bind(n,r))},s.prototype.unregisterHook=function(e,t){},s.prototype.triggerHooks=function(){var e,n,r,i,s,o,u,a;e=arguments[0],r=2<=arguments.length?t.call(arguments,1):[],a=(u=this._hooks[e])!=null?u:[];for(s=0,o=a.length;s<o;s++)n=a[s],i=n.apply(null,r),r=i;return r},s.prototype.load=function(e,t,r){var i,s,o,u,a,f=this;return a=t,o=e.split("::"),i=o[0],s=o[1],u=this.data.deferred(),n([i],function(n){var i,o;i=n[s];try{o=new i(f,t)}catch(l){typeof console!="undefined"&&console!==null&&console.error(l.message),typeof console!="undefined"&&console!==null&&console.warn("Could not initialize component '"+e+"'"),u.resolve();return}return o.type=r.type,f.data.when(o.init(r)).done(function(){var t,n,r;f._components[e][a].instance=o,r=o.hooks;for(t in r)n=r[t],o[n]!=null&&f.registerHook(t,o[n],o);return typeof console!="undefined"&&console!==null&&console.log("Component '"+e+"' initialized"),f.publish(""+s+":started",a),u.resolve(o)}).fail(function(){return typeof console!="undefined"&&console!==null&&console.warn("Could not initialize component '"+e+"'"),u.resolve(o)})},function(t){var r;return t.requireType==="timeout"?typeof console!="undefined"&&console!==null&&console.warn("Could not load module '"+t.requireModules+"'"):(r=t.requireModules&&t.requireModules[0],n.undef(r),typeof console!="undefined"&&console!==null&&console.error(t.message),typeof console!="undefined"&&console!==null&&console.warn("Could not initialize component '"+e+"'")),u.resolve()}),u.promise()},s.prototype.unload=function(e){},s.prototype.start=function(e,t,n){var i,s,o,a,f,l,c,h,p,d,v,m=this;n==null&&(n={}),u.isString(e)?s=[{component:e,el:t,opts:n}]:u.isArray(e)?s=e:s=[e];if(!u.isArray(s))throw new Error("componentList must be defined as an array");c=[];for(d=0,v=s.length;d<v;d++)l=s[d],i=l.component,t=l.el,n=l.opts,this.loading++,f=t,(p=this._components)[i]==null&&(p[i]={}),o=this._components[i],o[f]!=null&&typeof console!="undefined"&&console!==null&&console.error("Conflict: already exists one component '"+i+"' with id '"+f+"' "),this._components[i][f]={el:t,opts:n},a=this.data.deferred(),c.push(this.load(i,t,n));return h=this.data.when.apply(r,c),h.done(function(){return m.loading-=arguments.length,m._processPublishQueue()}),h},s.prototype.stop=function(e,t){var n,i,s,o,a,f,l,c,h;a=t,f=u.isArray(a)?a:[a],s=this.data.deferred(),l=f.length,o=0;for(c=0,h=f.length;c<h;c++)n=f[c],i=this._getComponent(e,n),i.instance.destroy().done(function(){r(i.el).children().remove(),this._removeComponent(e,n),o++;if(o===l)return s.resolve()});return s.promise()},s.prototype.publish=function(e){return this._addToPublishQueue.apply(this,arguments),this._processPublishQueue()},s.prototype.subscribe=function(e,t,n){return this._pubsub.on(e,t,n)},s.prototype._addToPublishQueue=function(e){return this._pubQueue.push(arguments)},s.prototype._processPublishQueue=function(){var e;if(this.loading>0)return!1;e=this._pubQueue.shift();if(e!=null)return this._pubsub.trigger.apply(this._pubsub,e),this._processPublishQueue()},s}(),o={Mediator:s},o})}.call(this);var __slice=[].slice,__indexOf=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};define("map/collections",["require","googlemaps"],function(e){var t,n,r,i,s,o,u;return i=e("googlemaps"),(o=window.komoo)==null&&(window.komoo={}),(u=(s=window.komoo).event)==null&&(s.event=i.event),r=function(){function e(e){this.options=e!=null?e:{},this.elements=[],this.length=0}return e.prototype.updateLength=function(){return this.length=this.elements.length,this.first=this.elements[0],this.last=this.elements[this.length-1]},e.prototype.clear=function(){return this.elements=[],this.updateLength()},e.prototype.getAt=function(e){return this.elements[e]},e.prototype.push=function(e){return this.elements.push(e),this.updateLength()},e.prototype.pop=function(){var e;return e=this.elements.pop(),this.updateLength(),e},e.prototype.remove=function(){var e,t,n,r,i,s;t=1<=arguments.length?__slice.call(arguments,0):[],r=[];for(i=0,s=t.length;i<s;i++)e=t[i],n=this.elements.indexOf(e),n!==-1&&r.push(this.elements.splice(n,1));return t.length===1&&(r=r[0]),this.updateLength(),r},e.prototype.isEmpty=function(){return this.elements.length===0},e.prototype.forEach=function(e,t){return this.elements.forEach(e,t)},e.prototype.getArray=function(){return this.elements},e.prototype.slice=function(e,t){return this.elements.slice(e,t)},e.prototype.filter=function(e,t){var n,r;return r=[],this.elements.filter!=null?this.elements.filter!=null&&(r=this.elements.filter(e,t)):this.forEach(function(n){if(e.apply(t,[n]))return r.push(n)}),n=new this.constructor,n.elements=r,n.updateLength(),n},e.prototype.sort=function(e){return this.elements.sort(e)},e.prototype.contains=function(e){return __indexOf.call(this.elements,e)>=0},e}(),t=function(e){function t(e){var n,r=this;e==null&&(e={}),t.__super__.constructor.call(this,e),e.map&&this.setMap(e.map),(n=e.features)!=null&&n.forEach(function(e){return r.push(e)})}return __extends(t,e),t.prototype.push=function(e){if(e==null)return;return t.__super__.push.call(this,e),e.setMap(this.map)},t.prototype.getBounds=function(){var e,t,n,r=this;return e=this.getAt(0),e&&e.getGeometryType()!=="Empty"&&(t=e.getGeometry(),n=t.getLatLngFromArray(t.getCenter()),this.bounds=new i.LatLngBounds(n,n),this.forEach(function(e){var t;if(e.getGeometryType()!=="Empty")return(t=r.bounds)!=null?t.union(e.getBounds()):void 0})),this.bounds},t.prototype.setOutOfBounds=function(e){return this.forEach(function(t){return t.setOutOfBounds(e)})},t.prototype.setMap=function(e,t){var n,r=this;return this.map=e,n=null,this.forEach(function(e){return t!=null&&(n={geometry:t!=null?t.geometry:void 0,point:t!=null?t.icon:void 0,icon:t!=null?t.icon:void 0}),e.getType()==="Community"&&n!=null&&(n.point=!1),e!=null?e.setMap(r.map,n):void 0}),this.handleMapEvents()},t.prototype.show=function(){return this.setMap(this.map,{geometry:!0}),this.setVisible(!0)},t.prototype.hide=function(){return this.setVisible(!1)},t.prototype.getGeoJson=function(e){var t,n;return(n=e.geometryCollection)==null&&(e.geometryCollection=!1),e.geometryCollection?(t={type:"GeometryCollection",geometries:[]},this.forEach(function(e){return t.geometries.push(e.getGeometryGeoJson())})):(t={type:"FeatureCollection",features:[]},this.forEach(function(e){return t.features.push(e.getGeoJson())})),t},t.prototype.removeAllFromMap=function(){return this.forEach(function(e){return e.removeFromMap()})},t.prototype.setVisible=function(e){return this.forEach(function(t){return t.setVisible(e)})},t.prototype.updateFeaturesVisibility=function(){return this.forEach(function(e){return e.seMap(e.getMap())})},t.prototype.handleMapEvents=function(){var e=this;return komoo.event.addListener(this.map,"zoom_changed",function(){})},t.prototype.filter=function(e,n){var r;return r=t.__super__.filter.call(this,e,n),r.map=this.map,r},t}(r),n=function(e){function n(e){e==null&&(e={}),n.__super__.constructor.call(this,e),this.featuresByType={}}return __extends(n,e),n.prototype.push=function(e){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b=this;return n.__super__.push.call(this,e),r=e.getType(),(c=(i=this.featuresByType)[r])==null&&(i[r]={}),(h=(s=this.featuresByType[r])["categories"])==null&&(s.categories={}),(p=(o=this.featuresByType[r]["categories"])["all"])==null&&(o.all=new t({map:this.map})),(d=(u=this.featuresByType[r]["categories"])["uncategorized"])==null&&(u.uncategorized=new t({map:this.map})),(v=e.getCategories())!=null&&v.forEach(function(n){var i,s,o;return(o=(i=b.featuresByType[r]["categories"])[s=n.name])==null&&(i[s]=new t({map:b.map})),b.featuresByType[r].categories[n.name].push(e)}),(e.getCategories()==null||e.getCategories().length===0)&&this.featuresByType[r].categories.uncategorized.push(e),this.featuresByType[r].categories.all.push(e),(m=(a=this.featuresByType[r])["ids"])==null&&(a.ids={}),this.featuresByType[r].ids[e.getProperty("id")]=e,(g=(f=this.featuresByType)["all"])==null&&(f.all={}),(y=(l=this.featuresByType["all"])["ids"])==null&&(l.ids={}),this.featuresByType.all.ids[e.getProperty("id")]=e},n.prototype.pop=function(){return n.__super__.pop.call(this)},n.prototype.clear=function(){return this.featuresByType={},n.__super__.clear.call(this)},n.prototype.getByType=function(e,n,r){var i,s=this;return r==null&&(r=!1),this.featuresByType[e]?n?n.length===0?this.featuresByType[e].categories.uncategorized:(i=new t({map:this.map}),n.forEach(function(t){if(s.featuresByType[e].categories[t])return s.featuresByType[e].categories[t].forEach(function(e){if(!r||!e.getCategories()||e.getCategories().length===1)return i.push(e)})}),i):this.featuresByType[e].categories.all:!1},n.prototype.getById=function(e,t){var n;return typeof e!="string"&&(t=e,e="all"),(n=this.featuresByType[e])!=null?n.ids[t]:void 0},n.prototype.highlightFeature=function(e,t){var n,r,i;n=(r=typeof e)==="string"||r==="number"?this.getById(e,t):e;if(n.isHighlighted())return;return(i=this.highlighted)!=null&&i.setHighlight(!1),n.highlight(),this.highlighted=n},n}(t),window.komoo.collections={GenericCollection:r,FeatureCollection:t,FeatureCollectionPlus:n,makeFeatureCollection:function(e){return e==null&&(e={}),new t(e)},makeFeatureCollectionPlus:function(e){return e==null&&(e={}),new n(e)}},window.komoo.collections}),function(){define("map/common",[],function(){return{geometries:{types:{EMPTY:"Empty",POINT:"Point",MULTIPOINT:"MultiPoint",POLYGON:"Polygon",POLYLINE:"LineString",LINESTRING:"LineString",MULTIPOLYLINE:"MultiLineString",MULTILINESTRING:"MultiLineString"}}}})}.call(this),define("map/multimarker",["googlemaps"],function(e){return MultiMarker=function(t){t=t||{},this.markers_=new e.MVCArray(t.markers||[]),this.positions_=new e.MVCArray(t.positions||[]),this.map_=t.map,this.visible_=t.visible,this.clickable_=t.clickable,this.draggable_=t.draggable,this.icon_=t.icon,this.zIndex=t.zIndex||0},MultiMarker.prototype.getPosition=function(){var e;return(e=this.markers_.getAt(0))?e.getPosition():null},MultiMarker.prototype.getPositions=function(){this.positions_.clear();for(var e=0;e<this.markers_.getLength();e++)this.positions_.push(this.markers_.getAt(e).getPosition());return this.positions_},MultiMarker.prototype.setPositions=function(e){if(e.length!=this.markers_.getLength())throw"Invalid length.";this.positions_.clear();for(var t=0;t<this.markers_.getLength();t++)this.markers_.getAt(t).setPosition(e[t]),this.positions_.push(e[t])},MultiMarker.prototype.addMarker=function(t,n){var r=this;this.markers_.push(t),n||this.icon_&&t.setIcon(this.icon_),e.event.addListener(t,"click",function(n){e.event.trigger(r,"click",n,t)}),e.event.addListener(t,"mouseover",function(n){e.event.trigger(r,"mouseover",n,t)}),e.event.addListener(t,"mouseout",function(n){e.event.trigger(r,"mouseout",n,t)}),e.event.addListener(t,"mousemove",function(n){e.event.trigger(r,"mousemove",n,t)})},MultiMarker.prototype.addMarkers=function(e,t){for(var n=0;n<e.length;n++)this.addMarker(e[n],t)},MultiMarker.prototype.getMarkers=function(){return this.markers_},MultiMarker.prototype.setDraggable=function(e){for(var t=0;t<this.markers_.getLength();t++)this.markers_.getAt(t).setDraggable(e);this.draggable_=e},MultiMarker.prototype.getDraggable=function(){return this.draggable_},MultiMarker.prototype.setMap=function(e){for(var t=0;t<this.markers_.getLength();t++)this.markers_.getAt(t).setMap(e);this.map_=e},MultiMarker.prototype.getMap=function(){return this.map_},MultiMarker.prototype.setIcon=function(e){for(var t=0;t<this.markers_.getLength();t++)this.markers_.getAt(t).setIcon(e);this.icon_=e},MultiMarker.prototype.getIcon=function(){return this.icon_},MultiMarker.prototype.setVisible=function(e){for(var t=0;t<this.markers_.getLength();t++)this.markers_.getAt(t).setVisible(e);this.visible_=e},MultiMarker.prototype.getVisible=function(){return this.visible_},MultiMarker}),define("map/multipolyline",["googlemaps"],function(e){return MultiPolyline=function(t){t=t||{},this.polylines_=new e.MVCArray(t.polylines||[]),this.paths_=new e.MVCArray(t.paths||[]),this.map_=t.map,this.visible_=t.visible,this.clickable_=t.clickable,this.zIndex=t.zIndex||0,this.strokeColor_=t.strokeColor||"black",this.strokOpacity_=t.strokeOpacity||1,this.strokeWeight_=t.strokeWeight||3},MultiPolyline.prototype.getPaths=function(){this.paths_.clear();for(var e=0;e<this.polylines_.getLength();e++)this.paths_.push(this.polylines_.getAt(e).getPath());return this.paths_},MultiPolyline.prototype.setPaths=function(e){if(e.length!=this.polylines_.getLength())throw"Invalid length.";this.paths_.clear();for(var t=0;t<this.polylines_.getLength();t++)this.polylines_.getAt(t).setPath(e[t]),this.paths_.push(e[t])},MultiPolyline.prototype.addPolyline=function(t,n){var r=this;this.polylines_.push(t),n!=1&&t.setOptions({clickable:this.clickable_,zIndex:this.zIndex,strokeColor:this.strokeColor_,strokeOpacity:this.strokOpacity_,strokeWeight:this.strokeWeight_}),e.event.addListener(t,"click",function(n){e.event.trigger(r,"click",n,t)}),e.event.addListener(t,"mouseover",function(n){e.event.trigger(r,"mouseover",n,t)}),e.event.addListener(t,"mouseout",function(n){e.event.trigger(r,"mouseout",n,t)}),e.event.addListener(t,"mousemove",function(n){e.event.trigger(r,"mousemove",n,t)})},MultiPolyline.prototype.addPolylines=function(e,t){for(var n=0;n<e.length;n++)this.addPolyline(e[n],t)},MultiPolyline.prototype.getPolylines=function(){return this.polylines_},MultiPolyline.prototype.setMap=function(e){for(var t=0;t<this.polylines_.getLength();t++)this.polylines_.getAt(t).setMap(e);this.map_=e},MultiPolyline.prototype.getMap=function(){return this.map_},MultiPolyline.prototype.setVisible=function(e){for(var t=0;t<this.polylines_.getLength();t++)this.polylines_.getAt(t).setVisible(e);this.visible_=e},MultiPolyline.prototype.setEditable=function(e){for(var t=0;t<this.polylines_.getLength();t++)this.polylines_.getAt(t).setEditable(e);this.visible_=e},MultiPolyline.prototype.setOptions=function(e){for(var t=0;t<this.polylines_.getLength();t++)this.polylines_.getAt(t).setOptions(e);this.options_=e},MultiPolyline.prototype.getVisible=function(){return this.visible_},MultiPolyline});var __hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};define("map/geometries",["require","googlemaps","./common","./multimarker","./multipolyline"],function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x;return w=e("googlemaps"),y=e("./common"),e("./multimarker"),e("./multipolyline"),(S=window.komoo)==null&&(window.komoo={}),(x=(E=window.komoo).event)==null&&(E.event=w.event),t=y.geometries.types.EMPTY,h=y.geometries.types.POINT,a=y.geometries.types.MULTIPOINT,p=y.geometries.types.POLYGON,d=y.geometries.types.LINESTRING,i=y.geometries.types.LINESTRING,f=y.geometries.types.MULTILINESTRING,u=y.geometries.types.MULTILINESTRING,o=510072000000001,b={BACKGROUND_COLOR:"#000",BACKGROUND_OPACITY:.6,BORDER_COLOR:"#000",BORDER_OPACITY:.6,BORDER_SIZE:1.5,BORDER_SIZE_HOVER:2.5,ZINDEX:1},r=function(){function e(e){var t;this.options=e!=null?e:{},this.setFeature(this.options.feature),this.area=(t=this.options.area)!=null?t:0,this.initOverlay(this.options)}return e.prototype.initOverlay=function(e){throw"Not Implemented"},e.prototype.refresh=function(e){return this.setOptions(this.getOverlayOptions()),this.updateIcon(e)},e.prototype.getCoordinates=function(){throw"Not Implemented"},e.prototype.setCoordinates=function(e){return komoo.event.trigger(this,"coordinates_changed")},e.prototype.setEditable=function(e){throw"Not Implemented"},e.prototype.initEvents=function(e){var t,n=this;e==null&&(e=this.overlay);if(!e)return;return t=["click","dblclick","mousedown","mousemove","mouseout","mouseover","mouseup","rightclick"],t.forEach(function(t){return komoo.event.addListener(e,t,function(e,r){return komoo.event.trigger(n,t,e,r)})})},e.prototype.calculateBounds=function(){var e,t,n,r,i,s,o,u,a,l,c,h,d,v;s=a=l=n=null,i=function(e){return s==null&&(s=a!=null?a:a=e[0]),l==null&&(l=n!=null?n:n=e[1]),s=Math.max(e[0],s),a=Math.min(e[0],a),l=Math.min(e[1],l),n=Math.max(e[1],n),[[a,l],[s,n]]},t=this.getCoordinates(),r=this.getGeometryType(),r!==p&&r!==f&&(t=[t]);for(c=0,d=t.length;c<d;c++){o=t[c];for(h=0,v=o.length;h<v;h++)u=o[h],e=i(u)}return e!=null&&(this.bounds=new w.LatLngBounds(this.getLatLngFromArray(e[0]),this.getLatLngFromArray(e[1]))),this.bounds},e.prototype.getBounds=function(){return this.bounds!=null?this.bounds:this.calculateBounds()},e.prototype.getCenter=function(){var e,t,n;return this.overlay?this.getArrayFromLatLng((typeof (e=this.overlay).getCenter=="function"?e.getCenter():void 0)||((n=this.getBounds())!=null?n.getCenter():void 0)||(typeof (t=this.overlay).getPosition=="function"?t.getPosition():void 0)):[]},e.prototype.getOverlay=function(){return this.overlay},e.prototype.setOverlay=function(e){return this.overlay=e,this.initEvents()},e.prototype.getFeature=function(){return this.feature},e.prototype.setFeature=function(e){this.feature=e},e.prototype.getGeometryType=function(){return this.geometryType},e.prototype.getDefaultZIndex=function(){var e;return((e=this.feature)!=null?e.getDefaultZIndex():void 0)||b.ZINDEX},e.prototype.getLatLngFromArray=function(e){return e!=null?new w.LatLng(e[0],e[1]):null},e.prototype.getArrayFromLatLng=function(e){return e?[e.lat(),e.lng()]:[]},e.prototype.getLatLngArrayFromArray=function(e){var t,n,r,i;i=[];for(n=0,r=e.length;n<r;n++)t=e[n],i.push(this.getLatLngFromArray(t));return i},e.prototype.getArrayFromLatLngArray=function(e){var t,n,r,i;if(e){i=[];for(n=0,r=e.length;n<r;n++)t=e[n],i.push(this.getArrayFromLatLng(t));return i}return[]},e.prototype.getMap=function(){return this.map},e.prototype.setMap=function(e){var t;return this.map=e,(t=this.overlay)!=null?t.setMap(this.map&&this.map.googleMap?this.map.googleMap:this.map):void 0},e.prototype.getVisible=function(){var e;return(e=this.overlay)!=null?e.getVisible():void 0},e.prototype.setVisible=function(e){var t;return(t=this.overlay)!=null?t.setVisible(e):void 0},e.prototype.setOptions=function(e){var t;return this.options=e,(t=this.overlay)!=null?typeof t.setOptions=="function"?t.setOptions(this.options):void 0:void 0},e.prototype.getIcon=function(){var e;return(e=this.overlay)!=null?typeof e.getIcon=="function"?e.getIcon():void 0:void 0},e.prototype.setIcon=function(e){var t;return(t=this.overlay)!=null?typeof t.setIcon=="function"?t.setIcon(e):void 0:void 0},e.prototype.getIconUrl=function(e){var t;return(t=this.feature)!=null?t.getIconUrl(e):void 0},e.prototype.createIcon=function(e,t){return{path:google.maps.SymbolPath.CIRCLE,scale:5*(t?1.5:1),fillColor:this.getBackgroundColor(),fillOpacity:this.getBackgroundOpacity(),strokeColor:t?1:this.getBorderColor(),strokeOpacity:t?1:this.getBorderOpacity(),strokeWeight:this.getBorderSize()}},e.prototype.updateIcon=function(e){return this.setIcon(this.createIcon(e))},e.prototype.getBorderColor=function(){var e;return((e=this.feature)!=null?e.getBorderColor():void 0)||b.BORDER_COLOR},e.prototype.getBorderOpacity=function(){var e;return((e=this.feature)!=null?e.getBorderOpacity():void 0)||b.BORDER_OPACITY},e.prototype.getBorderSize=function(){var e;return((e=this.feature)!=null?e.getBorderSize():void 0)||b.BORDER_SIZE},e.prototype.getBorderSizeHover=function(){var e;return((e=this.feature)!=null?e.getBorderSizeHover():void 0)||b.BORDER_SIZE_HOVER},e.prototype.getBackgroundColor=function(){var e;return((e=this.feature)!=null?e.getBackgroundColor():void 0)||b.BACKGROUND_COLOR},e.prototype.getBackgroundOpacity=function(){var e;return((e=this.feature)!=null?e.getBackgroundOpacity():void 0)||b.BACKGROUND_OPACITY},e.prototype.getGeoJson=function(){return{type:this.getGeometryType(),coordinates:this.getCoordinates()}},e}(),n=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.geometryType=t,n.prototype.getOverlayOptions=function(e){return{}},n.prototype.initOverlay=function(e){return this.options=e!=null?e:{},!0},n.prototype.getCoordinates=function(){return[]},n.prototype.setEditable=function(e){return!0},n.prototype.getGeoJson=function(){return null},n}(r),v=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.geometryType=h,t.prototype.getOverlayOptions=function(e){var t,n,r;return e==null&&(e={}),{clickable:(t=e.clickable)!=null?t:!0,zIndex:(n=e.zIndex)!=null?n:o,icon:(r=e.icon)!=null?r:this.createIcon(e.zoom)}},t.prototype.initOverlay=function(e){return this.setOverlay(new w.Marker(this.getOverlayOptions(e)))},t.prototype.initEvents=function(e){var n,r=this;return e==null&&(e=this.overlay),t.__super__.initEvents.call(this,e),n=["animation_changed","clickable_changed","cursor_changed","drag","dragend","daggable_changed","dragstart","flat_changed","icon_changed","position_changed","shadow_changed","shape_changed","title_changed","visible_changed","zindex_changed"],n.forEach(function(t){return komoo.event.addListener(e,t,function(e,n){return komoo.event.trigger(r,t,e,n)})})},t.prototype.getCoordinates=function(){return this.getArrayFromLatLng(this.overlay.getPosition())},t.prototype.setCoordinates=function(e){return this.bounds=null,this.overlay.setPosition(this.getLatLngFromArray(e)),t.__super__.setCoordinates.call(this,e)},t.prototype.setEditable=function(e){return this.overlay.setDraggable(e)},t.prototype.getPosition=function(){return this.overlay.getPosition()},t.prototype.setPosition=function(e){return this.overlay.setPosition(e instanceof Array?this.getLatLngFromArray(e):e)},t.prototype.addMarker=function(e){return this.setOverlay(e)},t}(r),c=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.geometryType=a,t.prototype.getOverlayOptions=function(e){var t,n,r;return e==null&&(e={}),{clickable:(t=e.clickable)!=null?t:!0,zIndex:(n=e.zIndex)!=null?n:o,icon:(r=e.icon)!=null?r:this.createIcon(e.zoom)}},t.prototype.initOverlay=function(e){return this.setOverlay(new MultiMarker(this.getOverlayOptions(e)))},t.prototype.getPoints=function(){return this.overlay.getMarkers().getArray()},t.prototype.setPoints=function(e){return this.overlay.addMarkers(e)},t.prototype.guaranteePoints=function(e){var t,n,r,i,s,o,u,a;n=this.overlay.getMarkers();if(n.length>=e){u=[];for(t=r=0,s=n.length-e-1;0<=s?r<=s:r>=s;t=0<=s?++r:--r)u.push(n.pop());return u}a=[];for(t=i=0,o=e-n.length-1;0<=o?i<=o:i>=o;t=0<=o?++i:--i)a.push(this.overlay.addMarker(new w.Marker(this.options)));return a},t.prototype.getCoordinates=function(){var e,t,n,r,i;r=this.getPoints(),i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(this.getArrayFromLatLng(e.getPosition()));return i},t.prototype.setCoordinates=function(e){var n,r,i,s,o;e[0]instanceof Array||(e=[e]),this.guaranteePoints(e.length),this.bounds=null,o=this.getPoints();for(n=i=0,s=o.length;i<s;n=++i)r=o[n],r.setPosition(this.getLatLngFromArray(e[n]));return t.__super__.setCoordinates.call(this,e)},t.prototype.setEditable=function(e){return this.overlay.setDraggable(e)},t.prototype.getPositions=function(){var e,t,n,r,i;r=this.getPoints(),i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(e.getPosition());return i},t.prototype.setPositions=function(e){return this.overlay.setPositions(e)},t.prototype.getMarkers=function(){return this.overlay.getMarkers()},t.prototype.addMarkers=function(e){return this.overlay.addMarkers(e)},t.prototype.addMarker=function(e){return this.overlay.addMarker(e)},t}(r),g=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.geometryType=h,t.prototype.getGeoJson=function(){return{type:a,coordinates:this.getCoordinates()}},t}(c),s=function(e){function t(e){t.__super__.constructor.call(this,e),this.handleEvents()}return __extends(t,e),t.prototype.geometryType=i,t.prototype.getOverlayOptions=function(e){var t,n,r,i,s;return e==null&&(e={}),{clickable:(t=e.clickable)!=null?t:!0,zIndex:(n=e.zIndex)!=null?n:o,strokeColor:(r=e.strokeColor)!=null?r:this.getBorderColor(),strokOpacity:(i=e.strokeOpacity)!=null?i:this.getBorderOpacity(),strokeWeight:(s=e.strokeWeight)!=null?s:this.getBorderSize()}},t.prototype.initOverlay=function(e){return this.setOverlay(new w.Polyline(this.getOverlayOptions(e)))},t.prototype.handleEvents=function(){var e=this;return komoo.event.addListener(this,"mousemove",function(t){return e.setOptions({strokeWeight:e.getBorderSizeHover()})}),komoo.event.addListener(this,"mouseout",function(t){return e.setOptions({strokeWeight:e.getBorderSize()})})},t.prototype.getCoordinates=function(){var e,t,n,r,i;r=this.overlay.getPath().getArray(),i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(this.getArrayFromLatLng(e));return i},t.prototype.setCoordinates=function(e){var t;return this.overlay.setPath(function(){var n,r,i;i=[];for(n=0,r=e.length;n<r;n++)t=e[n],i.push(this.getLatLngFromArray(t));return i}.call(this))},t.prototype.setEditable=function(e){return this.overlay.setEditable(e)},t.prototype.getPath=function(){return this.overlay.getPath()},t.prototype.setPath=function(e){return this.overlay.setPath(e)},t}(r),l=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.geometryType=f,t.prototype.initOverlay=function(e){return this.setOverlay(new MultiPolyline(this.getOverlayOptions(e)))},t.prototype.guaranteeLines=function(e){var t,n,r,i,s,o,u,a;n=this.overlay.getPolylines();if(n.length>=e){u=[];for(t=r=0,s=n.length-e-1;0<=s?r<=s:r>=s;t=0<=s?++r:--r)u.push(n.pop());return u}a=[];for(t=i=0,o=e-n.length-1;0<=o?i<=o:i>=o;t=0<=o?++i:--i)a.push(this.overlay.addPolyline(new w.Polyline(this.options)));return a},t.prototype.getCoordinates=function(){var e,t,n,r,i;r=this.overlay.getPolylines().getArray(),i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(this.getArrayFromLatLngArray(e.getPath().getArray()));return i},t.prototype.setCoordinates=function(e){var t,n,r,i,s,o;e[0][0]instanceof Array||(e=[e]),this.guaranteeLines(e.length),this.bounds=null,s=this.getLines(),o=[];for(t=r=0,i=s.length;r<i;t=++r)n=s[t],o.push(n.setPath(this.getLatLngArrayFromArray(e[t])));return o},t.prototype.getBorderSize=function(){return t.__super__.getBorderSize.call(this)+1},t.prototype.getBorderSizeHover=function(){return t.__super__.getBorderSizeHover.call(this)+1},t.prototype.getPath=function(){return this.getPaths().getAt(0)},t.prototype.getPaths=function(){return this.overlay.getPaths()},t.prototype.setPaths=function(e){return this.overlay.setPaths(e)},t.prototype.getLines=function(){return this.overlay.getPolylines().getArray()},t.prototype.setLines=function(e){return this.overlay.addPolylines(e)},t.prototype.addPolyline=function(e,t){return this.overlay.addPolyline(e,t)},t.prototype.getPolylines=function(){return this.overlay.getPolylines()},t}(s),m=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.geometryType=p,t.prototype.getOverlayOptions=function(e){var t,n,r,i,s,o,u;return e==null&&(e={}),{clickable:(t=e.clickable)!=null?t:!0,zIndex:(n=e.zIndex)!=null?n:this.calculateZIndex(),fillColor:(r=e.fillColor)!=null?r:this.getBackgroundColor(),fillOpacity:(i=e.fillOpacity)!=null?i:this.getBackgroundOpacity(),strokeColor:(s=e.strokeColor)!=null?s:this.getBorderColor(),strokeOpacity:(o=e.strokeOpacity)!=null?o:this.getBorderOpacity(),strokeWeight:(u=e.strokeWeight)!=null?u:this.getBorderSize()}},t.prototype.calculateZIndex=function(){return this.area?510072e9/this.area:this.getDefaultZIndex()},t.prototype.initOverlay=function(e){return this.setOverlay(new w.Polygon(this.getOverlayOptions(e)))},t.prototype.getCoordinates=function(){var e,t,n,r,i,s;e=[],s=this.overlay.getPaths().getArray();for(r=0,i=s.length;r<i;r++)t=s[r],n=this.getArrayFromLatLngArray(t.getArray()),n.length&&n.push(n[0]),n.length>0&&e.push(n);return e},t.prototype.setCoordinates=function(e){var t,n,r,i,s;n=[],this.bounds=null;for(i=0,s=e.length;i<s;i++)r=e[i],t=this.getLatLngArrayFromArray(r),t.pop(),n.push(t);return this.setPaths(n)},t.prototype.getPath=function(){return this.getPaths().getAt(0)},t.prototype.getPaths=function(){return this.overlay.getPaths()},t.prototype.setPaths=function(e){return this.overlay.setPaths(e)},t}(s),window.komoo.geometries={types:{EMPTY:t,POINT:h,MULTIPOINT:a,POLYGON:p,POLYLINE:d,LINESTRING:i,MULTIPOLYLINE:f,MULTILINESTRING:u},MultiMarker:MultiMarker,Geometry:r,Empty:n,Point:g,MultiPoint:c,LineString:s,MultiLineString:l,Polygon:m,defaults:b,makeGeometry:function(e,t){var r,i,s,o,u;s={feature:t,area:(u=e.properties)!=null?u.area:void 0};if(e.geometry==null)return new n(s);o=e.geometry.type,r=e.geometry.coordinates;if(o==="Point")i=new g(s);else if(o==="MultiPoint"||o==="marker")i=new c(s);else if(o==="LineString"||o==="polyline")r&&(r=[r]),i=new l(s);else if(o==="MultiLineString")i=new l(s);else if(o==="Polygon"||o==="polygon")i=new m(s);return r&&i!=null&&i.setCoordinates(r),i}},window.komoo.geometries}),define("map/features",["require","googlemaps","./geometries"],function(e){var t,n,r,i,s,o,u,a;return i=e("googlemaps"),r=e("./geometries"),(u=window.komoo)==null&&(window.komoo={}),(a=(o=window.komoo).event)==null&&(o.event=i.event),s=0,n={minZoomPoint:0,maxZoomPoint:10,minZoomIcon:10,maxZoomIcon:100,minZoomGeometry:0,maxZoomGeometry:100},t=function(){function e(e){var t;this.options=e!=null?e:{},this.uid=s++,t=this.options.geometry,this.setFeatureType(this.options.featureType),this.options.geojson&&(this.options.geojson.properties&&this.setProperties(this.options.geojson.properties),t==null&&(t=r.makeGeometry(this.options.geojson,this))),t!=null&&(this.setGeometry(t),this.createMarker())}return e.prototype.displayTooltip=!0,e.prototype.displayInfoWindow=!0,e.prototype.createMarker=function(){var e,t;return void 0},e.prototype.initEvents=function(e){var t,n;return e==null&&(e=this.geometry),n=this,t=["click","dblclick","mousedown","mousemove","mouseout","mouseover","mouseup","rightclick","drag","dragend","draggable_changed","dragstart","coordinates_changed"],t.forEach(function(t){return komoo.event.addListener(e,t,function(e,r){return komoo.event.trigger(n,t,e,r)})})},e.prototype.getGeometry=function(){return this.geometry},e.prototype.setGeometry=function(e){return this.geometry=e,this.geometry.feature=this,this.initEvents()},e.prototype.getGeometryType=function(){return this.geometry.getGeometryType()},e.prototype.getFeatureType=function(){return this.featureType},e.prototype.setFeatureType=function(e){this.featureType=e!=null?e:n},e.prototype.getMarker=function(){return this.marker},e.prototype.setMarker=function(e){return this.marker=e,this.marker.getOverlay().feature=this,this.initEvents(this.marker),this.marker.setVisible(this.markerShouldBeVisible()),this.marker},e.prototype.handleGeometryEvents=function(){var e=this;return komoo.event.addListener(this.geometry,"coordinates_changed",function(t){return e.updateIcon(),komoo.event.trigger(e,"coordinates_changed",t)})},e.prototype.getUrl=function(){var e;return e="view_"+this.properties.type.toLowerCase(),dutils.urls.resolve(e,{id:this.properties.id}).replace("//","/")},e.prototype.isHighlighted=function(){return this.highlighted},e.prototype.highlight=function(){return this.setHighlight(!0)},e.prototype.setHighlight=function(e,t){t==null&&(t=!1);if(this.highlighted===e)return;this.highlighted=e,this.updateIcon();if(!t)return komoo.event.trigger(this,"highlight_changed",this.highlighted)},e.prototype.isNew=function(){return!this.getProperty("id")},e.prototype.getIconUrl=function(e){var t,n,r,i;return this.getProperty("image")?this.getProperty("image"):(e==null&&(e=this.map?this.map.getZoom():10),r=e>=this.featureType.minZoomIcon?"near":"far",n=this.isHighlighted()?"highlighted/":"",t=this.properties.type.toLowerCase(),i=("/static/img/"+r+"/"+n+t+".png").replace(" ","-"),i)},e.prototype.createIcon=function(e){return this.geometry.createIcon(e,this.isHighlighted())},e.prototype.updateIcon=function(e){return this.setIcon(this.createIcon(e))},e.prototype.getCategoriesIcons=function(){var e,t,n,r,i;r=this.getCategories(),i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push("/static/img/need_categories/"+category.name.toLowerCase()+".png");return i},e.prototype.getProperties=function(){return this.properties},e.prototype.setProperties=function(e){this.properties=e},e.prototype.getProperty=function(e){return this.properties[e]},e.prototype.setProperty=function(e,t){return this.properties[e]=t},e.prototype.getType=function(){return this.getProperty("type")},e.prototype.getCategories=function(){var e;return(e=this.getProperty("categories"))!=null?e:[]},e.prototype.getGeometryGeoJson=function(){return this.geometry.getGeoJson()},e.prototype.getGeometryCollectionGeoJson=function(){return{type:"GeometryCollection",geometries:[this.getGeometryGeoJson()]}},e.prototype.getGeoJsonGeometry=function(){return this.getGeometryGeoJson()},e.prototype.getGeoJson=function(){return{type:"Feature",geometry:this.getGeometryGeoJson(),properties:this.getProperties()}},e.prototype.getGeoJsonFeature=function(){return this.getGeoJson()},e.prototype.setEditable=function(e){return this.editable=e,this.geometry.setEditable(this.editable)},e.prototype.showGeometry=function(){return this.geometry.setMap(this.map)},e.prototype.hideGeometry=function(){return this.geometry.setMap(null)},e.prototype.showMarker=function(){var e;return(e=this.marker)!=null&&e.setMap(this.map),this.marker.setVisible(this.markerShouldBeVisible())},e.prototype.hideMarker=function(){return this.marker.setVisible(!1)},e.prototype.getMap=function(){return this.map},e.prototype.setMap=function(e,t){var n;t==null&&(t={geometry:!1,point:!1,icon:!1});if(e===this.geometry.getMap())return;this.oldMap=this.map,e!=null&&(this.map=e),(n=this.marker)!=null&&n.setMap(e),this.geometry.setMap(e),this.updateIcon();if(this.oldMap===void 0)return this.handleMapEvents()},e.prototype.isOutOfBounds=function(){return this.outOfBounds},e.prototype.setOutOfBounds=function(e){return this.outOfBounds=e,this.outOfBounds?this.setMap(null):(this.setMap(this.oldMap),this.setVisible(this.visible))},e.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("feature_highlight_changed",function(t,n){if(n===e)return;if(e.isHighlighted())return e.setHighlight(!1,!0)})},e.prototype.getBounds=function(){return this.geometry.getBounds()},e.prototype.removeFromMap=function(){var e;return(e=this.marker)!=null&&e.setMap(null),this.setMap(null)},e.prototype.markerShouldBeVisible=function(){var e,t,n,r,i;return((e=this.map)!=null?e.type:void 0)==="preview"||this.featureType.minZoomPoint<=(t=(n=this.map)!=null?n.getZoom():void 0)&&t<=this.featureType.maxZoomPoint||this.featureType.minZoomIcon<=(r=(i=this.map)!=null?i.getZoom():void 0)&&r<=this.featureType.maxZoomIcon},e.prototype.setVisible=function(e){var t,n,r,i,s;return this.editable?(n=!0,t=this):(i=(r=this.map)!=null?r.triggerHooks("before_feature_setVisible",this,e):void 0,t=i[0],n=i[1]),this.visible=n,(s=this.marker)!=null&&s.setVisible(n&&this.markerShouldBeVisible()),this.geometry.setVisible(n)},e.prototype.getCenter=function(){return this.geometry.getCenter()},e.prototype.setOptions=function(e){return this.geometry.setOptions(e)},e.prototype.getIcon=function(){return this.geometry.getIcon()},e.prototype.setIcon=function(e){var t;return(t=this.marker)!=null&&t.setIcon(e),this.geometry.setIcon(e)},e.prototype.setBorderSize=function(e){this.borderSize=e},e.prototype.getBorderSize=function(){var e;return(e=this.borderSize)!=null?e:this.featureType.border_size},e.prototype.setBorderSizeHover=function(e){this.borderSizeHover=e},e.prototype.getBorderSizeHover=function(){var e;return(e=this.borderSizeHover)!=null?e:this.featureType.borderSizeHover},e.prototype.setBorderColor=function(e){this.borderColor=e},e.prototype.getBorderColor=function(){var e;return(e=this.borderColor)!=null?e:this.featureType.borderColor},e.prototype.setBorderOpacity=function(e){this.borderOpacity=e},e.prototype.getBorderOpacity=function(){var e;return(e=this.borderOpacity)!=null?e:this.featureType.borderOpacity},e.prototype.setBackgroundColor=function(e){this.backgroundColor=e},e.prototype.getBackgroundColor=function(){var e;return(e=this.backgroundColor)!=null?e:this.featureType.backgroundColor},e.prototype.setBackgroundOpacity=function(e){this.backgroundOpacity=e},e.prototype.getBackgroundOpacity=function(){var e;return(e=this.backgroundOpacity)!=null?e:this.featureType.backgroundOpacity},e.prototype.setDefaultZIndex=function(e){this.defaultZIndex=e},e.prototype.getDefaultZIndex=function(){var e;return(e=this.defaultZIndex)!=null?e:this.featureType.zIndex},e.prototype.refresh=function(){return this.geometry.refresh()},e}(),window.komoo.features={Feature:t,makeFeature:function(e,t){var n;return new komoo.features.Feature({geojson:e,featureType:t!=null?t[e!=null?(n=e.properties)!=null?n.type:void 0:void 0]:void 0})}},window.komoo.features});var __indexOf=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};define("map/layers",["require","./collections","underscore"],function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d;return i=e("./collections"),d=e("underscore"),p="/static/",o=["==","is","equal","equals"],l=["!=","isnt","not equal","not equals","different"],a=["in"],s=["contains","has"],c=["!","not"],h=["or"],r=["and"],u=function(e,t){var n,i,f,p,d,v,m,g;if(e==null||e.operator==null)return!0;if(t==null)return!1;i=e.operator,n=t.getProperty(e.property);if(__indexOf.call(o,i)>=0)return n===e.value;if(__indexOf.call(l,i)>=0)return!n===e.value;if(__indexOf.call(a,i)>=0)return n!=null&&__indexOf.call(e.value,n)>=0;if(__indexOf.call(s,i)>=0&&Object.prototype.toString.call(e.value)==="[object Array]"){f=!0,m=e.value;for(d=0,v=m.length;d<v;d++)p=m[d],f=f&&n!=null&&__indexOf.call(n,p)>=0;return f}if(__indexOf.call(s,i)>=0)return n&&(g=e.value,__indexOf.call(n,g)>=0);if(__indexOf.call(c,i)>=0)return!u(e.child,t);if(__indexOf.call(h,i)>=0)return u(e.left,t)||u(e.right,t);if(__indexOf.call(r,i)>=0)return u(e.left,t)&&u(e.right,t)},window.ee=u,n=function(e){function n(){n.__super__.constructor.call(this),this.othersLayer=this.loadLayer({id:"Others",name:gettext("Others"),position:100}),window.o=this.othersLayer}return __extends(n,e),n.prototype.updateOthersLayerRule=function(){var e,t,n=this;return e=void 0,this.forEach(function(t){var r;if(t===n.othersLayer||t.getRule()==null)return;return r={operator:"not",child:t.getRule()},e=e!=null?{operator:"and",left:e,right:r}:r}),(t=this.othersLayer)!=null?t.setRule(e):void 0},n.prototype.sort=function(e){return e!=null?n.__super__.sort.call(this,e):n.__super__.sort.call(this,function(e,t){var n,r,i,s;return n=(i=e.getPosition())!=null?i:0,r=(s=t.getPosition())!=null?s:0,n<r?-1:n>r?1:0})},n.prototype.addLayer=function(e){var t;return this.contains(e)||this.push(e),this.updateOthersLayerRule(),this.sort(),e.setLayersCollection(this),this._resetCache(),(t=e.map)!=null?t.publish("layer_added",e):void 0},n.prototype.getLayer=function(e){var t;return t=this.filter(function(t){return t.getId()===e||t.getName()===e}),t.first},n.prototype.showLayer=function(e){return this.getLayer(e).show()},n.prototype.hideLayer=function(e){return this.getLayer(e).hide()},n.prototype.showAll=function(){return this.forEach(function(e){return e.show()})},n.prototype.hideAll=function(){return this.forEach(function(e){return e.hide()})},n.prototype.getVisibleLayers=function(){return this.filter(function(e){return e.visible})},n.prototype.getHiddenLayers=function(){return this.filter(function(e){return!e.visible})},n.prototype.shouldFeatureBeVisible=function(e){var t,n,r=this;return e.isOutOfBounds()?!1:this.length===0?!0:(n=!1,t=this._getFromCache(e),t.forEach(function(t){var i,s;i=r.getLayer(t);if(!i.isVisible())return;return s=i.isVisible(),s&&(!n||i.isImportant())&&r._updateFeatureStyle(e,i),n||(n=s)}),t.length===0&&(n=!0),n)},n.prototype.setCollection=function(e){var t=this;return this.collection=e,this.forEach(function(e){return e.setCollection(t.collection)})},n.prototype.getCollection=function(){var e,t,n;return(e=(t=this.collection)!=null?t:(n=this.map)!=null?n.getFeatures():void 0)!=null?e:[]},n.prototype.refresh=function(){var e=this;return this.getCollection().forEach(function(t){var n,r;return n=e.getLayer((r=e._getFromCache(t))!=null?r[0]:void 0),e._updateFeatureStyle(t,n)})},n.prototype.loadLayer=function(e){var n;return n=new t(d.extend({collection:this.getCollection(),map:this.map},e)),this.addLayer(n),n},n.prototype.loadLayers=function(e){var t,n=this;return t=[],e.forEach(function(e){return t.push(n.loadLayer(e))}),t},n.prototype.setMap=function(e){var t=this;this.map=e;if(!this.map)return;this.reset(),this.handleMapEvents(),this.forEach(function(e){return e.setMap(t.map)});if(this.collection==null)return this.setCollection(this.map.getFeatures())},n.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("feature_added",function(t){var n;return n=!1,e.forEach(function(r){if(r.match(t))return e._addToCache(t,r),n||e._updateFeatureStyle(t,r),n=!0})})},n.prototype.reset=function(){return this._resetCache(),this.forEach(function(e){return e.reset()})},n.prototype._resetCache=function(){return this.cache={}},n.prototype._addToCache=function(e,t){var n,r,i;return(i=(n=this.cache)[r=e.uid])==null&&(n[r]=[]),this.cache[e.uid].push(t.getId())},n.prototype._getFromCache=function(e){var t,n,r=this;return t=this.cache[e.uid],t||this.forEach(function(t){if(t.match(e))return r._addToCache(e,t)}),(n=this.cache[e.uid])!=null?n:[]},n.prototype.toJSON=function(){var e;return e=[],this.forEach(function(t){if(t.getId()==="Others")return;return e.push(t.toJSON())}),e},n.prototype._updateFeatureStyle=function(e,t){return t._updateFeatureStyle(e)},n}(i.GenericCollection),t=function(){function e(e){var t,n,r,s,o,u,a,f,l;this.options=e!=null?e:{},this.cache=new i.FeatureCollection,this.visible=(t=this.options.visible)!=null?t:!0,this.icon=(n=(r=this.options.icon)!=null?r[0]:void 0)!=null?n:"",this.iconOff=(s=(o=this.options.icon)!=null?o[1]:void 0)!=null?s:"",this.fillColor=(u=this.options.fillColor)!=null?u:"#c0c0c0",this.strokeColor=(a=this.options.strokeColor)!=null?a:this.fillColor,this.id=""+((f=this.options.id)!=null?f:this.options.name),this.important=(l=this.options.important)!=null?l:!1,this.setPosition(this.options.position),this.setName(this.options.name),this.setRule(this.options.rule),this.setCollection(this.options.collection),this.setMap(this.options.map)}return e.prototype.getPosition=function(){return this.position},e.prototype.setPosition=function(e){return this.position=e,this},e.prototype.getId=function(){return this.id},e.prototype.getName=function(){return this.name},e.prototype.setName=function(e){return this.name=e,this},e.prototype.getFillColor=function(){return this.fillColor},e.prototype.setFillColor=function(e){return this.fillColor=e,this},e.prototype.getStrokeColor=function(){return this.strokeColor},e.prototype.setStrokeColor=function(e){return this.strokeColor=e,this},e.prototype.getCollection=function(){return this.collection},e.prototype.setCollection=function(e){return this.collection=e,this.cache.clear(),this},e.prototype.getLayersCollection=function(){return this.layersCollection},e.prototype.setLayersCollection=function(e){this.layersCollection=e},e.prototype.getRule=function(){return this.rule},e.prototype.setRule=function(e){return this.rule=e,this.cache.clear(),this},e.prototype.getIconUrl=function(){return this.icon&&p+(this.visible?this.icon:this.iconOff)},e.prototype.setMap=function(e){var t;this.map=e;if(!this.map)return;this.handleMapEvents(),typeof (t=this.cache).setMap=="function"&&t.setMap(this.map);if(this.collection==null)return this.setCollection(this.map.getFeatures())},e.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("feature_added",function(t){if(!e.cache.isEmpty()&&e.match(t))return e.cache.push(t)})},e.prototype.isVisible=function(){return this.visible},e.prototype.isImportant=function(){return this.important},e.prototype.show=function(){return this.getFeatures().show(),this.visible=!0},e.prototype.hide=function(){return this.getFeatures().hide(),this.visible=!1},e.prototype.toggle=function(){return this.visible?this.hide():this.show(),this.visible},e.prototype.match=function(e){return u(this.rule,e)},e.prototype.getFeatures=function(){return this.cache.isEmpty()&&this.updateCache(),this.cache},e.prototype.countFeatures=function(){return this.getFeatures().length},e.prototype.reset=function(){return this.cache.clear()},e.prototype.updateCache=function(){var e,t=this;return this.cache.clear(),e=this.collection.filter(this.match,this),e.forEach(function(e){return t.cache.push(e)}),this},e.prototype.toJSON=function(){return{id:this.getId(),name:this.getName(),rule:this.getRule(),position:this.getPosition(),fillColor:this.getFillColor(),strokeColor:this.getStrokeColor()}},e.prototype._updateFeatureStyle=function(e){return e.setBorderColor(this.getStrokeColor()),e.setBackgroundColor(this.getFillColor()),e.refresh()},e}(),f={Layers:n,Layer:t},f}),function(){define("map/component",["require","jquery"],function(e){var t,n,r;return t=e("jquery"),n=function(){function e(e,n){this.mediator=e,this.el=n,this.map=this.mediator,this.el&&(this.$el=t(document).find(this.el))}return e.prototype.name="Base Component",e.prototype.description="",e.prototype.hooks={},e.prototype.enabled=!1,e.prototype.setMap=function(e){this.map=e},e.prototype.enable=function(){return this.enabled=!0},e.prototype.disable=function(){return this.enabled=!1},e.prototype.init=function(e){return t.when(e)},e.prototype.destroy=function(){return!0},e}(),r=n,r})}.call(this),define("map/utils",["googlemaps"],function(e){return window.komoo||(komoo={}),komoo.utils={},komoo.utils.createCookie=function(e,t,n){var r;if(n){var i=new Date;i.setTime(i.getTime()+n*24*60*60*1e3),r="; expires="+i.toGMTString()}else r="";document.cookie=e+"="+t+r+"; path=/"},komoo.utils.readCookie=function(e){var t=e+"=",n=document.cookie.split(";");for(var r=0;r<n.length;r++){var i=n[r];while(i.charAt(0)==" ")i=i.substring(1,i.length);if(i.indexOf(t)===0)return i.substring(t.length,i.length)}return null},komoo.utils.eraseCookie=function(e){createCookie(e,"",-1)},komoo.utils.isPointInside=function(e,t){if(!t)return!1;var n=!1,r=t.getLength();for(var i=-1,s=r-1;++i<r;s=i)(t.getAt(i).lng()<=e.lng()&&e.lng()<t.getAt(s).lng()||t.getAt(s).lng()<=e.lng()&&e.lng()<t.getAt(i).lng())&&e.lat()<(t.getAt(s).lat()-t.getAt(i).lat())*(e.lng()-t.getAt(i).lng())/(t.getAt(s).lng()-t.getAt(i).lng())+t.getAt(i).lat()&&(n=!n);return n},komoo.utils.latLngToPoint=function(t,n,r){t.googleMap&&(t=t.googleMap);var i=r||t.getZoom(),s=t.getProjection().fromLatLngToPoint(n),o=Math.pow(2,i),u=new e.Point(s.x*o,s.y*o);return u},komoo.utils.pointToLatLng=function(t,n,r){t.googleMap&&(t=t.googleMap);var i=r||t.getZoom(),s=Math.pow(2,i),o=new e.Point(n.x/s,n.y/s),u=t.getProjection().fromPointToLatLng(o);return u},komoo.utils}),define("text",["module"],function(e){var t,n,r=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],i=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,s=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,o=typeof location!="undefined"&&location.href,u=o&&location.protocol&&location.protocol.replace(/\:/,""),a=o&&location.hostname,f=o&&(location.port||undefined),l=[],c=e.config&&e.config()||{};t={version:"2.0.3",strip:function(e){if(e){e=e.replace(i,"");var t=e.match(s);t&&(e=t[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:c.createXhr||function(){var e,t,n;if(typeof XMLHttpRequest!="undefined")return new XMLHttpRequest;if(typeof ActiveXObject!="undefined")for(t=0;t<3;t+=1){n=r[t];try{e=new ActiveXObject(n)}catch(i){}if(e){r=[n];break}}return e},parseName:function(e){var t=!1,n=e.indexOf("."),r=e.substring(0,n),i=e.substring(n+1,e.length);return n=i.indexOf("!"),n!==-1&&(t=i.substring(n+1,i.length),t=t==="strip",i=i.substring(0,n)),{moduleName:r,ext:i,strip:t}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,n,r,i){var s,o,u,a=t.xdRegExp.exec(e);return a?(s=a[2],o=a[3],o=o.split(":"),u=o[1],o=o[0],(!s||s===n)&&(!o||o.toLowerCase()===r.toLowerCase())&&(!u&&!o||u===i)):!0},finishLoad:function(e,n,r,i){r=n?t.strip(r):r,c.isBuild&&(l[e]=r),i(r)},load:function(e,n,r,i){if(i.isBuild&&!i.inlineText){r();return}c.isBuild=i.isBuild;var s=t.parseName(e),l=s.moduleName+"."+s.ext,h=n.toUrl(l),p=c.useXhr||t.useXhr;!o||p(h,u,a,f)?t.get(h,function(n){t.finishLoad(e,s.strip,n,r)},function(e){r.error&&r.error(e)}):n([l],function(e){t.finishLoad(s.moduleName+"."+s.ext,s.strip,e,r)})},write:function(e,n,r,i){if(l.hasOwnProperty(n)){var s=t.jsEscape(l[n]);r.asModule(e+"!"+n,"define(function () { return '"+s+"';});\n")}},writeFile:function(e,n,r,i,s){var o=t.parseName(n),u=o.moduleName+"."+o.ext,a=r.toUrl(o.moduleName+"."+o.ext)+".js";t.load(u,r,function(n){var r=function(e){return i(a,e)};r.asModule=function(e,t){return i.asModule(e,a,t)},t.write(e,u,r,s)},s)}};if(c.env==="node"||!c.env&&typeof process!="undefined"&&process.versions&&!!process.versions.node)n=require.nodeRequire("fs"),t.get=function(e,t){var r=n.readFileSync(e,"utf8");r.indexOf("﻿")===0&&(r=r.substring(1)),t(r)};else if(c.env==="xhr"||!c.env&&t.createXhr())t.get=function(e,n,r){var i=t.createXhr();i.open("GET",e,!0),c.onXhr&&c.onXhr(i,e),i.onreadystatechange=function(t){var s,o;i.readyState===4&&(s=i.status,s>399&&s<600?(o=new Error(e+" HTTP status: "+s),o.xhr=i,r(o)):n(i.responseText))},i.send(null)};else if(c.env==="rhino"||!c.env&&typeof Packages!="undefined"&&typeof java!="undefined")t.get=function(e,t){var n,r,i="utf-8",s=new java.io.File(e),o=java.lang.System.getProperty("line.separator"),u=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(s),i)),a="";try{n=new java.lang.StringBuffer,r=u.readLine(),r&&r.length()&&r.charAt(0)===65279&&(r=r.substring(1)),n.append(r);while((r=u.readLine())!==null)n.append(o),n.append(r);a=String(n.toString())}finally{u.close()}t(a)};return t}),define("text!templates/map/_searchbox.html",[],function(){return'<form class\'search-form\' action="#">\n  <select name="location-type" class="location-type">\n    <option value="address"><% print(gettext(\'Address\')); %></option>\n    <option value="latLng"><% print(gettext(\'Coordinates\')); %></option>\n  </select>\n  <div class="address-container input-container">\n    <input type="text" name="address" value="" placeholder="<% print(gettext(\'Address\')); %>" class="address" />\n  </div>\n  <div class="latLng-container input-container" style="display: none;">\n    <input type="text" name="lat" value="" placeholder="<% print(gettext(\'Latitude\')); %>"  class="lat" />\n    <input type="text" name="lng" value="" placeholder="<% print(gettext(\'Longitude\')); %>" class="lng" />\n  </div>\n  <input type="submit" class="btn search" value="<% print(gettext(\'Go\')); %>" />\n  </form>\n'}),define("text!templates/map/_layersbox.html",[],function(){return'<ul class="layers geo-objects-listing">\n  <% layers.forEach(function (layer) {  %>\n    <li class="layer">\n      <div class="item on" data-layer="<%= layer.getId() %>" data-visible="<%= layer.isVisible() %>">\n        <div class="img-holder"><% if (layer.getIconUrl()) { %><img class="layer-icon" src="<%= layer.getIconUrl() %>" /><% } else { %><span style="display: inline-block; border-radius: 4px; width: 16px; height: 16px; background: <%= layer.getFillColor() %>; border: 2px solid <%= layer.getStrokeColor() %>;"></span><% } %></div>\n        <span class="name"><%= layer.name %></span><span class="length"><% if (layer.countFeatures()) { %> <%= layer.countFeatures() %> <% } %></span>\n      </div>\n      <div class="collapser" style="<% if (!layer.countFeatures()) { %>display: none;<%  } %>"><i class="icon-chevron-right"></i></div>\n    </li>\n    <li class="sublist" data-layer="<%= layer.getId() %>">\n      <ul>\n        <% layer.getFeatures().forEach(function (feature) { %>\n        <li class="feature" data-id="<%= feature.getProperty(\'id\') %>" data-type="<%= feature.getProperty(\'type\') %>"><%= feature.getProperty(\'name\') %></li>\n        <%  }); %>\n      </ul>\n    </li>\n  <% }); %>\n</ul>\n'});var __hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};define("map/views",["require","underscore","backbone","text!templates/map/_searchbox.html","text!templates/map/_layersbox.html"],function(e){var t,n,r,i;return i=e("underscore"),t=e("backbone"),r=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,t),n.prototype.events={"click .search":"onSearchBtnClick","change .location-type":"onTypeChange"},n.prototype.initialize=function(){return this.template=i.template(e("text!templates/map/_searchbox.html"))},n.prototype.render=function(){var e;return e=this.template(),this.$el.html(e),this},n.prototype.onTypeChange=function(){var e;return e=this.$(".location-type").val(),e==="address"?(this.$(".latLng-container").hide(),this.$(".address-container").show()):(this.$(".address-container").hide(),this.$(".latLng-container").show())},n.prototype.onSearchBtnClick=function(){var e,t;return t=this.$(".location-type").val(),e=t==="address"?this.$(".address").val():[parseFloat(this.$(".lat").val().replace(",",".")),parseFloat(this.$(".lng").val().replace(",","."))],this.search(t,e),!1},n.prototype.search=function(e,t){return e==null&&(e="address"),this.trigger("search",{type:e,position:t}),this},n}(t.View),n=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,t),n.prototype.events={"click .layer .item":"toggleLayer","click .layer .collapser":"toggleSublist","click .feature":"highlightFeature"},n.prototype.initialize=function(){return this.template=i.template(e("text!templates/map/_layersbox.html"))},n.prototype.render=function(e){var t;return this.layers=e,t=this.template({layers:this.layers}),this.$el.html(t),this.$(".sublist").hide(),this},n.prototype.updateCounters=function(e){var t=this;return e.forEach(function(e){return t.$("[data-layer="+e.getId()+"] .length").text(e.countFeatures())})},n.prototype.updateSublists=function(e){var t=this;return e.forEach(function(e){var n,r;if(e.countFeatures())return t.$("[data-layer="+e.getId()+"]").parent().find(".collapser").show(),n=t.$(".sublist[data-layer="+e.getId()+"]"),r=n.find("ul").empty(),e.getFeatures().forEach(function(e){return r.append('<li class="feature" data-type="'+e.getProperty("type")+'" data-id="'+e.getProperty("id")+'">'+e.getProperty("name")+"</li>")})})},n.prototype.toggleLayer=function(e){var t,n,r,i;return t=this.$(e.currentTarget),i=t.attr("data-layer"),r=t.attr("data-visible")==="true",n=r?"hide":"show",this.trigger(n,i),t.attr("data-visible",!r),t.toggleClass("on off")},n.prototype.toggleSublist=function(e){var t,n;return t=this.$(e.currentTarget),n=t.parent().next(".sublist"),console.log(n),t.find("i").toggleClass("icon-chevron-right icon-chevron-down"),n.toggle()},n.prototype.highlightFeature=function(e){var t,n,r;return t=this.$(e.currentTarget),r=t.attr("data-type"),n=parseInt(t.attr("data-id")),this.trigger("highlight_feature",r,n)},n}(t.View),{SearchBoxView:r,LayersBoxView:n}});var __hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},__indexOf=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};define("map/controls",["require","googlemaps","./component","./common","./geometries","./utils","infobox","markerclusterer"],function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,D,P,H,B,j,F,I,q,R,U,z,W,X,V,J,K,Q,G,Y,Z,et,tt,nt,rt,it,st,ot,ut,at,ft;return Q=e("googlemaps"),l=e("./component"),J=e("./common"),K=e("./geometries"),G=e("./utils"),E=e("infobox"),D=e("markerclusterer"),(at=window.komoo)==null&&(window.komoo={}),(ft=(ut=window.komoo).event)==null&&(ut.event=Q.event),st=gettext("Next step"),tt=gettext("Cancel"),nt=gettext("Close"),et=gettext("Add shape"),Y=gettext("Add line"),Z=gettext("Add point"),ot=gettext("Sum"),rt=gettext("Cut out"),it=gettext("Loading..."),v=J.geometries.types.EMPTY,j=J.geometries.types.POINT,O=J.geometries.types.MULTIPOINT,F=J.geometries.types.POLYGON,I=J.geometries.types.LINESTRING,x=J.geometries.types.LINESTRING,M=J.geometries.types.MULTILINESTRING,A=J.geometries.types.MULTILINESTRING,H={},H[j]=Q.drawing.OverlayType.MARKER,H[O]=Q.drawing.OverlayType.MARKER,H[x]=Q.drawing.OverlayType.POLYLINE,H[A]=Q.drawing.OverlayType.POLYLINE,H[F]=Q.drawing.OverlayType.POLYGON,d="edit",c="delete",P="new",t="add",u="cutout",B="perimeter_selection",o=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.position=Q.ControlPosition.RIGHT_BOTTOM,t.prototype.init=function(){var e;return t.__super__.init.call(this),this.box=(e=this.$el)!=null?e:$("<div>"),this.id!=null&&this.box.attr("id",this.id),this["class"]!=null&&this.box.addClass(this["class"]),this.position&&this.map.addControl(this.position,this.box.get(0)),typeof this.handleMapEvents=="function"?this.handleMapEvents():void 0},t.prototype.hide=function(){return this.box.hide()},t.prototype.show=function(){return this.box.show()},t}(l),k=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.position=Q.ControlPosition.TOP_CENTER,t.prototype.id="map-loading",t.prototype.init=function(){return t.__super__.init.call(this),this.requestsTotal=0,this.requestsWaiting=0,this.repaint()},t.prototype.getPercent=function(){return this.requestsTotal===0?0:Math.round(100*((this.requestsTotal-this.requestsWaiting)/this.requestsTotal))},t.prototype.repaint=function(){return this.box.html(""+it+" "+this.getPercent()+"%")},t.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("features_request_started",function(){return e.displayTimer=setTimeout(function(){return e.show()},500)}),this.map.subscribe("features_request_queued",function(){return e.requestsTotal++,e.requestsWaiting++,e.repaint()}),this.map.subscribe("features_request_unqueued",function(){return e.requestsWaiting--,e.repaint()}),this.map.subscribe("features_request_completed",function(){return e.requestsTotal=0,e.requestsWaiting=0,clearTimeout(e.displayTimer),setTimeout(function(){return e.hide()},200)})},t}(o),z=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,t),n.prototype.position=Q.ControlPosition.TOP_RIGHT,n.prototype.id="map-searchbox",n.prototype.init=function(){var t=this;return n.__super__.init.call(this),e(["map/views"],function(e){return t.view=new e.SearchBoxView,t.box.append(t.view.render().el),t.handleViewEvents()})},n.prototype.handleViewEvents=function(){var e=this;return this.view.on("search",function(t){var n,r;return r=t.type,n=t.position,e.map.publish("goto",n,!0)})},n}(o),T=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,t),n.prototype.position=null,n.prototype.init=function(){var t=this;return n.__super__.init.call(this),e(["map/views"],function(e){return t.layers=t.map.getLayers(),t.layers.layersBox=t.box,t.view=new e.LayersBoxView,t.box.append(t.view.render(t.layers).el),t.handleViewEvents()})},n.prototype.handleViewEvents=function(){var e=this;return this.view.on("highlight_feature",function(t,n){return e.map.highlightFeature(t,n)}),this.view.on("show",function(t){return e.layers.getLayer(t).show()}),this.view.on("hide",function(t){return e.layers.getLayer(t).hide()})},n.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("layer_added",function(t){var n;return(n=e.view)!=null?n.render(e.layers):void 0}),this.map.subscribe("features_loaded",function(t){var n,r;if(t.length)return(n=e.view)!=null&&n.updateCounters(e.layers),(r=e.view)!=null?r.updateSublists(e.layers):void 0})},n}(o),X=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.id="map-supporters",t.prototype.init=function(){return t.__super__.init.call(this),this.box.append($("#map-supporters-content").show())},t}(o),C=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.id="map-license",t.prototype.position=Q.ControlPosition.BOTTOM_LEFT,t.prototype.init=function(){return t.__super__.init.call(this),this.box.html('Este conteúdo é disponibilizado nos termos da licença <a href="http://creativecommons.org/licenses/by-sa/3.0/deed.pt_BR">Creative Commons - Atribuição - Partilha nos Mesmos Termos 3.0 Não Adaptada</a>; pode estar sujeito a condições adicionais. Para mais detalhes, consulte as Condições de Uso.')},t}(o),p=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.enabled=!0,n.prototype.defaultDrawingManagerOptions={drawingControl:!1,drawingMode:null},n.prototype.componentOriginalStatus={},n.prototype.init=function(e){var t,n;this.options=e!=null?e:{},(n=(t=this.options).drawingManagerOptions)==null&&(t.drawingManagerOptions=this.defaultDrawingManagerOptions);if(this.options.map)return this.setMap(this.options.map)},n.prototype.initManager=function(e){return e==null&&(e=this.defaultDrawingManagerOptions),this.manager=new Q.drawing.DrawingManager(e),this.handleManagerEvents()},n.prototype.setMap=function(e){return this.map=e,this.options.drawingManagerOptions.map=this.map.googleMap,this.initManager(this.options.drawingManagerOptions),this.handleMapEvents()},n.prototype.enable=function(){return this.enabled=!0},n.prototype.disable=function(){return this.enabled=!1},n.prototype.setMode=function(e){var n;this.mode=e,this.manager.setDrawingMode((n=this.mode)===t||n===P||this.mode===u&&this.feature.getGeometryType()===F?H[this.feature.getGeometryType()]:null);if(this.mode===u&&this.feature.getGeometryType()!==F)return this.mode=d},n.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("draw_feature",function(t,n){return e.drawFeature(n)}),this.map.subscribe("edit_feature",function(t){return e.editFeature(t)}),this.map.subscribe("drawing_finished",function(t){return e.feature.setEditable(!1),e.feature.updateIcon(),e.setFeature(null),e.setMode(null)}),this.map.subscribe("finish_drawing",function(){return e.map.publish("drawing_finished",e.feature,!0)}),this.map.subscribe("cancel_drawing",function(){return e.map.publish("drawing_finished",e.feature,!1)}),this.map.subscribe("mode_changed",function(t){return e.setMode(t)}),this.map.subscribe("feature_rightclick",function(e,t){var n,r,i;if(e.vertex==null)return;n=t.getGeometry().getOverlay(),i=typeof n.getPaths=="function"?n.getPaths():void 0,r=i!=null?i.getAt(e.path):void 0,r!=null&&r.removeAt(e.vertex);if((r!=null?r.getLength():void 0)===1)return i.removeAt(e.path)})},n.prototype.handleManagerEvents=function(){var e=this;return komoo.event.addListener(this.manager,"overlaycomplete",function(n){var r,i,s,o,a,f,l,c,h,p,v,m,g;s=(l=n.overlay)!=null?typeof l.getPath=="function"?l.getPath():void 0:void 0;if(s&&((c=e.mode)===t||c===P||c===u)&&((h=n.overlay)!=null?h.getPaths:void 0)){o=e.feature.getGeometry().getPaths(),e.mode===P&&o.clear();if((o!=null?o.length:void 0)>0){a=Q.geometry.spherical.computeSignedArea(s),f=Q.geometry.spherical.computeSignedArea(o.getAt(0)),r=a/Math.abs(a),i=f/Math.abs(f);if(r===i&&e.mode===u||r!==i&&((p=e.mode)===t||p===P))s=new Q.MVCArray(s.getArray().reverse())}o.push(s),e.feature.getGeometry().setPaths(o),n.overlay.setMap(null)}else(v=e.mode)!==t&&v!==P||!n.overlay.getPosition?((m=e.mode)===t||m===P)&&n.overlay.getPath&&e.feature.getGeometry().addPolyline(n.overlay,!0):(e.feature.getGeometry().addMarker(n.overlay),e.feature.updateIcon(100));return e.map.setMode(d),(g=e.feature)!=null?g.setEditable(!0):void 0})},n.prototype.setFeature=function(e){var t=this;this.feature=e,this.featureClickListener!=null&&komoo.event.removeListener(this.featureClickListener);if(this.feature==null)return;return this.feature.setMap(this.map,{geometry:!0}),this.featureClickListener=komoo.event.addListener(this.feature,"click",function(e,n){var r,i,s,o,u,a;if(t.mode===c)return t.feature.getGeometryType()===F?(o=t.feature.getGeometry().getPaths(),o.forEach(function(t,n){if(G.isPointInside(e.latLng,t))return o.removeAt(n)})):n&&t.feature.getGeometryType()===O?(s=t.feature.getGeometry().getMarkers(),r=$.inArray(n,s.getArray()),r>-1&&(i=s.removeAt(r),i.setMap(null))):n&&t.feature.getGeometryType()===A&&(a=t.feature.getGeometry().getPolylines(),r=$.inArray(n,a.getArray()),r>-1&&(u=a.removeAt(r),u.setMap(null))),t.map.setMode(d)})},n.prototype.editFeature=function(e){var t;if(this.enabled===!1)return;this.setFeature(e);if(this.feature.getGeometryType()==="Empty"){this.map.publish("select_new_geometry",this.feature);return}return this.feature.setEditable(!0),t={},t[""+H[this.feature.getGeometryType()]+"Options"]=this.feature.getGeometry().getOverlayOptions({strokeWeight:2.5,zoom:100}),this.manager.setOptions(t),this.map.setMode(d),this.map.publish("drawing_started",this.feature)},n.prototype.drawFeature=function(e){this.feature=e;if(this.enabled===!1)return;return this.editFeature(this.feature),this.map.setMode(P)},n}(l),a=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.id="map-drawing-box",t.prototype["class"]="map-panel",t.prototype.position=Q.ControlPosition.TOP_LEFT,t.prototype.init=function(e){var n,r;return e==null&&(e={title:""}),t.__super__.init.call(this),n=(r=e.title)!=null?r:"",this.box.html('<div id="drawing-control">\n  <div class="map-panel-title" id="drawing-control-title">'+n+'</div>\n  <div class="content" id="drawing-control-content"></div>\n  <div class="map-panel-buttons">\n    <div class="map-button" id="drawing-control-cancel">'+nt+"</div>\n  </div>\n</div>"),this.show(),this.handleButtonEvents()},t.prototype.setTitle=function(e){return e==null&&(e=""),this.box.find("#drawing-control-title").text(e)},t.prototype.handleButtonEvents=function(){var e=this;return $("#drawing-control-cancel",this.box).click(function(){return e.map.publish("close_clicked")})},t}(o),w=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.id="map-drawing-box",t.prototype["class"]="map-panel",t.prototype.position=Q.ControlPosition.TOP_LEFT,t.prototype.init=function(){return t.__super__.init.call(this),this.hide(),this.box.html('<div id="geometry-selector">\n  <div class="map-panel-title" id="drawing-control-title"></div>\n  <ul class="content" id="drawing-control-content">\n    <li class="polygon btn" data-geometry-type="Polygon">\n      <i class="icon-polygon middle"></i><span class="middle">Adicionar área</span>\n    </li>\n    <li class="linestring btn" data-geometry-type="LineString">\n      <i class="icon-linestring middle"></i><span class="middle">Adicionar linha</span>\n    </li>\n    <li class="point btn" data-geometry-type="Point">\n      <i class="icon-point middle"></i><span class="middle">Adicionar ponto</span>\n    </li>\n  </ul>\n  <div class="map-panel-buttons">\n    <div class="map-button" id="drawing-control-cancel">'+tt+"</div>\n  </div>\n</div>"),this.handleBoxEvents()},t.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("select_new_geometry",function(t){return e.open(t)})},t.prototype.handleBoxEvents=function(){var e=this;return this.box.find("li").each(function(t,n){var r,i;return r=$(n),i=r.attr("data-geometry-type"),r.click(function(){return e.close(),e.map.editFeature(e.feature,i)})})},t.prototype.handleButtonEvents=function(){var e=this;return $("#drawing-control-cancel",this.box).click(function(){return e.map.publish("cancel_drawing")})},t.prototype.showContent=function(){var e,t,n,r,i,s;this.box.find("li").hide(),i=(r=this.feature.getFeatureType())!=null?r.geometryTypes:void 0,s=[];for(t=0,n=i.length;t<n;t++)e=i[t],s.push(this.box.find("li."+e.toLowerCase()).show());return s},t.prototype.open=function(e){return this.feature=e,this.showContent(),$("#drawing-control-title",this.box).html("Selecione o tipo de objeto"),this.handleButtonEvents(),this.show()},t.prototype.close=function(){return this.hide()},t}(o),h=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.id="map-drawing-box",n.prototype["class"]="map-panel",n.prototype.position=Q.ControlPosition.TOP_LEFT,n.prototype.init=function(){return n.__super__.init.call(this),this.hide(),this.box.html('<div id="drawing-control">\n  <div class="map-panel-title" id="drawing-control-title"></div>\n  <div class="content" id="drawing-control-content"></div>\n  <div class="map-panel-buttons">\n    <div class="map-button" id="drawing-control-finish">'+st+'</div>\n    <div class="map-button" id="drawing-control-cancel">'+tt+"</div>\n  </div>\n</div>"),this.handleBoxEvents()},n.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("drawing_started",function(t){return e.open(t)}),this.map.subscribe("drawing_finished",function(t){return e.close()}),this.map.subscribe("mode_changed",function(t){return e.setMode(t)})},n.prototype.handleBoxEvents=function(){var e=this;return $("#drawing-control-finish",this.box).click(function(){if($("#drawing-control-finish",e.box).hasClass("disabled"))return;return e.map.publish("finish_drawing")}),$("#drawing-control-cancel",this.box).click(function(){return e.map.publish("cancel_drawing")})},n.prototype.handleButtonEvents=function(){var e=this;return $("#drawing-control-add",this.box).click(function(){return e.map.setMode(e.mode!==t?t:d)}),$("#drawing-control-cutout",this.box).click(function(){return e.map.setMode(e.mode!==u?u:d)}),$("#drawing-control-delete",this.box).click(function(){return e.map.setMode(e.mode!==c?c:d)})},n.prototype.setMode=function(e){var t;return this.mode=e,this.mode===P?($("#drawing-control-content",this.box).hide(),$("#drawing-control-finish",this.box).addClass("disabled")):($("#drawing-control-content",this.box).show(),$("#drawing-control-finish",this.box).removeClass("disabled")),$(".map-button.active",this.box).removeClass("active"),$("#drawing-control-"+((t=this.mode)!=null?t.toLowerCase():void 0),this.box).addClass("active")},n.prototype.getTitle=function(){var e,t,n,r;if(this.feature.getGeometryType()===F)e="polygon",t=et;else if((n=this.feature.getGeometryType())===x||n===A)e="linestring",t=Y;else if((r=this.feature.getGeometryType())===j||r===O)e="point",t=Z;return'<i class="icon-'+e+' middle"></i><span class="middle">'+t+"</span>"},n.prototype.getContent=function(){var e,t,n,r;return e=$('<div class="map-button" id="drawing-control-add"><i class="icon-komoo-plus middle"></i><span class="middle">'+ot+"</span></div>"),n=$('<div class="map-button" id="drawing-control-cutout"><i class="icon-komoo-minus middle"></i><span class="middle">'+rt+"</span></div>"),r=$('<div class="map-button" id="drawing-control-delete"><i class="icon-komoo-trash middle"></i></div>'),t=$("<div>").addClass(this.feature.getGeometryType().toLowerCase()),this.feature.getGeometryType()!==j&&t.append(e),this.feature.getGeometryType()===F&&t.append(n),this.feature.getGeometryType()!==j&&t.append(r),t},n.prototype.open=function(e){return this.feature=e,$("#drawing-control-title",this.box).html(this.getTitle()),$("#drawing-control-content",this.box).html(this.getContent()),this.handleButtonEvents(),this.show()},n.prototype.close=function(){return this.hide()},n}(o),q=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.enabled=!0,t.prototype.init=function(){var e=this;return t.__super__.init.call(this),this.circle=new Q.Circle({visible:!0,radius:100,fillColor:"white",fillOpacity:0,strokeColor:"#ffbda8",zIndex:-1}),this.marker=new Q.Marker({icon:"/static/img/marker.png"}),komoo.event.addListener(this.circle,"click",function(t){if(e.map.mode===B)return e.selected(t.latLng)})},t.prototype.select=function(e,t){this.radius=e,this.callback=t;if(!this.enabled)return;return this.origMode=this.map.mode,this.map.disableComponents("infoWindow"),this.map.setMode(B)},t.prototype.selected=function(e){return typeof this.radius=="number"&&this.circle.setRadius(this.radius),typeof this.callback=="function"&&this.callback(e,this.circle),this.circle.setCenter(e),this.circle.setMap(this.map.googleMap),this.marker.setPosition(e),this.marker.setMap(this.map.googleMap),this.map.publish("perimeter_selected",e,this.circle),this.map.setMode(this.origMode),this.map.enableComponents("infoWindow")},t.prototype.handleMapEvents=function(){var e,t,n,r,i,s=this;this.map.subscribe("select_perimeter",function(e,t){return s.select(e,t)}),r=["click","feature_click"],i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(this.map.subscribe(e,function(e){if(s.map.mode===B)return s.selected(e.latLng)}));return i},t.prototype.setMap=function(e){return this.map=e,this.handleMapEvents()},t.prototype.enable=function(){return this.enabled=!0},t.prototype.disable=function(){return this.hide(),this.enabled=!1},t}(l),s=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.defaultWidth="300px",t.prototype.enabled=!0,t.prototype.init=function(e){return this.options=e!=null?e:{},t.__super__.init.call(this),this.width=this.options.width||this.defaultWidth,this.createInfoBox(this.options),this.options.map&&this.setMap(this.options.map),this.customize()},t.prototype.createInfoBox=function(e){return this.setInfoBox(new E({pixelOffset:new Q.Size(0,-20),enableEventPropagation:!0,closeBoxMargin:"10px",disableAutoPan:!0,boxStyle:{cursor:"pointer",background:"url(/static/img/infowindow-arrow.png) no-repeat 0 10px",width:this.width}}))},t.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("drawing_started",function(t){return e.disable()}),this.map.subscribe("drawing_finished",function(t){return e.enable()})},t.prototype.setInfoBox=function(e){this.infoBox=e},t.prototype.setMap=function(e){return this.map=e,this.handleMapEvents()},t.prototype.enable=function(){return this.enabled=!0},t.prototype.disable=function(){return this.close(!1),this.enabled=!1},t.prototype.open=function(e){var t,n,r,i,s,o,u,a;this.options=e!=null?e:{};if(!this.enabled)return;return this.setContent(this.options.content||(this.options.features?this.createClusterContent(this.options):this.createFeatureContent(this.options))),this.feature=(s=this.options.feature)!=null?s:(o=this.options.features)!=null?o.getAt(0):void 0,i=(u=this.options.position)!=null?u:this.feature.getCenter(),i instanceof Array&&(t=new komoo.geometries.Empty,i=t.getLatLngFromArray(i)),r=G.latLngToPoint(this.map,i),r.x+=5,n=G.pointToLatLng(this.map,r),this.infoBox.setPosition(n),this.infoBox.open((a=this.map.googleMap)!=null?a:this.map)},t.prototype.setContent=function(e){return e==null&&(e={title:"",body:""}),typeof e=="string"&&(e={title:"",url:"",body:e}),this.title.html(e.url?'<a href="'+e.url+"'\">"+e.title+"</a>":e.title),this.body.html(e.body)},t.prototype.close=function(){var e;return this.isMouseover=!1,this.infoBox.close(),((e=this.feature)!=null?e.isHighlighted():void 0)&&this.feature.setHighlight(!1),this.feature=null},t.prototype.customize=function(){var e=this;return Q.event.addDomListener(this.infoBox,"domready",function(t){var n;return n=e.infoBox.div_,Q.event.addDomListener(n,"click",function(e){return e.cancelBubble=!0,typeof e.stopPropagation=="function"?e.stopPropagation():void 0}),Q.event.addDomListener(n,"mouseout",function(t){return e.isMouseover=!1}),komoo.event.trigger(e,"domready")}),this.initDomElements()},t.prototype.initDomElements=function(){var e=this;return this.title=$("<div>"),this.body=$("<div>"),this.content=$("<div>").addClass("map-infowindow-content"),this.content.append(this.title),this.content.append(this.body),this.content.css({background:"white",padding:"10px",margin:"0 0 0 15px"}),this.content.hover(function(t){return e.isMouseover=!0},function(t){return e.isMouseover=!1}),this.infoBox.setContent(this.content.get(0))},t.prototype.createClusterContent=function(e){var t,n,r,i,s;return e==null&&(e={}),r=e.features||[],i=ngettext("%s Community","%s Communities",r.length),s="<strong>"+interpolate(i,[r.length])+"</strong>",t=function(){var e,t,i,s;i=r.slice(0,11),s=[];for(e=0,t=i.length;e<t;e++)n=i[e],s.push("<li>"+n.getProperty("name")+"</li>");return s}(),t="<ul>"+t.join("")+"</ul>",{title:s,url:"",body:t}},t.prototype.createFeatureContent=function(e){var t,n;return e==null&&(e={}),n="",t=e.feature,t&&(n=t.getProperty("name")),{title:n,url:"",body:""}},t}(l),n=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.createFeatureContent=function(e){var n,r,i=this;e==null&&(e={}),n=e.feature;if(!n)return;return n[this.contentViewName]?n[this.contentViewName]:n.getProperty("id")==null?t.__super__.createFeatureContent.call(this,e):(r=dutils.urls.resolve(this.contentViewName,{zoom:this.map.getZoom(),app_label:n.featureType.appLabel,model_name:n.featureType.modelName,obj_id:n.getProperty("id")}),$.get(r,function(e){return n[i.contentViewName]=e,i.setContent(e)}),it)},t}(s),S=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.defaultWidth="350px",t.prototype.contentViewName="info_window",t.prototype.open=function(e){var n,r;return(n=this.feature)!=null&&(n.displayTooltip=!0),t.__super__.open.call(this,e),(r=this.feature)!=null?r.displayTooltip=!1:void 0},t.prototype.close=function(e){var n,r;return e==null&&(e=!0),(n=this.feature)!=null&&n.setHighlight(!1),(r=this.feature)!=null&&(r.displayTooltip=!0),e&&this.map.enableComponents("tooltip"),t.__super__.close.call(this)},t.prototype.customize=function(){var e=this;return t.__super__.customize.call(this),Q.event.addDomListener(this.infoBox,"domready",function(t){var n,r;return r=e.content.get(0),n=e.infoBox.div_.firstChild,Q.event.addDomListener(r,"mousemove",function(t){return e.map.disableComponents("tooltip")}),Q.event.addDomListener(r,"mouseout",function(t){n=e.infoBox.div_.firstChild;if(t.toElement!==n)return e.map.enableComponents("tooltip")}),Q.event.addDomListener(n,"click",function(t){return e.close()})})},t.prototype.handleMapEvents=function(){var e=this;return t.__super__.handleMapEvents.call(this),this.map.subscribe("feature_click",function(t,n){return setTimeout(function(){return e.open({feature:n,position:t.latLng})},200)}),this.map.subscribe("feature_highlight_changed",function(t,n){if(n.isHighlighted())return e.open({feature:n})})},t}(n),V=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.contentViewName="tooltip",t.prototype.close=function(){return clearTimeout(this.timer),t.__super__.close.call(this)},t.prototype.customize=function(){var e=this;return t.__super__.customize.call(this),Q.event.addDomListener(this.infoBox,"domready",function(t){var n,r;return r=e.infoBox.div_,Q.event.addDomListener(r,"click",function(t){return t.latLng=e.infoBox.getPosition(),e.map.publish("feature_click",t,e.feature)}),n=r.firstChild,$(n).hide()})},t.prototype.handleMapEvents=function(){var e=this;return t.__super__.handleMapEvents.call(this),this.map.subscribe("feature_mousemove",function(t,n){var r;clearTimeout(e.timer);if(n===e.feature||!n.displayTooltip)return;return r=n.getType()==="Community"?400:10,e.timer=setTimeout(function(){if(!n.displayTooltip)return;return e.open({feature:n,position:t.latLng})},r)}),this.map.subscribe("feature_mouseout",function(t,n){return e.close()}),this.map.subscribe("feature_click",function(t,n){return e.close()}),this.map.subscribe("cluster_mouseover",function(t,n){var r;if((r=t.getAt(0))!=null?!r.displayTooltip:!void 0)return;return e.open({features:t,position:n})}),this.map.subscribe("cluster_mouseout",function(t,n){return e.close()}),this.map.subscribe("cluster_click",function(t,n){return e.close()})},t}(n),m=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.enabled=!0,t.prototype.maxZoom=9,t.prototype.gridSize=20,t.prototype.minSize=1,t.prototype.imagePath="/static/img/cluster/communities",t.prototype.imageSizes=[24,29,35,41,47],t.prototype.hooks={before_feature_setVisible:"beforeFeatureSetVisibleHook"},t.prototype.beforeFeatureSetVisibleHook=function(e,t){return this.map.getProjectId()!=null?[e,t]:[e,t&&this.map.getZoom()>this.maxZoom]},t.prototype.init=function(e){var t,n,r,i,s,o,u,a,f,l;return this.options=e!=null?e:{},(o=(t=this.options).gridSize)==null&&(t.gridSize=this.gridSize),(u=(n=this.options).maxZoom)==null&&(n.maxZoom=this.maxZoom),(a=(r=this.options).minimumClusterSize)==null&&(r.minimumClusterSize=this.minSize),(f=(i=this.options).imagePath)==null&&(i.imagePath=this.imagePath),(l=(s=this.options).imageSizes)==null&&(s.imageSizes=this.imageSizes),this.featureType=this.options.featureType,this.features=[],window.c=this},t.prototype.initMarkerClusterer=function(e){var t,n;return e==null&&(e={}),t=((n=this.map)!=null?n.googleMap:void 0)||this.map,window.clusterer=this.clusterer=new D(t,[],e)},t.prototype.initEvents=function(e){var t,n=this;e==null&&(e=this.clusterer);if(!e)return;return t=["clusteringbegin","clusteringend"],t.forEach(function(t){return komoo.event.addListener(e,t,function(e){return komoo.event.trigger(n,t,n)})}),t=["click","mouseout","mouseover"],t.forEach(function(t){return komoo.event.addListener(e,t,function(e){var r,i;return r=komoo.collections.makeFeatureCollection({features:function(){var t,n,r,s;r=e.getMarkers(),s=[];for(t=0,n=r.length;t<n;t++)i=r[t],s.push(i.feature);return s}()}),komoo.event.trigger(n,t,r,e.getCenter()),n.map.publish("cluster_"+t,r,e.getCenter())})})},t.prototype.setMap=function(e){return this.map=e,this.initMarkerClusterer(this.options),this.initEvents(),this.handleMapEvents()},t.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("feature_created",function(t){if(e.map.getZoom()<=e.maxZoom&&(e.featureType==null||t.getType()===e.featureType))return e.push(t)}),this.map.subscribe("idle features_loaded",function(){if(e.map.getZoom()<=e.maxZoom)return e.length===0&&e.addFeatures(e.map.getFeatures()),e.repaint()}),this.map.subscribe("features_request_completed",function(){var t;if(e.map.getZoom()<=e.maxZoom)return t=e.map.getFeatures(),e.addFeatures(t)}),komoo.event.addListener(this,"clusteringend",function(t){if(e.map.getZoom()>e.maxZoom)return e.map.features.forEach(function(e){var t;return(t=e.marker)!=null?t.setMap(null):void 0})})},t.prototype.updateLength=function(){return this.length=this.features.length},t.prototype.clear=function(){return this.features=[],this.clusterer.clearMarkers(),this.updateLength()},t.prototype.getAt=function(e){return this.features[e]},t.prototype.push=function(e){if(this.map.getProjectId()!=null)return;if(e.getMarker())return this.features.push(e),e.getMarker().setVisible(!0),this.clusterer.addMarker(e.getMarker().getOverlay().markers_.getAt(0),!0),this.updateLength()},t.prototype.pop=function(){var e;return e=this.features.pop(),this.clusterer.removeMarker(e.getMarker().getOverlay().markers_.getAt(0)),this.updateLength(),e},t.prototype.forEach=function(e,t){var n,r,i,s,o;s=this.features,o=[];for(r=0,i=s.length;r<i;r++)n=s[r],o.push(e.apply(t,n));return o},t.prototype.repaint=function(){return this.clusterer.repaint()},t.prototype.getAverageCenter=function(){return this.clusterer.getAverageCenter()},t.prototype.addFeatures=function(e){var t=this;return e!=null&&e.forEach(function(e){return t.push(e)}),this.repaint()},t}(l),f=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.push=function(e){if(e.featureType===this.map.featureTypes.Community)return t.__super__.push.call(this,e)},t}(m),L=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.enabled=!0,t.prototype.init=function(){return this.geocoder=new Q.Geocoder,this.marker=new Q.Marker({icon:"/static/img/marker.png"})},t.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("goto",function(t,n){return e.goTo(t,n)}),this.map.subscribe("goto_user_location",function(){return e.goToUserLocation()})},t.prototype.goTo=function(e,t){var n,r,i,s=this;return t==null&&(t=!1),i=function(e){if(e){s.map.googleMap.panTo(e);if(t)return s.marker.setPosition(e)}},typeof e=="string"?(r={address:e,region:this.region},this.geocoder.geocode(r,function(e,t){var n,r;if(t===Q.GeocoderStatus.OK)return n=e[0],r=n.geometry.location,i(r)})):(n=e instanceof Array?e.length===2?new Q.LatLng(e[0],e[1]):void 0:e,i(n))},t.prototype.goToUserLocation=function(){var e,t,n=this;e=google.loader.ClientLocation,e&&(t=new Q.LatLng(e.latitude,e.longitude),this.map.googleMap.setCenter(t),typeof console!="undefined"&&console!==null&&console.log("Getting location from Google..."));if(navigator.geolocation)return navigator.geolocation.getCurrentPosition(function(e){return t=new Q.LatLng(e.coords.latitude,e.coords.longitude),n.map.googleMap.setCenter(t),typeof console!="undefined"&&console!==null?console.log("Getting location from navigator.geolocation..."):void 0},function(){return typeof console!="undefined"&&console!==null?console.log("User denied access to navigator.geolocation..."):void 0})},t.prototype.setMap=function(e){return this.map=e,this.marker.setMap(this.map.googleMap),this.handleMapEvents()},t.prototype.enable=function(){return this.enabled=!0},t.prototype.disable=function(){return this.close(!1),this.enabled=!1},t}(l),R=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.handleMapEvents=function(){var e=this;return t.__super__.handleMapEvents.call(this),this.map.subscribe("save_location",function(t,n){return e.saveLocation(t,n)}),this.map.subscribe("goto_saved_location",function(){return e.goToSavedLocation()})},t.prototype.saveLocation=function(e,t){return e==null&&(e=this.map.googleMap.getCenter()),t==null&&(t=this.map.getZoom()),G.createCookie("lastLocation",e.toUrlValue(),90),G.createCookie("lastZoom",t,90)},t.prototype.goToSavedLocation=function(){var e,t;e=G.readCookie("lastLocation"),t=parseInt(G.readCookie("lastZoom"),10);if(e&&t)return typeof console!="undefined"&&console!==null&&console.log("Getting location from cookie..."),this.map.publish("set_location",e),this.map.publish("set_zoom",t)},t}(L),r=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.handleMapEvents=function(){var e=this;return t.__super__.handleMapEvents.call(this),this.map.subscribe("idle",function(){return e.saveLocation()})},t}(R),U=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.setMap=function(e){var t;this.map=e,this.handleMapEvents(),t=this.getSavedMapType();if(__indexOf.call(_.values(Q.MapTypeId),t)>=0)return this.useSavedMapType()},t.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("maptype_loaded",function(t){if(t===e.getSavedMapType())return e.map.googleMap.setMapTypeId(t)}),this.map.subscribe("initialized",function(){return e.useSavedMapType()})},t.prototype.saveMapType=function(e){return e==null&&(e=this.map.getMapTypeId()),G.createCookie("mapTypeId",e,Q.MapTypeId.ROADMAP)},t.prototype.getSavedMapType=function(){return G.readCookie("mapTypeId")},t.prototype.useSavedMapType=function(){var e;return e=this.getSavedMapType(),typeof console!="undefined"&&console!==null&&console.log("Getting map type from cookie..."),this.map.googleMap.setMapTypeId(e)},t}(l),i=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.handleMapEvents=function(){var e=this;return t.__super__.handleMapEvents.call(this),this.map.subscribe("maptypeid_changed",function(){return e.saveMapType()})},t}(U),W=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.enabled=!0,t.prototype.init=function(){return typeof console!="undefined"&&console!==null&&console.log("Initializing StreetView support."),this.streetViewPanel=$("<div>").addClass("map-panel"),this.streetViewPanel.height("100%").width("50%"),this.streetViewPanel.hide(),this.createObject()},t.prototype.setMap=function(e){this.map=e,this.map.googleMap.controls[Q.ControlPosition.TOP_LEFT].push(this.streetViewPanel.get(0));if(this.streetView!=null)return this.map.googleMap.setStreetView(this.streetView)},t.prototype.createObject=function(){var e,t,n=this;return e={enableCloseButton:!0,visible:!1},this.streetView=new Q.StreetViewPanorama(this.streetViewPanel.get(0),e),(t=this.map)!=null&&t.googleMap.setStreetView(this.streetView),Q.event.addListener(this.streetView,"visible_changed",function(){return n.streetView.getVisible()?n.streetViewPanel.show():n.streetViewPanel.hide(),n.map.refresh()})},t}(l),g=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.hooks={before_feature_setVisible:"beforeFeatureSetVisibleHook"},t.prototype.init=function(){return typeof this.handleMapEvents=="function"?this.handleMapEvents():void 0},t.prototype.beforeFeatureSetVisibleHook=function(e,t){return[e,t]},t}(l),b=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.hooks={before_feature_setVisible:"beforeFeatureSetVisibleHook"},t.prototype.beforeFeatureSetVisibleHook=function(e,t){var n,r;return this.map.getProjectId()!=null?[e,t]:(r=this.map.getZoom(),n=t&&(e.featureType.minZoomPoint<=r&&e.featureType.maxZoomPoint>=r||e.featureType.minZoomGeometry<=r&&e.featureType.maxZoomGeometry>=r),[e,n])},t}(g),y=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.hooks={before_feature_setVisible:"beforeFeatureSetVisibleHook"},t.prototype.init=function(){return t.__super__.init.call(this),this.disabled=["User"]},t.prototype.beforeFeatureSetVisibleHook=function(e,t){var n,r;return n=t,t&&(r=e.featureType.type,__indexOf.call(this.disabled,r)>=0)&&(n=!1),[e,n]},t.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("hide_features_by_type",function(t,n,r){if(__indexOf.call(e.disabled,t)<0)return e.disabled.push(t)}),this.map.subscribe("show_features_by_type",function(t,n,r){var i;if(__indexOf.call(e.disabled,t)>=0)return i=_.indexOf(e.disabled,t),e.disabled.splice(i,1)})},t}(g),N=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.hooks={before_feature_setVisible:"beforeFeatureSetVisibleHook"},t.prototype.init=function(){return t.__super__.init.call(this),this.disabled=[]},t.prototype.beforeFeatureSetVisibleHook=function(e,t){var n;return n=t,t!==this.map.getLayers().shouldFeatureBeVisible(e)&&(n=!t),[e,n]},t.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("show_layer",function(t){if(__indexOf.call(e.disabled,t)<0)return e.disabled.push(t)}),this.map.subscribe("hide_layer",function(t){var n;if(__indexOf.call(e.disabled,t)>=0)return n=_.indexOf(e.disabled,t),e.disabled.splice(n,1)})},t}(g),window.komoo.controls={DrawingManager:p,DrawingControl:h,GeometrySelector:w,Balloon:s,AjaxBalloon:n,InfoWindow:S,Tooltip:V,FeatureClusterer:m,CommunityClusterer:f,CloseBox:a,LoadingBox:k,SupporterBox:X,LicenseBox:C,SearchBox:z,LayersBox:T,PerimeterSelector:q,Location:L,SaveLocation:R,AutosaveLocation:r,SaveMapType:U,AutosaveMapType:i,StreetView:W,FeatureFilter:g,FeatureZoomFilter:b,FeatureTypeFilter:y,LayersFilter:N},window.komoo.controls});var __hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};define("map/maptypes",["require","googlemaps","./component"],function(e){var t,n,r,i,s,o;return r=e("googlemaps"),n=e("./component"),(s=window.komoo)==null&&(window.komoo={}),(o=(i=window.komoo).event)==null&&(i.event=r.event),t=function(e){function t(){this.mapType=new r.StyledMapType([{featureType:"poi",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"road",elementType:"all",stylers:[{lightness:70}]},{featureType:"transit",elementType:"all",stylers:[{lightness:50}]},{featureType:"water",elementType:"all",stylers:[{lightness:50}]},{featureType:"administrative",elementType:"labels",stylers:[{lightness:30}]}],{name:gettext("Clean")})}return __extends(t,e),t.prototype.id="clean",t.prototype.setMap=function(e){var t;return this.map=e,this.map.googleMap.mapTypes.set(this.id,this.mapType),t=this.map.googleMap.mapTypeControlOptions,t!=null&&(t.mapTypeIds.push(this.id),this.map.googleMap.setOptions({mapTypeControlOptions:t})),this.map.publish("maptype_loaded",this.id)},t}(n),window.komoo.maptypes={CleanMapType:t},window.komoo.maptypes});var __hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};define("map/providers",["require","googlemaps","./component"],function(e){var t,n,r,i,s,o,u,a;return s=e("googlemaps"),t=e("./component"),(u=window.komoo)==null&&(window.komoo={}),(a=(o=window.komoo).event)==null&&(o.event=s.event),n=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.name="Generic Provider",t.prototype.alt="Generic Data Provider",t.prototype.tileSize=new s.Size(256,256),t.prototype.maxZoom=32,t.prototype.expiration=6e5,t.prototype.enabled=!0,t.prototype.init=function(e){return this.options=e,this.addrLatLngCache={},this.fetchedTiles={}},t.prototype.setMap=function(e){return this.map=e,this.map.googleMap.overlayMapTypes.insertAt(0,this),typeof this.handleMapEvents=="function"?this.handleMapEvents():void 0},t.prototype.enable=function(){return this.enabled=!0},t.prototype.disable=function(){return this.enabled=!1},t.prototype.getUrl=function(e,t){var n,r;return n=this.getAddrLatLng(e,t),r=this.fetchUrl+n,this.map.getProjectId()&&(r+="&project="+this.map.getProjectId()),r},t.prototype.getAddrLatLng=function(e,t){var n,r,i,o,u,a,f;return n="x="+e.x+",y="+e.y+",z="+t,this.addrLatLngCache[n]?this.addrLatLngCache[n]:(i=1<<t,a=this.map.googleMap.getProjection(),o=new s.Point((e.x+1)*this.tileSize.width/i,e.y*this.tileSize.height/i),u=new s.Point(e.x*this.tileSize.width/i,(e.y+1)*this.tileSize.height/i),r=a.fromPointToLatLng(o),f=a.fromPointToLatLng(u),this.addrLatLngCache[n]="bounds="+r.toUrlValue()+","+f.toUrlValue()+"&zoom="+t)},t}(t),r=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.name="Feature Provider",t.prototype.alt="Feature Provider",t.prototype.fetchUrl="/get_geojson?",t.prototype.init=function(e){return t.__super__.init.call(this,e),this.keptFeatures=komoo.collections.makeFeatureCollection(),window.kf=this.keptFeatures,this.openConnections=0,this._addrs=[],this._requestQueue={}},t.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("idle",function(){var t;return t=e.map.googleMap.getBounds(),e.keptFeatures.forEach(function(e){if(!t.intersects(e.getBounds()))return e.setOutOfBounds(!0)}),e.keptFeatures.clear()}),this.map.subscribe("zoom_changed",function(){var t,n,r,i;r=e._requestQueue,i=[];for(t in r)n=r[t],i.push(n!=null?n.abort():void 0);return i})},t.prototype.releaseTile=function(e){var t,n=this;if(this.enabled===!1)return;if(this.fetchedTiles[e.addr])return t=this.map.getBounds(),this.map.data.when(this.fetchedTiles[e.addr].features).then(function(e){return e.forEach(function(e){if(e.getBounds){if(!t.intersects(e.getBounds()))return e.setOutOfBounds(!0);if(!t.contains(e.getBounds().getNorthEast()||!t.contains(e.getBounds().getSouthWest())))return n.keptFeatures.push(e),e.setOutOfBounds(!1)}else if(e.getPosition&&!t.contains(e.getPosition()))return e.setOutOfBounds(!0)})})},t.prototype.getTile=function(e,t,n){var r,i,s,o=this;return s=n.createElement("DIV"),r=this.getAddrLatLng(e,t),s.addr=r,this.enabled===!1||this.map.options.ajax===!1?(this.map.publish("features_request_completed"),s):(i=new Date,this.fetchedTiles[r]&&i-this.fetchedTiles[r].date<=this.expiration?(this.fetchedTiles[r].features.setOutOfBounds(!1),s):(this.openConnections===0&&this.map.publish("features_request_started"),this.openConnections++,this.map.publish("features_request_queued"),this._requestQueue[r]=$.ajax({url:this.getUrl(e,t),dataType:"json",type:"GET",success:function(e){var t;return t=o.map.data.deferred(),o._addrs.push(r),o.fetchedTiles[r]={geojson:e,features:t.promise(),date:new Date}},error:function(e,t){var n,r;if(t==="abort")return;return typeof console!="undefined"&&console!==null&&console.error("[provider - ajax error] "+t),r=$("#server-error"),r.parent().length===0&&(r=$("<div>").attr("id","server-error"),$("body").append(r)),n=$("<div>").html(e.responseText),r.append(n)},complete:function(){var e,t,n;o.map.publish("features_request_unqueued"),o.openConnections--;if(o.openConnections===0){o.map.publish("features_request_completed");while(o._addrs.length>0)r=o._addrs.pop(),e=o.fetchedTiles[r].geojson,t=o.map.loadGeoJSON(JSON.parse(e),!1,!0,!0),t.setOutOfBounds(!1),t.show(),typeof (n=o.fetchedTiles[r].features).resolve=="function"&&n.resolve(t),o.fetchedTiles[r].features=t;return o._requestQueue[r]=void 0,o.map.publish("features_loaded",o.map.getFeatures())}}}),s))},t}(n),i=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.getUrl=function(e,n){var r,i,s,o,u;r=t.__super__.getUrl.call(this,e,n),o=[],u=this.map.featureTypes;for(s in u)i=u[s],(this.map.getProjectId()!=null||s==="Community"||i.minZoomPoint<=n&&i.maxZoomPoint>=n||i.minZoomGeometry<=n&&i.maxZoomGeometry>=n)&&o.push(""+i.appLabel+"."+i.modelName);return r+="&models="+o.join(",")},t}(r),window.komoo.providers={GenericProvider:n,TileFeatureProvider:r,ZoomFilteredFeatureProvider:i,makeFeatureProvider:function(e){return new FeatureProvider(e)}},window.komoo.providers});var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},__indexOf=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};define("map/maps",["require","googlemaps","underscore","./core","./collections","./features","./layers","./geometries","./controls","./maptypes","./providers"],function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g;return h=e("googlemaps"),d=e("underscore"),f=e("./core"),a=e("./collections"),l=e("./features"),p=e("./layers"),c=e("./geometries"),e("./controls"),e("./maptypes"),e("./providers"),(m=window.komoo)==null&&(window.komoo={}),(g=(v=window.komoo).event)==null&&(v.event=h.event),i=function(e){function t(e){var n;this.options=e!=null?e:{},this.addFeature=__bind(this.addFeature,this),t.__super__.constructor.call(this),this.element=(n=this.options.element)!=null?n:document.getElementById(this.options.elementId),this.features=a.makeFeatureCollectionPlus({map:this}),this.components={},this.setProjectId(this.options.projectId),this.initGoogleMap(this.options.googleMapOptions),this.initLayers(),this.initFeatureTypes(),this.handleEvents(),this.addComponents(["map/controls::Location",["map/controls::LayersBox","panel",{el:"#map-panel-layers"}],"map/controls::LayersFilter"])}return __extends(t,e),t.prototype.featureTypesUrl="/map_info/feature_types/",t.prototype.layersUrl="/map_info/layers/",t.prototype.projectUrl="/map_info/project/",t.prototype.googleMapDefaultOptions={zoom:12,center:new h.LatLng(-23.55,-46.65),disableDefaultUI:!1,streetViewControl:!0,scaleControl:!0,panControlOptions:{position:h.ControlPosition.RIGHT_TOP},zoomControlOptions:{position:h.ControlPosition.RIGHT_TOP},scaleControlOptions:{position:h.ControlPosition.RIGHT_BOTTOM,style:h.ScaleControlStyle.DEFAULT},mapTypeControlOptions:{mapTypeIds:[h.MapTypeId.ROADMAP,h.MapTypeId.HYBRID]},mapTypeId:h.MapTypeId.HYBRID},t.prototype.addControl=function(e,t){return this.googleMap.controls[e].push(t)},t.prototype.loadGeoJsonFromOptions=function(){var e,t;if(this.options.geojson)return t=this.loadGeoJSON(this.options.geojson,this.options.zoom==null),e=t.getBounds(),e!=null&&this.projectInfo==null&&this.fitBounds(e),t!=null&&t.setMap(this,{geometry:!0,icon:!0}),this.publish("set_zoom",this.options.zoom)},t.prototype.initGoogleMap=function(e){return e==null&&(e=this.googleMapDefaultOptions),this.googleMap=new h.Map(this.element,e),this.handleGoogleMapEvents(),$(this.element).trigger("initialized",this)},t.prototype.handleGoogleMapEvents=function(){var e,t=this;return e=["click","idle","maptypeid_changed","zoom_changed"],e.forEach(function(e){return komoo.event.addListener(t.googleMap,e,function(n){return t.publish(e,n)})})},t.prototype.initFeatureTypes=function(){var e,t,n=this;return(e=this.featureTypes)==null&&(this.featureTypes={}),this.options.featureTypes!=null?((t=this.options.featureTypes)!=null&&t.forEach(function(e){return n.featureTypes[e.type]=e}),this.loadGeoJsonFromOptions()):$.ajax({url:this.featureTypesUrl,dataType:"json",success:function(e){return e.forEach(function(e){return n.featureTypes[e.type]=e}),n.loadGeoJsonFromOptions()}})},t.prototype.initLayers=function(){var e,t;return(e=this.layers)==null&&(this.layers=new p.Layers),this.layers.setMap(this),this.options.layers!=null?this.loadLayersFromOptions(this.options):this.loadRemoteLayers(this.layersUrl+((t=this.getProjectId())!=null?t:""))},t.prototype.loadLayer=function(e){var t;return t=this.layers.loadLayer(e),this.publish("layer_loaded",t),t},t.prototype.loadLayers=function(e){var t=this;return p=[],e.forEach(function(e){return p.push(t.loadLayer(e))}),p},t.prototype.loadLayersFromOptions=function(e){return this.loadLayers(e.layers)},t.prototype.loadRemoteLayers=function(e){var t=this;return $.ajax({url:e,dataType:"json",success:function(e){return t.loadLayers(e)}})},t.prototype.getLayers=function(){return this.layers},t.prototype.getLayer=function(e){return this.layers.getLayer(e)},t.prototype.showLayer=function(e){return d.isString(e)&&(e=this.getLayer(e)),e.show(),this.publish("show_layer",e)},t.prototype.hideLayer=function(e){return d.isString(e)&&(e=this.getLayer(e)),e.hide(),this.publish("hide_layer",e)},t.prototype.handleEvents=function(){var e=this;return this.subscribe("features_loaded",function(t){return komoo.event.trigger(e,"features_loaded",t)}),this.subscribe("close_clicked",function(){return komoo.event.trigger(e,"close_click")}),this.subscribe("drawing_started",function(t){return komoo.event.trigger(e,"drawing_started",t)}),this.subscribe("drawing_finished",function(t,n){komoo.event.trigger(e,"drawing_finished",t,n);if(n===!1)return e.revertFeature(t);if(t.getProperty("id")==null)return e.addFeature(t)}),this.subscribe("set_location",function(t){var n;return t=t.split(","),n=new h.LatLng(t[0],t[1]),e.googleMap.setCenter(n)}),this.subscribe("set_zoom",function(t){return e.setZoom(t)}),this.subscribe("idle",function(t){return e.getFeatures().setVisible(!0)})},t.prototype.addComponent=function(e,t,n){var r,i=this;return t==null&&(t="generic"),n==null&&(n={}),r=d.isString(e)?this.start(e,n.el,n):this.start(e),this.data.when(r).done(function(){var e,n,r,s,o,u;u=[];for(r=0,s=arguments.length;r<s;r++)e=arguments[r],e.setMap(i),(o=(n=i.components)[t])==null&&(n[t]=[]),i.components[t].push(e),u.push(typeof e.enable=="function"?e.enable():void 0);return u})},t.prototype.addComponents=function(e){var t,n,r,i,s,o,u,a,f=this;n=[];for(i=0,s=e.length;i<s;i++)t=e[i],d.isString(t)&&(t=[t]),r=(o=t[2])!=null?o:{},(u=r.type)==null&&(r.type=(a=t[1])!=null?a:"generic"),n.push({component:t[0],el:r.el,opts:r});return this.data.when(this.start(n)).done(function(){var e,t,n,r,i,s,o;o=[];for(n=0,r=arguments.length;n<r;n++)e=arguments[n],typeof e.setMap=="function"&&e.setMap(f),(s=(t=f.components)[i=e.type])==null&&(t[i]=[]),f.components[e.type].push(e),o.push(typeof e.enable=="function"?e.enable():void 0);return o})},t.prototype.enableComponents=function(e){var t,n=this;return(t=this.components[e])!=null?t.forEach(function(e){return typeof e.enable=="function"?e.enable():void 0}):void 0},t.prototype.disableComponents=function(e){var t,n=this;return(t=this.components[e])!=null?t.forEach(function(e){return typeof e.disable=="function"?e.disable():void 0}):void 0},t.prototype.getComponentsStatus=function(e){var t,n,r=this;return t=[],(n=this.components[e])!=null&&n.forEach(function(e){if(e.enabled===!0)return t.push("enabled")}),__indexOf.call(t,"enabled")>=0?"enabled":"disabled"},t.prototype.clear=function(){return this.features.removeAllFromMap(),this.features.clear()},t.prototype.refresh=function(){var e;return h.event.trigger(this.googleMap,"resize"),(e=this.layers)!=null?e.refresh():void 0},t.prototype.saveLocation=function(e,t){return e==null&&(e=this.googleMap.getCenter()),t==null&&(t=this.getZoom()),this.publish("save_location",e,t)},t.prototype.goToSavedLocation=function(){return this.publish("goto_saved_location"),!0},t.prototype.goToUserLocation=function(){return this.publish("goto_user_location")},t.prototype.handleFeatureEvents=function(e){var t,n=this;return t=["mouseover","mouseout","mousemove","click","dblclick","rightclick","highlight_changed"],t.forEach(function(t){return komoo.event.addListener(e,t,function(r){return n.publish("feature_"+t,r,e)})})},t.prototype.goTo=function(e,t){return t==null&&(t=!0),this.publish("goto",e,t)},t.prototype.panTo=function(e,t){return t==null&&(t=!1),this.goTo(e,t)},t.prototype.makeFeature=function(e,t){var n;return t==null&&(t=!0),n=l.makeFeature(e,this.featureTypes),t&&this.addFeature(n),this.publish("feature_created",n),n},t.prototype.addFeature=function(e){return this.handleFeatureEvents(e),this.features.push(e),this.publish("feature_added",e)},t.prototype.revertFeature=function(e){if(e.getProperty("id")==null)return e.setMap(null)},t.prototype.getFeatures=function(){return this.features},t.prototype.showFeatures=function(e){return e==null&&(e=this.features),e.show()},t.prototype.hideFeatures=function(e){return e==null&&(e=this.features),e.hide()},t.prototype.centerFeature=function(e,t){var n;return n=e instanceof l.Feature?e:this.features.getById(e,t),this.panTo(n!=null?n.getCenter():void 0,!1)},t.prototype.loadGeoJson=function(e,t,n,r){var i,s,o=this;return t==null&&(t=!1),n==null&&(n=!0),r==null&&(r=!1),i=a.makeFeatureCollection({map:this}),(e!=null?e.type:void 0)==null||!e.type==="FeatureCollection"?i:((s=e.features)!=null&&s.forEach(function(e){var t;t=o.features.getById(e.properties.type,e.properties.id),t==null&&(t=o.makeFeature(e,n)),i.push(t),t.setVisible(!0);if(n)return t.setMap(o)}),t&&i.getBounds()!=null&&this.fitBounds(),r||this.publish("features_loaded",i),i)},t.prototype.loadGeoJSON=function(e,t,n,r){return this.loadGeoJson(e,t,n,r)},t.prototype.getGeoJson=function(e){var t,n,r,i;return e==null&&(e={}),(n=e.newOnly)==null&&(e.newOnly=!1),(r=e.currentOnly)==null&&(e.currentOnly=!1),(i=e.geometryCollection)==null&&(e.geometryCollection=!1),t=e.newOnly?this.newFeatures:e.currentOnly?a.makeFeatureCollection({map:this.map,features:[this.currentFeature]}):this.features,t.getGeoJson({geometryCollection:e.geometryCollection})},t.prototype.getGeoJSON=function(e){return this.getGeoJson(e)},t.prototype.drawNewFeature=function(e,t){var n;return n=this.makeFeature({type:"Feature",geometry:{type:e},properties:{name:"New "+t,type:t}}),this.publish("draw_feature",e,n)},t.prototype.editFeature=function(e,t){return e==null&&(e=this.features.getAt(0)),t!=null&&e.getGeometryType()===c.types.EMPTY?(e.setGeometry(c.makeGeometry({geometry:{type:t}})),this.publish("draw_feature",t,e)):this.publish("edit_feature",e)},t.prototype.setMode=function(e){return this.mode=e,this.publish("mode_changed",this.mode)},t.prototype.selectCenter=function(e,t){return this.selectPerimeter(e,t)},t.prototype.selectPerimeter=function(e,t){return this.publish("select_perimeter",e,t)},t.prototype.highlightFeature=function(){return this.centerFeature.apply(this,arguments),this.features.highlightFeature.apply(this.features,arguments)},t.prototype.getBounds=function(){return this.googleMap.getBounds()},t.prototype.getZoom=function(){return this.googleMap.getZoom()},t.prototype.setZoom=function(e){if(e!=null)return this.googleMap.setZoom(e)},t.prototype.getCenter=function(){var e;return e=this.googleMap.getCenter(),[e.lat(),e.lng()]},t.prototype.setMapType=function(e){return this.googleMap.setMapTypeId(e)},t.prototype.getMapType=function(){return this.googleMap.getMapTypeId()},t.prototype.getMapTypeId=function(){return this.googleMap.getMapTypeId()},t.prototype.fitBounds=function(e,t){var n,r,i,s,o,u,a,f,l,c,p;return t==null&&(t=!1),e||(this.projectInfo?this.projectInfo.custom_bbox!=null?(e=(p=this.projectInfo.custom_bbox)!=null?p:this.projectInfo.bbox,t=!0):e=this.projectInfo.bbox:e=this.features.getBounds()),d.isArray(e)&&(c=new h.LatLng(e[1],e[0]),l=new h.LatLng(e[3],e[2]),e=new h.LatLngBounds(c,l)),t&&(c=e.getSouthWest(),l=e.getNorthEast(),o=c.lat(),a=c.lng(),u=l.lat(),f=l.lng(),i=(a-f)/2,s=(o-u)/2,n=(a+f)/2,r=(o+u)/2,a=n+i/1.4,f=n-i/1.4,o=r+s/1.4,u=r-s/1.4,c=new google.maps.LatLng(o,a),l=new google.maps.LatLng(u,f),e=new google.maps.LatLngBounds(c,l)),this.googleMap.fitBounds(e)},t.prototype.getProjectId=function(){return this.projectId},t.prototype.setProjectId=function(e){return this.projectId=e,this._applyProjectConfig()},t.prototype._applyProjectConfig=function(){var e=this;if(this.projectId==null)return;return $.ajax({url:this.projectUrl+this.projectId,dataType:"json",success:function(t){return e.projectInfo=t,console.log("applying project config"),e.setMapType(t.maptype),t.custom_bbox?e.fitBounds(t.custom_bbox,!0):e.fitBounds(t.bbox)}})},t}(f.Mediator),u=function(e){function t(e){t.__super__.constructor.call(this,e),this.addComponents(["map/controls::AutosaveMapType",["map/maptypes::CleanMapType","mapType"],["map/controls::DrawingManager","drawing"],"map/controls::SearchBox"])}return __extends(t,e),t.prototype.type="editor",t}(i),r=function(e){function t(e){t.__super__.constructor.call(this,e),this.addComponents(["map/controls::AutosaveMapType","map/maptypes::CleanMapType","map/controls::SaveLocation","map/controls::StreetView","map/controls::DrawingManager","map/controls::DrawingControl","map/controls::GeometrySelector","map/controls::PerimeterSelector","map/controls::SearchBox"])}return __extends(t,e),t.prototype.type="view",t}(i),s=function(e){function t(e){t.__super__.constructor.call(this,e),this.addComponents([["map/maptypes::CleanMapType","mapType"]])}return __extends(t,e),t.prototype.type="preview",t.prototype.googleMapDefaultOptions={zoom:12,center:new h.LatLng(-23.55,-46.65),disableDefaultUI:!0,streetViewControl:!1,scaleControl:!0,scaleControlOptions:{position:h.ControlPosition.RIGHT_BOTTOM,style:h.ScaleControlStyle.DEFAULT},mapTypeId:h.MapTypeId.HYBRID},t}(i),o=function(e){function t(e){t.__super__.constructor.call(this,e),this.addComponents(["map/controls::AutosaveMapType",["map/maptypes::CleanMapType","mapType"],"map/controls::AutosaveLocation","map/controls::StreetView",["map/controls::Tooltip","tooltip"],["map/controls::InfoWindow","infoWindow"],"map/controls::LicenseBox","map/controls::SearchBox"])}return __extends(t,e),t.prototype.type="view",t}(i),n=function(e){function t(e){t.__super__.constructor.call(this,e),this.addComponents(["map/controls::LoadingBox",["map/providers::ZoomFilteredFeatureProvider","provider"],["map/controls::CommunityClusterer","clusterer",{map:this}],"map/controls::FeatureZoomFilter"])}return __extends(t,e),t.prototype.type="view",t}(o),t=function(e){function t(e){t.__super__.constructor.call(this,e),this.addComponents(["map/controls::DrawingManager","map/controls::DrawingControl","map/controls::GeometrySelector","map/controls::PerimeterSelector"]),this.goToSavedLocation()||this.goToUserLocation()}return __extends(t,e),t.prototype.type="editor",t}(n),window.komoo.maps={Map:i,Preview:s,AjaxMap:n,makeMap:function(e){var n,i;e==null&&(e={}),n=(i=e.type)!=null?i:"map";if(n==="main")return new t(e);if(n==="editor")return new r(e);if(n==="view")return new o(e);if(n==="static")return new o(e);if(n==="preview"||n==="tooltip")return new s(e);if(n==="userEditor")return new u(e)}},window.komoo.maps}),define("map.jquery",["jquery","map/maps"],function(e,t){return function(e){var n,r,i,s;return r=function(e){var t;return t=e.data.map,n(t),i(t),t.refresh()},n=function(t,n){var r,i;return n==null&&(n=e("#map-panel")),r=e("body").innerHeight()-e("#top").innerHeight()-e(".mootiro_bar").innerHeight()-5,e(t.element).height(r),n.height(r),i=e(".panel-info-wrapper"),i&&(r-=i.height()+30),e(".panel",n).height(r-146)},i=function(t,n){var r,i;n==null&&(n=e("#map-panel")),i=n.innerWidth();try{r=n.position().left}catch(s){r=0}return e(t.element).css({marginLeft:i+r,width:"auto"})},s={init:function(n){return this.each(function(){var i,s,o,u,a,f;i=e(this),i.addClass("komoo-map-googlemap"),o=e.extend({element:i.get(0)},e.fn.komooMap.defaults,n),o.width!=null&&i.width(o.width),o.height!=null&&i.height(o.height);if((o!=null?o.type:void 0)==="preview"&&(((u=o.geojson)!=null?u.features.length:void 0)===0||((a=o.geojson)!=null?a.features.length:void 0)===1&&((f=o.geojson.features[0])!=null?!f.geometry:!void 0))&&(o!=null?!o.force:!void 0)){i.html(e("<div>").addClass("placeholder").text("Informação geométrica não disponível"));return}s=t.makeMap(o),i.data("map",s),o.mapType!=null&&s.setMapType(o.mapType),o.height==="100%"&&(e(window).resize({map:s},r),e(window).resize());if(o.project!=null)return s.setProjectId(o.project)})},edit:function(t){var n;return(n=e(this).data("map"))!=null&&n.editFeature(t),e(this)},geojson:function(t){var n,r;return t==null?(n=e(this).data("map"))!=null?n.getGeoJson():void 0:(r=e(this).data("map"))!=null?r.loadGeoJson(t):void 0},goTo:function(t){var n,r;return(n=e(this).data("map"))!=null&&n.panTo((r=t.position)!=null?r:t.address,t.displayMarker),e(this)},highlight:function(t){var n;return(n=e(this).data("map"))!=null&&n.highlightFeature(t.type,t.id),e(this)},resize:function(){return e(window).resize()}},e.fn.komooMap=function(t){return s[t]?s[t].apply(this,Array.prototype.slice.call(arguments,1)):typeof t=="object"||!t?s.init.apply(this,arguments):e.error("Method "+t+" does not exist on jQuery.komooMap")},e.fn.komooMap.defaults={type:"editor"}}(e)}),function(){define("app",["map.jquery"],{})}.call(this);