// Generated by CoffeeScript 1.4.0
var __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; },
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

define(function(require) {
  'use strict';

  var Layer, Layers, and_ops, collections, contains_ops, equal_ops, eval_expr, in_ops, layers, not_equal_ops, not_ops, or_ops, static_path, _;
  collections = require('./collections');
  _ = require('underscore');
  static_path = '/static/';
  equal_ops = ['==', 'is', 'equal', 'equals'];
  not_equal_ops = ['!=', 'isnt', 'not equal', 'not equals', 'different'];
  in_ops = ['in'];
  contains_ops = ['contains', 'has'];
  not_ops = ['!', 'not'];
  or_ops = ['or'];
  and_ops = ['and'];
  eval_expr = function(expr, obj) {
    var objValue, operator, res, v, _i, _len, _ref, _ref1;
    if (!(expr != null) || !(expr.operator != null)) {
      return true;
    }
    if (!(obj != null)) {
      return false;
    }
    operator = expr.operator;
    objValue = obj.getProperty(expr.property);
    if (__indexOf.call(equal_ops, operator) >= 0) {
      return objValue === expr.value;
    } else if (__indexOf.call(not_equal_ops, operator) >= 0) {
      return !objValue === expr.value;
    } else if (__indexOf.call(in_ops, operator) >= 0) {
      return (objValue != null) && __indexOf.call(expr.value, objValue) >= 0;
    } else if (__indexOf.call(contains_ops, operator) >= 0 && Object.prototype.toString.call(expr.value) === '[object Array]') {
      res = true;
      _ref = expr.value;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        v = _ref[_i];
        res = res && (objValue != null) && __indexOf.call(objValue, v) >= 0;
      }
      return res;
    } else if (__indexOf.call(contains_ops, operator) >= 0) {
      return objValue && (_ref1 = expr.value, __indexOf.call(objValue, _ref1) >= 0);
    } else if (__indexOf.call(not_ops, operator) >= 0) {
      return !eval_expr(expr.child, obj);
    } else if (__indexOf.call(or_ops, operator) >= 0) {
      return eval_expr(expr.left, obj) || eval_expr(expr.right, obj);
    } else if (__indexOf.call(and_ops, operator) >= 0) {
      return eval_expr(expr.left, obj) && eval_expr(expr.right, obj);
    }
  };
  window.ee = eval_expr;
  Layers = (function(_super) {

    __extends(Layers, _super);

    function Layers() {
      Layers.__super__.constructor.call(this);
      this.othersLayer = this.loadLayer({
        id: 'Others',
        name: gettext('Others'),
        position: 100
      });
      window.o = this.othersLayer;
    }

    Layers.prototype.updateOthersLayerRule = function() {
      var rule, _ref,
        _this = this;
      rule = void 0;
      this.forEach(function(layer) {
        var not_;
        if (layer === _this.othersLayer || !(layer.getRule() != null)) {
          return;
        }
        not_ = {
          operator: 'not',
          child: layer.getRule()
        };
        return rule = rule != null ? {
          operator: 'and',
          left: rule,
          right: not_
        } : not_;
      });
      return (_ref = this.othersLayer) != null ? _ref.setRule(rule) : void 0;
    };

    Layers.prototype.sort = function(compareFunction) {
      if (compareFunction != null) {
        return Layers.__super__.sort.call(this, compareFunction);
      }
      return Layers.__super__.sort.call(this, function(a, b) {
        var aPos, bPos, _ref, _ref1;
        aPos = (_ref = a.getPosition()) != null ? _ref : 0;
        bPos = (_ref1 = b.getPosition()) != null ? _ref1 : 0;
        if (aPos < bPos) {
          return -1;
        }
        if (aPos > bPos) {
          return 1;
        }
        return 0;
      });
    };

    Layers.prototype.addLayer = function(layer) {
      var _ref;
      if (!this.contains(layer)) {
        this.push(layer);
      }
      this.updateOthersLayerRule();
      this.sort();
      layer.setLayersCollection(this);
      this._resetCache();
      return (_ref = layer.map) != null ? _ref.publish('layer_added', layer) : void 0;
    };

    Layers.prototype.getLayer = function(id) {
      var layers;
      layers = this.filter(function(layer) {
        return layer.getId() === id || layer.getName() === id;
      });
      return layers.first;
    };

    Layers.prototype.showLayer = function(name) {
      return this.getLayer(name).show();
    };

    Layers.prototype.hideLayer = function(name) {
      return this.getLayer(name).hide();
    };

    Layers.prototype.showAll = function() {
      return this.forEach(function(layer) {
        return layer.show();
      });
    };

    Layers.prototype.hideAll = function() {
      return this.forEach(function(layer) {
        return layer.hide();
      });
    };

    Layers.prototype.getVisibleLayers = function() {
      return this.filter(function(layer) {
        return layer.visible;
      });
    };

    Layers.prototype.getHiddenLayers = function() {
      return this.filter(function(layer) {
        return !layer.visible;
      });
    };

    Layers.prototype.shouldFeatureBeVisible = function(feature) {
      var layers, visible,
        _this = this;
      if (feature.isOutOfBounds()) {
        return false;
      }
      if (this.length === 0) {
        return true;
      }
      visible = false;
      layers = this._getFromCache(feature);
      layers.forEach(function(layerId) {
        var layer, visible_;
        layer = _this.getLayer(layerId);
        if (!layer.isVisible()) {
          return;
        }
        visible_ = layer.isVisible();
        if (visible_ && (!visible || layer.isImportant())) {
          _this._updateFeatureStyle(feature, layer);
        }
        return visible || (visible = visible_);
      });
      if (layers.length === 0) {
        visible = true;
      }
      return visible;
    };

    Layers.prototype.setCollection = function(collection) {
      var _this = this;
      this.collection = collection;
      return this.forEach(function(layer) {
        return layer.setCollection(_this.collection);
      });
    };

    Layers.prototype.getCollection = function() {
      var _ref, _ref1, _ref2;
      return (_ref = (_ref1 = this.collection) != null ? _ref1 : (_ref2 = this.map) != null ? _ref2.getFeatures() : void 0) != null ? _ref : [];
    };

    Layers.prototype.refresh = function() {
      var _this = this;
      return this.getCollection().forEach(function(feature) {
        var layer, _ref;
        layer = _this.getLayer((_ref = _this._getFromCache(feature)) != null ? _ref[0] : void 0);
        return _this._updateFeatureStyle(feature, layer);
      });
    };

    Layers.prototype.loadLayer = function(data) {
      var layer;
      layer = new Layer(_.extend({
        collection: this.getCollection(),
        map: this.map
      }, data));
      this.addLayer(layer);
      return layer;
    };

    Layers.prototype.loadLayers = function(data) {
      var layers,
        _this = this;
      layers = [];
      data.forEach(function(l) {
        return layers.push(_this.loadLayer(l));
      });
      return layers;
    };

    Layers.prototype.setMap = function(map) {
      var _this = this;
      this.map = map;
      if (!this.map) {
        return;
      }
      this.reset();
      this.handleMapEvents();
      this.forEach(function(layer) {
        return layer.setMap(_this.map);
      });
      if (!(this.collection != null)) {
        return this.setCollection(this.map.getFeatures());
      }
    };

    Layers.prototype.handleMapEvents = function() {
      var _this = this;
      return this.map.subscribe('feature_added', function(feature) {
        var matched;
        matched = false;
        return _this.forEach(function(layer) {
          if (layer.match(feature)) {
            _this._addToCache(feature, layer);
            if (!matched) {
              _this._updateFeatureStyle(feature, layer);
            }
            return matched = true;
          }
        });
      });
    };

    Layers.prototype.reset = function() {
      this._resetCache();
      return this.forEach(function(layer) {
        return layer.reset();
      });
    };

    Layers.prototype._resetCache = function() {
      return this.cache = {};
    };

    Layers.prototype._addToCache = function(feature, layer) {
      var _base, _name, _ref;
      if ((_ref = (_base = this.cache)[_name = feature.uid]) == null) {
        _base[_name] = [];
      }
      return this.cache[feature.uid].push(layer.getId());
    };

    Layers.prototype._getFromCache = function(feature) {
      var layers, _ref,
        _this = this;
      layers = this.cache[feature.uid];
      if (!layers) {
        this.forEach(function(layer) {
          if (layer.match(feature)) {
            return _this._addToCache(feature, layer);
          }
        });
      }
      return (_ref = this.cache[feature.uid]) != null ? _ref : [];
    };

    Layers.prototype.toJSON = function() {
      var layers;
      layers = [];
      this.forEach(function(layer) {
        if (layer.getId() === 'Others') {
          return;
        }
        return layers.push(layer.toJSON());
      });
      return layers;
    };

    Layers.prototype._updateFeatureStyle = function(feature, layer) {
      return layer._updateFeatureStyle(feature);
    };

    return Layers;

  })(collections.GenericCollection);
  Layer = (function() {

    function Layer(options) {
      var _ref, _ref1, _ref2, _ref3, _ref4, _ref5, _ref6, _ref7, _ref8;
      this.options = options != null ? options : {};
      this.cache = new collections.FeatureCollection();
      this.visible = (_ref = this.options.visible) != null ? _ref : true;
      this.icon = (_ref1 = (_ref2 = this.options.icon) != null ? _ref2[0] : void 0) != null ? _ref1 : '';
      this.iconOff = (_ref3 = (_ref4 = this.options.icon) != null ? _ref4[1] : void 0) != null ? _ref3 : '';
      this.fillColor = (_ref5 = this.options.fillColor) != null ? _ref5 : '#c0c0c0';
      this.strokeColor = (_ref6 = this.options.strokeColor) != null ? _ref6 : this.fillColor;
      this.id = '' + ((_ref7 = this.options.id) != null ? _ref7 : this.options.name);
      this.important = (_ref8 = this.options.important) != null ? _ref8 : false;
      this.setPosition(this.options.position);
      this.setName(this.options.name);
      this.setRule(this.options.rule);
      this.setCollection(this.options.collection);
      this.setMap(this.options.map);
    }

    Layer.prototype.getPosition = function() {
      return this.position;
    };

    Layer.prototype.setPosition = function(position) {
      this.position = position;
      return this;
    };

    Layer.prototype.getId = function() {
      return this.id;
    };

    Layer.prototype.getName = function() {
      return this.name;
    };

    Layer.prototype.setName = function(name) {
      this.name = name;
      return this;
    };

    Layer.prototype.getFillColor = function() {
      return this.fillColor;
    };

    Layer.prototype.setFillColor = function(fillColor) {
      this.fillColor = fillColor;
      return this;
    };

    Layer.prototype.getStrokeColor = function() {
      return this.strokeColor;
    };

    Layer.prototype.setStrokeColor = function(strokeColor) {
      this.strokeColor = strokeColor;
      return this;
    };

    Layer.prototype.getCollection = function() {
      return this.collection;
    };

    Layer.prototype.setCollection = function(collection) {
      this.collection = collection;
      this.cache.clear();
      return this;
    };

    Layer.prototype.getLayersCollection = function() {
      return this.layersCollection;
    };

    Layer.prototype.setLayersCollection = function(layersCollection) {
      this.layersCollection = layersCollection;
    };

    Layer.prototype.getRule = function() {
      return this.rule;
    };

    Layer.prototype.setRule = function(rule) {
      this.rule = rule;
      this.cache.clear();
      return this;
    };

    Layer.prototype.getIconUrl = function() {
      return this.icon && static_path + (this.visible ? this.icon : this.iconOff);
    };

    Layer.prototype.setMap = function(map) {
      var _base;
      this.map = map;
      if (!this.map) {
        return;
      }
      this.handleMapEvents();
      if (typeof (_base = this.cache).setMap === "function") {
        _base.setMap(this.map);
      }
      if (!(this.collection != null)) {
        return this.setCollection(this.map.getFeatures());
      }
    };

    Layer.prototype.handleMapEvents = function() {
      var _this = this;
      return this.map.subscribe('feature_added', function(feature) {
        if (!_this.cache.isEmpty() && _this.match(feature)) {
          return _this.cache.push(feature);
        }
      });
    };

    Layer.prototype.isVisible = function() {
      return this.visible;
    };

    Layer.prototype.isImportant = function() {
      return this.important;
    };

    Layer.prototype.show = function() {
      this.getFeatures().show();
      return this.visible = true;
    };

    Layer.prototype.hide = function() {
      this.getFeatures().hide();
      return this.visible = false;
    };

    Layer.prototype.toggle = function() {
      if (!this.visible) {
        this.show();
      } else {
        this.hide();
      }
      return this.visible;
    };

    Layer.prototype.match = function(feature) {
      return eval_expr(this.rule, feature);
    };

    Layer.prototype.getFeatures = function() {
      if (this.cache.isEmpty()) {
        this.updateCache();
      }
      return this.cache;
    };

    Layer.prototype.countFeatures = function() {
      return this.getFeatures().length;
    };

    Layer.prototype.reset = function() {
      return this.cache.clear();
    };

    Layer.prototype.updateCache = function() {
      var filtered,
        _this = this;
      this.cache.clear();
      filtered = this.collection.filter(this.match, this);
      filtered.forEach(function(feature) {
        return _this.cache.push(feature);
      });
      return this;
    };

    Layer.prototype.toJSON = function() {
      return {
        "id": this.getId(),
        "name": this.getName(),
        "rule": this.getRule(),
        "position": this.getPosition(),
        "fillColor": this.getFillColor(),
        "strokeColor": this.getStrokeColor()
      };
    };

    Layer.prototype._updateFeatureStyle = function(feature) {
      feature.setBorderColor(this.getStrokeColor());
      feature.setBackgroundColor(this.getFillColor());
      return feature.refresh();
    };

    return Layer;

  })();
  layers = {
    Layers: Layers,
    Layer: Layer
  };
  return layers;
});
