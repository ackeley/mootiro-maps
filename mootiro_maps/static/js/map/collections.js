// Generated by CoffeeScript 1.4.0
var __slice = [].slice,
  __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; },
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

define(function(require) {
  'use strict';

  var FeatureCollection, FeatureCollectionPlus, GenericCollection, googleMaps, _base, _ref, _ref1;
  googleMaps = require('googlemaps');
  if ((_ref = window.komoo) == null) {
    window.komoo = {};
  }
  if ((_ref1 = (_base = window.komoo).event) == null) {
    _base.event = googleMaps.event;
  }
  GenericCollection = (function() {

    function GenericCollection(options) {
      this.options = options != null ? options : {};
      this.elements = [];
      this.length = 0;
    }

    GenericCollection.prototype.updateLength = function() {
      this.length = this.elements.length;
      this.first = this.elements[0];
      return this.last = this.elements[this.length - 1];
    };

    GenericCollection.prototype.clear = function() {
      this.elements = [];
      return this.updateLength();
    };

    GenericCollection.prototype.getAt = function(index) {
      return this.elements[index];
    };

    GenericCollection.prototype.push = function(element) {
      this.elements.push(element);
      return this.updateLength();
    };

    GenericCollection.prototype.pop = function() {
      var element;
      element = this.elements.pop();
      this.updateLength();
      return element;
    };

    GenericCollection.prototype.remove = function() {
      var arg, args, index, output, _i, _len;
      args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
      output = [];
      for (_i = 0, _len = args.length; _i < _len; _i++) {
        arg = args[_i];
        index = this.elements.indexOf(arg);
        if (index !== -1) {
          output.push(this.elements.splice(index, 1));
        }
      }
      if (args.length === 1) {
        output = output[0];
      }
      this.updateLength();
      return output;
    };

    GenericCollection.prototype.isEmpty = function() {
      return this.elements.length === 0;
    };

    GenericCollection.prototype.forEach = function(callback, thisArg) {
      return this.elements.forEach(callback, thisArg);
    };

    GenericCollection.prototype.getArray = function() {
      return this.elements;
    };

    GenericCollection.prototype.slice = function(begin, end) {
      return this.elements.slice(begin, end);
    };

    GenericCollection.prototype.filter = function(match, thisArg) {
      var collection, results;
      results = [];
      if (this.elements.filter != null) {
        if (this.elements.filter != null) {
          results = this.elements.filter(match, thisArg);
        }
      } else {
        this.forEach(function(element) {
          if (match.apply(thisArg, [element])) {
            return results.push(element);
          }
        });
      }
      collection = new this.constructor;
      collection.elements = results;
      collection.updateLength();
      return collection;
    };

    GenericCollection.prototype.contains = function(element) {
      return __indexOf.call(this.elements, element) >= 0;
    };

    return GenericCollection;

  })();
  FeatureCollection = (function(_super) {

    __extends(FeatureCollection, _super);

    function FeatureCollection(options) {
      var _ref2,
        _this = this;
      if (options == null) {
        options = {};
      }
      FeatureCollection.__super__.constructor.call(this, options);
      if (options.map) {
        this.setMap(options.map);
      }
      if ((_ref2 = options.features) != null) {
        _ref2.forEach(function(feature) {
          return _this.push(feature);
        });
      }
    }

    FeatureCollection.prototype.push = function(feature) {
      if (!(feature != null)) {
        return;
      }
      FeatureCollection.__super__.push.call(this, feature);
      return feature.setMap(this.map);
    };

    FeatureCollection.prototype.getBounds = function() {
      var firstFeature, geometry, point,
        _this = this;
      firstFeature = this.getAt(0);
      if (firstFeature && firstFeature.getGeometryType() !== 'Empty') {
        geometry = firstFeature.getGeometry();
        point = geometry.getLatLngFromArray(geometry.getCenter());
        this.bounds = new googleMaps.LatLngBounds(point, point);
        this.forEach(function(feature) {
          var _ref2;
          if (feature.getGeometryType() !== 'Empty') {
            return (_ref2 = _this.bounds) != null ? _ref2.union(feature.getBounds()) : void 0;
          }
        });
      }
      return this.bounds;
    };

    FeatureCollection.prototype.setOutOfBounds = function(flag) {
      return this.forEach(function(feature) {
        return feature.setOutOfBounds(flag);
      });
    };

    FeatureCollection.prototype.setMap = function(map, force) {
      var tmpForce,
        _this = this;
      this.map = map;
      tmpForce = null;
      this.forEach(function(feature) {
        if (force != null) {
          tmpForce = {
            geometry: force != null ? force.geometry : void 0,
            point: force != null ? force.icon : void 0,
            icon: force != null ? force.icon : void 0
          };
        }
        if (feature.getType() === 'Community') {
          if (tmpForce != null) {
            tmpForce['point'] = false;
          }
        }
        return feature != null ? feature.setMap(_this.map, tmpForce) : void 0;
      });
      return this.handleMapEvents();
    };

    FeatureCollection.prototype.show = function() {
      this.setMap(this.map, {
        geometry: true
      });
      return this.setVisible(true);
    };

    FeatureCollection.prototype.hide = function() {
      return this.setVisible(false);
    };

    FeatureCollection.prototype.getGeoJson = function(options) {
      var geojson, _ref2;
      if ((_ref2 = options.geometryCollection) == null) {
        options.geometryCollection = false;
      }
      if (options.geometryCollection) {
        geojson = {
          type: "GeometryCollection",
          geometries: []
        };
        this.forEach(function(feature) {
          return geojson.geometries.push(feature.getGeometryGeoJson());
        });
      } else {
        geojson = {
          type: "FeatureCollection",
          features: []
        };
        this.forEach(function(feature) {
          return geojson.features.push(feature.getGeoJson());
        });
      }
      return geojson;
    };

    FeatureCollection.prototype.removeAllFromMap = function() {
      return this.forEach(function(feature) {
        return feature.removeFromMap();
      });
    };

    FeatureCollection.prototype.setVisible = function(flag) {
      return this.forEach(function(feature) {
        return feature.setVisible(flag);
      });
    };

    FeatureCollection.prototype.updateFeaturesVisibility = function() {
      return this.forEach(function(feature) {
        return feature.seMap(feature.getMap());
      });
    };

    FeatureCollection.prototype.handleMapEvents = function() {
      var _this = this;
      return komoo.event.addListener(this.map, "zoom_changed", function() {});
    };

    FeatureCollection.prototype.filter = function(match, thisArg) {
      var collection;
      collection = FeatureCollection.__super__.filter.call(this, match, thisArg);
      collection.map = this.map;
      return collection;
    };

    return FeatureCollection;

  })(GenericCollection);
  FeatureCollectionPlus = (function(_super) {

    __extends(FeatureCollectionPlus, _super);

    function FeatureCollectionPlus(options) {
      if (options == null) {
        options = {};
      }
      FeatureCollectionPlus.__super__.constructor.call(this, options);
      this.featuresByType = {};
    }

    FeatureCollectionPlus.prototype.push = function(feature) {
      var type, _base1, _base2, _base3, _base4, _base5, _base6, _base7, _ref2, _ref3, _ref4, _ref5, _ref6, _ref7, _ref8, _ref9,
        _this = this;
      FeatureCollectionPlus.__super__.push.call(this, feature);
      type = feature.getType();
      if ((_ref2 = (_base1 = this.featuresByType)[type]) == null) {
        _base1[type] = {};
      }
      if ((_ref3 = (_base2 = this.featuresByType[type])['categories']) == null) {
        _base2['categories'] = {};
      }
      if ((_ref4 = (_base3 = this.featuresByType[type]['categories'])['all']) == null) {
        _base3['all'] = new FeatureCollection({
          map: this.map
        });
      }
      if ((_ref5 = (_base4 = this.featuresByType[type]['categories'])['uncategorized']) == null) {
        _base4['uncategorized'] = new FeatureCollection({
          map: this.map
        });
      }
      if ((_ref6 = feature.getCategories()) != null) {
        _ref6.forEach(function(category) {
          var _base5, _name, _ref7;
          if ((_ref7 = (_base5 = _this.featuresByType[type]['categories'])[_name = category.name]) == null) {
            _base5[_name] = new FeatureCollection({
              map: _this.map
            });
          }
          return _this.featuresByType[type]['categories'][category.name].push(feature);
        });
      }
      if (!(feature.getCategories() != null) || feature.getCategories().length === 0) {
        this.featuresByType[type]['categories']['uncategorized'].push(feature);
      }
      this.featuresByType[type]['categories']['all'].push(feature);
      if ((_ref7 = (_base5 = this.featuresByType[type])['ids']) == null) {
        _base5['ids'] = {};
      }
      this.featuresByType[type]['ids'][feature.getProperty('id')] = feature;
      if ((_ref8 = (_base6 = this.featuresByType)['all']) == null) {
        _base6['all'] = {};
      }
      if ((_ref9 = (_base7 = this.featuresByType['all'])['ids']) == null) {
        _base7['ids'] = {};
      }
      return this.featuresByType['all']['ids'][feature.getProperty('id')] = feature;
    };

    FeatureCollectionPlus.prototype.pop = function() {
      return FeatureCollectionPlus.__super__.pop.call(this);
    };

    FeatureCollectionPlus.prototype.clear = function() {
      this.featuresByType = {};
      return FeatureCollectionPlus.__super__.clear.call(this);
    };

    FeatureCollectionPlus.prototype.getByType = function(type, categories, strict) {
      var features,
        _this = this;
      if (strict == null) {
        strict = false;
      }
      if (!this.featuresByType[type]) {
        return false;
      } else if (!categories) {
        return this.featuresByType[type]['categories']['all'];
      } else if (categories.length === 0) {
        return this.featuresByType[type]['categories']['uncategorized'];
      } else {
        features = new FeatureCollection({
          map: this.map
        });
        categories.forEach(function(category) {
          if (_this.featuresByType[type]['categories'][category]) {
            return _this.featuresByType[type]['categories'][category].forEach(function(feature) {
              if (!strict || !feature.getCategories() || feature.getCategories().length === 1) {
                return features.push(feature);
              }
            });
          }
        });
        return features;
      }
    };

    FeatureCollectionPlus.prototype.getById = function(type, id) {
      var _ref2;
      if (typeof type !== 'string') {
        id = type;
        type = 'all';
      }
      return (_ref2 = this.featuresByType[type]) != null ? _ref2['ids'][id] : void 0;
    };

    FeatureCollectionPlus.prototype.highlightFeature = function(type, id) {
      var feature, _ref2, _ref3;
      feature = (_ref2 = typeof type) === 'string' || _ref2 === 'number' ? this.getById(type, id) : type;
      if (feature.isHighlighted()) {
        return;
      }
      if ((_ref3 = this.highlighted) != null) {
        _ref3.setHighlight(false);
      }
      feature.highlight();
      return this.highlighted = feature;
    };

    return FeatureCollectionPlus;

  })(FeatureCollection);
  window.komoo.collections = {
    GenericCollection: GenericCollection,
    FeatureCollection: FeatureCollection,
    FeatureCollectionPlus: FeatureCollectionPlus,
    makeFeatureCollection: function(options) {
      if (options == null) {
        options = {};
      }
      return new FeatureCollection(options);
    },
    makeFeatureCollectionPlus: function(options) {
      if (options == null) {
        options = {};
      }
      return new FeatureCollectionPlus(options);
    }
  };
  return window.komoo.collections;
});
