{% load i18n %}

<a class="button login-required {% if not filtered %}disabled{% endif %}" id="add-to-project" href="#" title="Adicionar Organizações filtradas a um projeto" {% if not filtered %}disabled{% endif %}>{% trans "Add to Project" %}</a>

<!-- Modal form for adding this object to a project -->
<div class="modal hide" id="add-project-modal" style="display:none;">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">×</button>
        <div class="add-project-modal-header">
            {% trans 'Add this list to a project' %}
        </div>
    </div>
    <div class="modal-body">
        <p>
        <div class="project-selector">
            {{ project_widget|safe }}

            <input type="hidden" id="add_to_project__filter_params" value='{{ params }}'>
            <input type="hidden" id="add_to_project__object_type" value='{{ type }}'>
        </div>
        </p>
        <div class="add-project-msg">
        </div>
    </div>
    <div class="modal-footer">
        <a href="#" class="btn" id="add-project-cancel" >
            {% trans 'Cancel' %}
        </a>
        <a href="#" class="button" id="add-project-save">
            {% trans "Save changes" %}
        </a>
    </div>
</div>

<script type="text/javascript" charset="utf-8">
    $('#add-to-project').click(function(evt){
        var el = $(evt.target);
        if (isAuthenticated && !el.is('.disabled')){
          $('#add-project-modal').modal('show');
        }
        return false;
    });
    $( "#id_project_autocomplete" ).bind( "autocompleteselect", function(event, ui) {
        $('.add-project-msg').html(
            '<p>' +
                'Esta lista será adicionada ao projeto <strong>' +
                ui.item.label + '</strong>' +
            '</p>'
        );
    });
    var cleanAddToProjectFields = function() {
        $('#id_project_autocomplete').val('');
        $('#id_project').val('');
        $('.add-project-msg').html('');
        $('#add-project-modal').modal('hide');
    };
    $('#add-project-save').click(function(){
        //save proj related object
        var project_id = $('#id_project').val();
        $.post(
            '/project/add_list/',
            {
                filter_params: $('#add_to_project__filter_params').val(),
                object_type: $('#add_to_project__object_type').val(),
                project_id: project_id
            },
            function(data){
                if (data.success) {
                    // redirect to project page
                    window.location.href = data.redirect_url;
                } else {
                    alert('Falha ao relacionar este objeto ao projeto selecionado');
                }
            },
            'json'
        );
        $('#id_project_autocomplete').val('');
        $('#id_project').val('');
        $('.add-project-msg').html('');
        $('#add-project-modal').modal('hide');
    });
    $('#add-project-cancel').click(function(evt){
        evt.preventDefault();
        cleanAddToProjectFields();
        return false;
    });
</script>
